import { deepMerge, isObject } from '../../config/utils/deep-merge';
/**
 * Merge occ fields parameters
 *
 * @param fields Fields definition as string or object
 */
export function mergeFields(fields) {
    const parsedFields = fields.map((f) => typeof f === 'string' ? parseFields(f) : f);
    const mergedFields = optimizeFields(deepMerge({}, ...parsedFields));
    return stringifyFields(mergedFields);
}
/**
 * Optimize fields definition by removing not needed groups
 *
 * @param fields
 */
export function optimizeFields(fields = {}) {
    const keys = Object.keys(fields);
    if (keys.includes('FULL')) {
        delete fields['DEFAULT'];
        delete fields['BASIC'];
    }
    else if (keys.includes('DEFAULT')) {
        delete fields['BASIC'];
    }
    Object.keys(fields).forEach((key) => {
        fields[key] = optimizeFields(fields[key]);
    });
    return fields;
}
/**
 * Parse string field definition to an AST object
 *
 * @param fields Fields string definition
 * @param startIndex Used for recurrence
 */
export function parseFields(fields, startIndex = 0) {
    const parsedFields = {};
    let i = startIndex;
    while (i < fields.length) {
        if (fields[i] === ',') {
            if (i > startIndex) {
                parsedFields[fields.substr(startIndex, i - startIndex)] = {};
            }
            startIndex = i + 1;
        }
        else if (fields[i] === '(') {
            const subFields = parseFields(fields, i + 1);
            if (Array.isArray(subFields)) {
                parsedFields[fields.substr(startIndex, i - startIndex)] = subFields[0];
                startIndex = subFields[1];
                i = startIndex - 1;
            }
            else {
                return parsedFields;
            }
        }
        else if (fields[i] === ')') {
            if (i > startIndex) {
                parsedFields[fields.substr(startIndex, i - startIndex)] = {};
            }
            return [parsedFields, i + 1];
        }
        i++;
    }
    if (startIndex < fields.length) {
        parsedFields[fields.substr(startIndex, i - startIndex)] = {};
    }
    return parsedFields;
}
/**
 * Convert AST object fields definition to string representation
 *
 * @param fields
 */
export function stringifyFields(fields) {
    return Object.keys(fields)
        .map((key) => {
        const subFields = stringifyFields(fields[key]);
        return subFields ? `${key}(${subFields})` : key;
    })
        .join(',');
}
/**
 * Extract part of the object described by fields definition
 *
 * @param data
 * @param fields
 */
export function extractFields(data, fields) {
    const parsedFields = typeof fields === 'string' ? parseFields(fields) : fields;
    return getObjectPart(data, parsedFields);
}
function getObjectPart(data, fields) {
    if (!isObject(data)) {
        return data;
    }
    const keys = Object.keys(fields);
    if (keys.length === 0 ||
        // we should not extract parts of the object with ambiguous fields definitions
        keys.find((el) => el === 'BASIC' || el === 'DEFAULT' || el === 'FULL')) {
        return data;
    }
    const result = {};
    keys.forEach((key) => {
        if (data.hasOwnProperty(key)) {
            result[key] = getObjectPart(data[key], fields[key]);
        }
    });
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2NjLWZpZWxkcy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BzcGFydGFjdXMvY29yZS8iLCJzb3VyY2VzIjpbInNyYy9vY2MvdXRpbHMvb2NjLWZpZWxkcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBRXBFOzs7O0dBSUc7QUFDSCxNQUFNLFVBQVUsV0FBVyxDQUFDLE1BQTJCO0lBQ3JELE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUNwQyxPQUFPLENBQUMsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUMzQyxDQUFDO0lBQ0YsTUFBTSxZQUFZLEdBQUcsY0FBYyxDQUFDLFNBQVMsQ0FBQyxFQUFFLEVBQUUsR0FBRyxZQUFZLENBQUMsQ0FBQyxDQUFDO0lBQ3BFLE9BQU8sZUFBZSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3ZDLENBQUM7QUFFRDs7OztHQUlHO0FBQ0gsTUFBTSxVQUFVLGNBQWMsQ0FBQyxTQUFpQixFQUFFO0lBQ2hELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDakMsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQ3pCLE9BQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3pCLE9BQU8sTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQ3hCO1NBQU0sSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxFQUFFO1FBQ25DLE9BQU8sTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQ3hCO0lBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtRQUNs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WSxDQUFDLENBQUM7QUFDOUMsQ0FBQztBQUVELFNBQVMsYUFBYSxDQUFJLElBQU8sRUFBRSxNQUFjO0lBQy9DLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDbkIsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUVELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFFakMsSUFDRSxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUM7UUFDakIsOEVBQThFO1FBQzlFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsS0FBSyxPQUFPLElBQUksRUFBRSxLQUFLLFNBQVMsSUFBSSxFQUFFLEtBQUssTUFBTSxDQUFDLEVBQ3RFO1FBQ0EsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUVELE1BQU0sTUFBTSxHQUFHLEVBQU8sQ0FBQztJQUV2QixJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7UUFDbkIsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQzVCLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQ3JEO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGVlcE1lcmdlLCBpc09iamVjdCB9IGZyb20gJy4uLy4uL2NvbmZpZy91dGlscy9kZWVwLW1lcmdlJztcclxuXHJcbi8qKlxyXG4gKiBNZXJnZSBvY2MgZmllbGRzIHBhcmFtZXRlcnNcclxuICpcclxuICogQHBhcmFtIGZpZWxkcyBGaWVsZHMgZGVmaW5pdGlvbiBhcyBzdHJpbmcgb3Igb2JqZWN0XHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gbWVyZ2VGaWVsZHMoZmllbGRzOiAoc3RyaW5nIHwgb2JqZWN0KVtdKTogc3RyaW5nIHtcclxuICBjb25zdCBwYXJzZWRGaWVsZHMgPSBmaWVsZHMubWFwKChmKSA9PlxyXG4gICAgdHlwZW9mIGYgPT09ICdzdHJpbmcnID8gcGFyc2VGaWVsZHMoZikgOiBmXHJcbiAgKTtcclxuICBjb25zdCBtZXJnZWRGaWVsZHMgPSBvcHRpbWl6ZUZpZWxkcyhkZWVwTWVyZ2Uoe30sIC4uLnBhcnNlZEZpZWxkcykpO1xyXG4gIHJldHVybiBzdHJpbmdpZnlGaWVsZHMobWVyZ2VkRmllbGRzKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIE9wdGltaXplIGZpZWxkcyBkZWZpbml0aW9uIGJ5IHJlbW92aW5nIG5vdCBuZWVkZWQgZ3JvdXBzXHJcbiAqXHJcbiAqIEBwYXJhbSBmaWVsZHNcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBvcHRpbWl6ZUZpZWxkcyhmaWVsZHM6IG9iamVjdCA9IHt9KTogb2JqZWN0IHtcclxuICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZmllbGRzKTtcclxuICBpZiAoa2V5cy5pbmNsdWRlcygnRlVMTCcpKSB7XHJcbiAgICBkZWxldGUgZmllbGRzWydERUZBVUxUJ107XHJcbiAgICBkZWxldGUgZmllbGRzWydCQVNJQyddO1xyXG4gIH0gZWxzZSBpZiAoa2V5cy5pbmNsdWRlcygnREVGQVVMVCcpKSB7XHJcbiAgICBkZWxldGUgZmllbGRzWydCQVNJQyddO1xyXG4gIH1cclxuICBPYmplY3Qua2V5cyhmaWVsZHMpLmZvckVhY2goKGtleSkgPT4ge1xyXG4gICAgZmllbGRzW2tleV0gPSBvcHRpbWl6ZUZpZWxkcyhmaWVsZHNba2V5XSk7XHJcbiAgfSk7XHJcbiAgcmV0dXJuIGZpZWxkcztcclxufVxyXG5cclxuLyoqXHJcbiAqIFBhcnNlIHN0cmluZyBmaWVsZCBkZWZpbml0aW9uIHRvIGFuIEFTVCBvYmplY3RcclxuICpcclxuICogQHBhcmFtIGZpZWxkcyBGaWVsZHMgc3RyaW5nIGRlZmluaXRpb25cclxuICogQHBhcmFtIHN0YXJ0SW5kZXggVXNlZCBmb3IgcmVjdXJyZW5jZVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlRmllbGRzKFxyXG4gIGZpZWxkczogc3RyaW5nLFxyXG4gIHN0YXJ0SW5kZXggPSAwXHJcbik6IFtvYmplY3QsIG51bWJlcl0gfCBvYmplY3Qge1xyXG4gIGNvbnN0IHBhcnNlZEZpZWxkcyA9IHt9O1xyXG5cclxuICBsZXQgaSA9IHN0YXJ0SW5kZXg7XHJcbiAgd2hpbGUgKGkgPCBmaWVsZHMubGVuZ3RoKSB7XHJcbiAgICBpZiAoZmllbGRzW2ldID09PSAnLCcpIHtcclxuICAgICAgaWYgKGkgPiBzdGFydEluZGV4KSB7XHJcbiAgICAgICAgcGFyc2VkRmllbGRzW2ZpZWxkcy5zdWJzdHIoc3RhcnRJbmRleCwgaSAtIHN0YXJ0SW5kZXgpXSA9IHt9O1xyXG4gICAgICB9XHJcbiAgICAgIHN0YXJ0SW5kZXggPSBpICsgMTtcclxuICAgIH0gZWxzZSBpZiAoZmllbGRzW2ldID09PSAnKCcpIHtcclxuICAgICAgY29uc3Qgc3ViRmllbGRzID0gcGFyc2VGaWVsZHMoZmllbGRzLCBpICsgMSk7XHJcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KHN1YkZpZWxkcykpIHtcclxuICAgICAgICBwYXJzZWRGaWVsZHNbZmllbGRzLnN1YnN0cihzdGFydEluZGV4LCBpIC0gc3RhcnRJbmRleCldID0gc3ViRmllbGRzWzBdO1xyXG4gICAgICAgIHN0YXJ0SW5kZXggPSBzdWJGaWVsZHNbMV07XHJcbiAgICAgICAgaSA9IHN0YXJ0SW5kZXggLSAxO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBwYXJzZWRGaWVsZHM7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAoZmllbGRzW2ldID09PSAnKScpIHtcclxuICAgICAgaWYgKGkgPiBzdGFydEluZGV4KSB7XHJcbiAgICAgICAgcGFyc2VkRmllbGRzW2ZpZWxkcy5zdWJzdHIoc3RhcnRJbmRleCwgaSAtIHN0YXJ0SW5kZXgpXSA9IHt9O1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBbcGFyc2VkRmllbGRzLCBpICsgMV07XHJcbiAgICB9XHJcbiAgICBpKys7XHJcbiAgfVxyXG5cclxuICBpZiAoc3RhcnRJbmRleCA8IGZpZWxkcy5sZW5ndGgpIHtcclxuICAgIHBhcnNlZEZpZWxkc1tmaWVsZHMuc3Vic3RyKHN0YXJ0SW5kZXgsIGkgLSBzdGFydEluZGV4KV0gPSB7fTtcclxuICB9XHJcblxyXG4gIHJldHVybiBwYXJzZWRGaWVsZHM7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDb252ZXJ0IEFTVCBvYmplY3QgZmllbGRzIGRlZmluaXRpb24gdG8gc3RyaW5nIHJlcHJlc2VudGF0aW9uXHJcbiAqXHJcbiAqIEBwYXJhbSBmaWVsZHNcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBzdHJpbmdpZnlGaWVsZHMoZmllbGRzOiBvYmplY3QpOiBzdHJpbmcge1xyXG4gIHJldHVybiBPYmplY3Qua2V5cyhmaWVsZHMpXHJcbiAgICAubWFwKChrZXkpID0+IHtcclxuICAgICAgY29uc3Qgc3ViRmllbGRzID0gc3RyaW5naWZ5RmllbGRzKGZpZWxkc1trZXldKTtcclxuICAgICAgcmV0dXJuIHN1YkZpZWxkcyA/IGAke2tleX0oJHtzdWJGaWVsZHN9KWAgOiBrZXk7XHJcbiAgICB9KVxyXG4gICAgLmpvaW4oJywnKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEV4dHJhY3QgcGFydCBvZiB0aGUgb2JqZWN0IGRlc2NyaWJlZCBieSBmaWVsZHMgZGVmaW5pdGlvblxyXG4gKlxyXG4gKiBAcGFyYW0gZGF0YVxyXG4gKiBAcGFyYW0gZmllbGRzXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZXh0cmFjdEZpZWxkczxUPihkYXRhOiBULCBmaWVsZHM6IHN0cmluZyB8IG9iamVjdCk6IFQge1xyXG4gIGNvbnN0IHBhcnNlZEZpZWxkcyA9XHJcbiAgICB0eXBlb2YgZmllbGRzID09PSAnc3RyaW5nJyA/IHBhcnNlRmllbGRzKGZpZWxkcykgOiBmaWVsZHM7XHJcbiAgcmV0dXJuIGdldE9iamVjdFBhcnQ8VD4oZGF0YSwgcGFyc2VkRmllbGRzKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0T2JqZWN0UGFydDxUPihkYXRhOiBULCBmaWVsZHM6IG9iamVjdCk6IFQge1xyXG4gIGlmICghaXNPYmplY3QoZGF0YSkpIHtcclxuICAgIHJldHVybiBkYXRhO1xyXG4gIH1cclxuXHJcbiAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGZpZWxkcyk7XHJcblxyXG4gIGlmIChcclxuICAgIGtleXMubGVuZ3RoID09PSAwIHx8XHJcbiAgICAvLyB3ZSBzaG91bGQgbm90IGV4dHJhY3QgcGFydHMgb2YgdGhlIG9iamVjdCB3aXRoIGFtYmlndW91cyBmaWVsZHMgZGVmaW5pdGlvbnNcclxuICAgIGtleXMuZmluZCgoZWwpID0+IGVsID09PSAnQkFTSUMnIHx8IGVsID09PSAnREVGQVVMVCcgfHwgZWwgPT09ICdGVUxMJylcclxuICApIHtcclxuICAgIHJldHVybiBkYXRhO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgcmVzdWx0ID0ge30gYXMgVDtcclxuXHJcbiAga2V5cy5mb3JFYWNoKChrZXkpID0+IHtcclxuICAgIGlmIChkYXRhLmhhc093blByb3BlcnR5KGtleSkpIHtcclxuICAgICAgcmVzdWx0W2tleV0gPSBnZXRPYmplY3RQYXJ0KGRhdGFba2V5XSwgZmllbGRzW2tleV0pO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICByZXR1cm4gcmVzdWx0O1xyXG59XHJcbiJdfQ==
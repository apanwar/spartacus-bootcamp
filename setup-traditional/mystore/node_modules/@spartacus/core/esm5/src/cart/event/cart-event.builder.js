import { __decorate, __read, __spread } from "tslib";
import { Injectable } from '@angular/core';
import { ofType } from '@ngrx/effects';
import { ActionsSubject } from '@ngrx/store';
import { filter, map, withLatestFrom } from 'rxjs/operators';
import { EventService } from '../../event/event.service';
import { createFrom } from '../../util/create-from';
import { ActiveCartService } from '../facade/active-cart.service';
import { CartActions } from '../store';
import { CartAddEntryEvent, CartAddEntryFailEvent, CartAddEntrySuccessEvent, } from './cart.events';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/store";
import * as i2 from "../../event/event.service";
import * as i3 from "../facade/active-cart.service";
/**
 * Registers events for the active cart
 */
var CartEventBuilder = /** @class */ (function () {
    function CartEventBuilder(actionsSubject, event, activeCartService) {
        this.actionsSubject = actionsSubject;
        this.event = event;
        this.activeCartService = activeCartService;
        this.register();
    }
    /**
     * Registers events for the active cart
     */
    CartEventBuilder.prototype.register = function () {
        this.registerAddEntry();
    };
    /**
     * Register events for adding entry to the active cart
     */
    CartEventBuilder.prototype.registerAddEntry = function () {
        this.registerMapped({
            action: CartActions.CART_ADD_ENTRY,
            event: CartAddEntryEvent,
        });
        this.registerMapped({
            action: CartActions.CART_ADD_ENTRY_SUCCESS,
            event: CartAddEntrySuccessEvent,
        });
        this.registerMapped({
            action: CartActions.CART_ADD_ENTRY_FAIL,
            event: CartAddEntryFailEvent,
        });
    };
    /**
     * Registers a stream of target events mapped from the source actions that contain the cart id equal to the active cart id.
     *
     * @param mapping mapping declaration - from `action` string type to `event` class type
     *   (an with optional `factory` function - by default `action.payload` will be assigned to the properties of the event instance).
     */
    CartEventBuilder.prototype.registerMapped = function (mapping) {
        var eventStream$ = this.getAction(mapping.action).pipe(withLatestFrom(this.activeCartService.getActiveCartId()), filter(function (_a) {
            var _b = __read(_a, 2), action = _b[0], activeCartId = _b[1];
            return action.payload['cartId'] === activeCartId;
        } // assuming that action's payload contains the cart id
        ), map(function (_a) {
            var _b = __read(_a, 1), action = _b[0];
            return createFrom(mapping.event, action.payload);
        }));
        return this.event.register(mapping.event, eventStream$);
    };
    /**
     * Returns a stream of actions only of a given type(s)
     *
     * @param actionType type(s) of actions
     */
    CartEventBuilder.prototype.getAction = function (actionType) {
        return this.actionsSubject.pipe(ofType.apply(void 0, __spread([].concat(actionType))));
    };
    CartEventBuilder.ctorParameters = function () { return [
        { type: ActionsSubject },
        { type: EventService },
        { type: ActiveCartService }
    ]; };
    CartEventBuilder.ɵprov = i0.ɵɵdefineInjectable({ factory: function CartEventBuilder_Factory() { return new CartEventBuilder(i0.ɵɵinject(i1.ActionsSubject), i0.ɵɵinject(i2.EventService), i0.ɵɵinject(i3.ActiveCartService)); }, token: CartEventBuilder, providedIn: "root" });
    CartEventBuilder = __decorate([
        Injectable({ providedIn: 'root' })
    ], CartEventBuilder);
    return CartEventBuilder;
}());
export { CartEventBuilder };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FydC1ldmVudC5idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHNwYXJ0YWN1cy9jb3JlLyIsInNvdXJjZXMiOlsic3JjL2NhcnQvZXZlbnQvY2FydC1ldmVudC5idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUU3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFekQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3BELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDdkMsT0FBTyxFQUNMLGlCQUFpQixFQUNqQixxQkFBcUIsRUFDckIsd0JBQXdCLEdBQ3pCLE1BQU0sZUFBZSxDQUFDOzs7OztBQUV2Qjs7R0FFRztBQUVIO0lBQ0UsMEJBQ1ksY0FBOEIsRUFDOUIsS0FBbUIsRUFDbkIsaUJBQW9DO1FBRnBDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixVQUFLLEdBQUwsS0FBSyxDQUFjO1FBQ25CLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFFOUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ2xCLENBQUM7SUFFRDs7T0FFRztJQUNPLG1DQUFRLEdBQWxCO1FBQ0UsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVEOztPQUVHO0lBQ08sMkNBQWdCLEdBQTFCO1FBQ0UsSUFBSSxDQUFDLGNBQWMsQ0FBQztZQUNsQixNQUFNLEVBQUUsV0FBVyxDQUFDLGNBQWM7WUFDbEMsS0FBSyxFQUFFLGlCQUFpQjtTQUN6QixDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsY0FBYyxDQUFDO1lBQ2xCLE1BQU0sRUFBRSxXQUFXLENBQUMsc0JBQXNCO1lBQzFDLEtBQUssRUFBRSx3QkFBd0I7U0FDaEMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLGNBQWMsQ0FBQztZQUNsQixNQUFNLEVBQUUsV0FBVyxDQUFDLG1CQUFtQjtZQUN2QyxLQUFLLEVBQUUscUJBQXFCO1NBQzdCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNPLHlDQUFjLEdBQXhCLFVBQTRCLE9BQWdDO1FBQzFELElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FDdEQsY0FBYyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxFQUN4RCxNQUFNLENBQ0osVUFBQyxFQUFzQjtnQkFBdEIsa0JBQXNCLEVBQXJCLGNBQU0sRUFBRSxvQkFBWTtZQUFNLE9BQUEsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsS0FBSyxZQUFZO1FBQXpDLENBQXlDLENBQUMsc0RBQXNEO1NBQzdILEVBQ0QsR0FBRyxDQUFDLFVBQUMsRUFBUTtnQkFBUixrQkFBUSxFQUFQLGNBQU07WUFBTSxPQUFBLFVBQVUsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUM7UUFBekMsQ0FBeUMsQ0FBQyxDQUM3RCxDQUFDO1FBRUYsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFFRDs7OztPQUlHO0lBQ08sb0NBQVMsR0FBbkIsVUFDRSxVQUE2QjtRQUU3QixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sd0JBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRSxDQUFDO0lBQ3BFLENBQUM7O2dCQTNEMkIsY0FBYztnQkFDdkIsWUFBWTtnQkFDQSxpQkFBaUI7OztJQUpyQyxnQkFBZ0I7UUFENUIsVUFBVSxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxDQUFDO09BQ3RCLGdCQUFnQixDQThENUI7MkJBbEZEO0NBa0ZDLEFBOURELElBOERDO1NBOURZLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgb2ZUeXBlIH0gZnJvbSAnQG5ncngvZWZmZWN0cyc7XHJcbmltcG9ydCB7IEFjdGlvbnNTdWJqZWN0IH0gZnJvbSAnQG5ncngvc3RvcmUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGZpbHRlciwgbWFwLCB3aXRoTGF0ZXN0RnJvbSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgRXZlbnRTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vZXZlbnQvZXZlbnQuc2VydmljZSc7XHJcbmltcG9ydCB7IEFjdGlvblRvRXZlbnRNYXBwaW5nIH0gZnJvbSAnLi4vLi4vc3RhdGUvZXZlbnQvYWN0aW9uLXRvLWV2ZW50LW1hcHBpbmcnO1xyXG5pbXBvcnQgeyBjcmVhdGVGcm9tIH0gZnJvbSAnLi4vLi4vdXRpbC9jcmVhdGUtZnJvbSc7XHJcbmltcG9ydCB7IEFjdGl2ZUNhcnRTZXJ2aWNlIH0gZnJvbSAnLi4vZmFjYWRlL2FjdGl2ZS1jYXJ0LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBDYXJ0QWN0aW9ucyB9IGZyb20gJy4uL3N0b3JlJztcclxuaW1wb3J0IHtcclxuICBDYXJ0QWRkRW50cnlFdmVudCxcclxuICBDYXJ0QWRkRW50cnlGYWlsRXZlbnQsXHJcbiAgQ2FydEFkZEVudHJ5U3VjY2Vzc0V2ZW50LFxyXG59IGZyb20gJy4vY2FydC5ldmVudHMnO1xyXG5cclxuLyoqXHJcbiAqIFJlZ2lzdGVycyBldmVudHMgZm9yIHRoZSBhY3RpdmUgY2FydFxyXG4gKi9cclxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcclxuZXhwb3J0IGNsYXNzIENhcnRFdmVudEJ1aWxkZXIge1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJvdGVjdGVkIGFjdGlvbnNTdWJqZWN0OiBBY3Rpb25zU3ViamVjdCxcclxuICAgIHByb3RlY3RlZCBldmVudDogRXZlbnRTZXJ2aWNlLFxyXG4gICAgcHJvdGVjdGVkIGFjdGl2ZUNhcnRTZXJ2aWNlOiBBY3RpdmVDYXJ0U2VydmljZVxyXG4gICkge1xyXG4gICAgdGhpcy5yZWdpc3RlcigpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVnaXN0ZXJzIGV2ZW50cyBmb3IgdGhlIGFjdGl2ZSBjYXJ0XHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHJlZ2lzdGVyKCkge1xyXG4gICAgdGhpcy5yZWdpc3RlckFkZEVudHJ5KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZWdpc3RlciBldmVudHMgZm9yIGFkZGluZyBlbnRyeSB0byB0aGUgYWN0aXZlIGNhcnRcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgcmVnaXN0ZXJBZGRFbnRyeSgpIHtcclxuICAgIHRoaXMucmVnaXN0ZXJNYXBwZWQoe1xyXG4gICAgICBhY3Rpb246IENhcnRBY3Rpb25zLkNBUlRfQUREX0VOVFJZLFxyXG4gICAgICBldmVudDogQ2FydEFkZEVudHJ5RXZlbnQsXHJcbiAgICB9KTtcclxuICAgIHRoaXMucmVnaXN0ZXJNYXBwZWQoe1xyXG4gICAgICBhY3Rpb246IENhcnRBY3Rpb25zLkNBUlRfQUREX0VOVFJZX1NVQ0NFU1MsXHJcbiAgICAgIGV2ZW50OiBDYXJ0QWRkRW50cnlTdWNjZXNzRXZlbnQsXHJcbiAgICB9KTtcclxuICAgIHRoaXMucmVnaXN0ZXJNYXBwZWQoe1xyXG4gICAgICBhY3Rpb246IENhcnRBY3Rpb25zLkNBUlRfQUREX0VOVFJZX0ZBSUwsXHJcbiAgICAgIGV2ZW50OiBDYXJ0QWRkRW50cnlGYWlsRXZlbnQsXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlZ2lzdGVycyBhIHN0cmVhbSBvZiB0YXJnZXQgZXZlbnRzIG1hcHBlZCBmcm9tIHRoZSBzb3VyY2UgYWN0aW9ucyB0aGF0IGNvbnRhaW4gdGhlIGNhcnQgaWQgZXF1YWwgdG8gdGhlIGFjdGl2ZSBjYXJ0IGlkLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIG1hcHBpbmcgbWFwcGluZyBkZWNsYXJhdGlvbiAtIGZyb20gYGFjdGlvbmAgc3RyaW5nIHR5cGUgdG8gYGV2ZW50YCBjbGFzcyB0eXBlXHJcbiAgICogICAoYW4gd2l0aCBvcHRpb25hbCBgZmFjdG9yeWAgZnVuY3Rpb24gLSBieSBkZWZhdWx0IGBhY3Rpb24ucGF5bG9hZGAgd2lsbCBiZSBhc3NpZ25lZCB0byB0aGUgcHJvcGVydGllcyBvZiB0aGUgZXZlbnQgaW5zdGFuY2UpLlxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCByZWdpc3Rlck1hcHBlZDxUPihtYXBwaW5nOiBBY3Rpb25Ub0V2ZW50TWFwcGluZzxUPik6ICgpID0+IHZvaWQge1xyXG4gICAgY29uc3QgZXZlbnRTdHJlYW0kID0gdGhpcy5nZXRBY3Rpb24obWFwcGluZy5hY3Rpb24pLnBpcGUoXHJcbiAgICAgIHdpdGhMYXRlc3RGcm9tKHRoaXMuYWN0aXZlQ2FydFNlcnZpY2UuZ2V0QWN0aXZlQ2FydElkKCkpLFxyXG4gICAgICBmaWx0ZXIoXHJcbiAgICAgICAgKFthY3Rpb24sIGFjdGl2ZUNhcnRJZF0pID0+IGFjdGlvbi5wYXlsb2FkWydjYXJ0SWQnXSA9PT0gYWN0aXZlQ2FydElkIC8vIGFzc3VtaW5nIHRoYXQgYWN0aW9uJ3MgcGF5bG9hZCBjb250YWlucyB0aGUgY2FydCBpZFxyXG4gICAgICApLFxyXG4gICAgICBtYXAoKFthY3Rpb25dKSA9PiBjcmVhdGVGcm9tKG1hcHBpbmcuZXZlbnQsIGFjdGlvbi5wYXlsb2FkKSlcclxuICAgICk7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuZXZlbnQucmVnaXN0ZXIobWFwcGluZy5ldmVudCwgZXZlbnRTdHJlYW0kKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgYSBzdHJlYW0gb2YgYWN0aW9ucyBvbmx5IG9mIGEgZ2l2ZW4gdHlwZShzKVxyXG4gICAqXHJcbiAgICogQHBhcmFtIGFjdGlvblR5cGUgdHlwZShzKSBvZiBhY3Rpb25zXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGdldEFjdGlvbihcclxuICAgIGFjdGlvblR5cGU6IHN0cmluZyB8IHN0cmluZ1tdXHJcbiAgKTogT2JzZXJ2YWJsZTx7IHR5cGU6IHN0cmluZzsgcGF5bG9hZD86IGFueSB9PiB7XHJcbiAgICByZXR1cm4gdGhpcy5hY3Rpb25zU3ViamVjdC5waXBlKG9mVHlwZSguLi5bXS5jb25jYXQoYWN0aW9uVHlwZSkpKTtcclxuICB9XHJcbn1cclxuIl19
import { __decorate, __read, __values } from "tslib";
import { Injectable } from '@angular/core';
import { mergeFields, parseFields } from '../utils/occ-fields';
import { HttpClient } from '@angular/common/http';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
/**
 * Helper service for optimizing endpoint calls to occ backend
 */
var OccFieldsService = /** @class */ (function () {
    function OccFieldsService(http) {
        this.http = http;
        this.FIELDS_PARAM = 'fields';
    }
    /**
     * Merge similar occ endpoints calls by merging fields parameter
     *
     * We assume that different scopes are defined by different fields parameters,
     * so we are grouping all requests with the same urls (except fields definition)
     * and merging into one request with fields that will satisfy all separate ones.
     *
     * @param models
     */
    OccFieldsService.prototype.getOptimalUrlGroups = function (models) {
        var e_1, _a, e_2, _b;
        var groupedByUrls = {};
        try {
            for (var _c = __values(models), _d = _c.next(); !_d.done; _d = _c.next()) {
                var model = _d.value;
                var _e = __read(this.splitFields(model.url), 2), urlPart = _e[0], fields = _e[1];
                if (!groupedByUrls[urlPart]) {
                    groupedByUrls[urlPart] = {};
                }
                model.fields = fields ? parseFields(fields) : {};
                groupedByUrls[urlPart][model.scopedData.scope] = model;
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
            }
            finally { if (e_1) throw e_1.error; }
        }
        var mergedUrls = {};
        try {
            for (var _f = __values(Object.entries(groupedByUrls)), _g = _f.next(); !_g.done; _g = _f.next()) {
                var _h = __read(_g.value, 2), url = _h[0], group = _h[1];
                var urlWithFields = this.getUrlWithFields(url, Object.values(group).map(function (lo) { return lo.fields; }));
                mergedUrls[urlWithFields] = group;
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (_g && !_g.done && (_b = _f.return)) _b.call(_f);
            }
            finally { if (e_2) throw e_2.error; }
        }
        return mergedUrls;
    };
    /**
     * Extract fields parameter from occ endpoint url
     *
     * @param urlWithFields
     */
    OccFieldsService.prototype.splitFields = function (urlWithFields) {
        var _this = this;
        var _a = __read(urlWithFields.split('?'), 2), url = _a[0], params = _a[1];
        var paramsMap = {};
        if (params) {
            params.split('&').map(function (param) {
                var keyValue = param.split('=');
                paramsMap[keyValue[0]] = keyValue[1];
            });
        }
        var nonFieldsParams = Object.keys(paramsMap)
            .sort()
            .reduce(function (id, par) {
            if (par !== _this.FIELDS_PARAM) {
                id.push(paramsMap[par] ? par + "=" + paramsMap[par] : par);
            }
            return id;
        }, []);
        var nonFields = nonFieldsParams.join('&');
        return [
            nonFields ? url + "?" + nonFields : url,
            paramsMap[this.FIELDS_PARAM],
        ];
    };
    /**
     * Combine url with field parameters
     *
     * @param url
     * @param fields
     */
    OccFieldsService.prototype.getUrlWithFields = function (url, fields) {
        var mergedFields = mergeFields(fields);
        if (mergedFields) {
            url += url.includes('?') ? '&' : '?';
            url += this.FIELDS_PARAM + "=" + mergedFields;
        }
        return url;
    };
    OccFieldsService.ctorParameters = function () { return [
        { type: HttpClient }
    ]; };
    OccFieldsService.ɵprov = i0.ɵɵdefineInjectable({ factory: function OccFieldsService_Factory() { return new OccFieldsService(i0.ɵɵinject(i1.HttpClient)); }, token: OccFieldsService, providedIn: "root" });
    OccFieldsService = __decorate([
        Injectable({
            providedIn: 'root',
        })
    ], OccFieldsService);
    return OccFieldsService;
}());
export { OccFieldsService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2NjLWZpZWxkcy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHNwYXJ0YWN1cy9jb3JlLyIsInNvdXJjZXMiOlsic3JjL29jYy9zZXJ2aWNlcy9vY2MtZmllbGRzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUUvRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7OztBQTZCbEQ7O0dBRUc7QUFJSDtJQUNFLDBCQUFzQixJQUFnQjtRQUFoQixTQUFJLEdBQUosSUFBSSxDQUFZO1FBRTVCLGlCQUFZLEdBQUcsUUFBUSxDQUFDO0lBRk8sQ0FBQztJQUkxQzs7Ozs7Ozs7T0FRRztJQUNILDhDQUFtQixHQUFuQixVQUFvQixNQUEyQjs7UUFDN0MsSUFBTSxhQUFhLEdBQTBCLEVBQUUsQ0FBQzs7WUFDaEQsS0FBb0IsSUFBQSxLQUFBLFNBQUEsTUFBMEIsQ0FBQSxnQkFBQSw0QkFBRTtnQkFBM0MsSUFBTSxLQUFLLFdBQUE7Z0JBQ1IsSUFBQSwyQ0FBK0MsRUFBOUMsZUFBTyxFQUFFLGNBQXFDLENBQUM7Z0JBQ3RELElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEVBQUU7b0JBQzNCLGFBQWEsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7aUJBQzdCO2dCQUNELEtBQUssQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztnQkFDakQsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsS0FBSyxDQUFDO2FBQ3hEOzs7Ozs7Ozs7UUFFRCxJQUFNLFVBQVUsR0FBMEIsRUFBRSxDQUFDOztZQUM3QyxLQUEyQixJQUFBLEtBQUEsU0FBQSxNQUFNLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFBLGdCQUFBLDRCQUFFO2dCQUEvQyxJQUFBLHdCQUFZLEVBQVgsV0FBRyxFQUFFLGFBQUs7Z0JBQ3BCLElBQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FDekMsR0FBRyxFQUNILE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQUMsRUFBRSxJQUFLLE9BQUEsRUFBRSxDQUFDLE1BQU0sRUFBVCxDQUFTLENBQUMsQ0FDNUMsQ0FBQztnQkFDRixVQUFVLENBQUMsYUFBYSxDQUFDLEdBQUcsS0FBSyxDQUFDO2FBQ25DOzs7Ozs7Ozs7UUFFRCxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNLLHNDQUFXLEdBQW5CLFVBQW9CLGFBQXFCO1FBQXpDLGlCQTJCQztRQTFCTyxJQUFBLHdDQUF3QyxFQUF2QyxXQUFHLEVBQUUsY0FBa0MsQ0FBQztRQUUvQyxJQUFNLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFFckIsSUFBSSxNQUFNLEVBQUU7WUFDVixNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFDLEtBQUs7Z0JBQzFCLElBQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2xDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdkMsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUVELElBQU0sZUFBZSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO2FBQzNDLElBQUksRUFBRTthQUNOLE1BQU0sQ0FBQyxVQUFDLEVBQUUsRUFBRSxHQUFHO1lBQ2QsSUFBSSxHQUFHLEtBQUssS0FBSSxDQUFDLFlBQVksRUFBRTtnQkFDN0IsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFJLEdBQUcsU0FBSSxTQUFTLENBQUMsR0FBRyxDQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQzVEO1lBQ0QsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFVCxJQUFNLFNBQVMsR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRTVDLE9BQU87WUFDTCxTQUFTLENBQUMsQ0FBQyxDQUFJLEdBQUcsU0FBSSxTQUFXLENBQUMsQ0FBQyxDQUFDLEdBQUc7WUFDdkMsU0FBUyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUM7U0FDN0IsQ0FBQztJQUNKLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNLLDJDQUFnQixHQUF4QixVQUF5QixHQUFXLEVBQUUsTUFBMkI7UUFDL0QsSUFBTSxZQUFZLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRXpDLElBQUksWUFBWSxFQUFFO1lBQ2hCLEdBQUcsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztZQUNyQyxHQUFHLElBQU8sSUFBSSxDQUFDLFlBQVksU0FBSSxZQUFjLENBQUM7U0FDL0M7UUFFRCxPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7O2dCQXJGMkIsVUFBVTs7O0lBRDNCLGdCQUFnQjtRQUg1QixVQUFVLENBQUM7WUFDVixVQUFVLEVBQUUsTUFBTTtTQUNuQixDQUFDO09BQ1csZ0JBQWdCLENBdUY1QjsyQkE3SEQ7Q0E2SEMsQUF2RkQsSUF1RkM7U0F2RlksZ0JBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBtZXJnZUZpZWxkcywgcGFyc2VGaWVsZHMgfSBmcm9tICcuLi91dGlscy9vY2MtZmllbGRzJztcclxuaW1wb3J0IHsgU2NvcGVkRGF0YSB9IGZyb20gJy4uLy4uL21vZGVsL3Njb3BlZC1kYXRhJztcclxuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgU2NvcGVkRGF0YVdpdGhVcmwge1xyXG4gIC8qKiBVcmwgKHdpdGggZmllbGRzKSB0byBsb2FkIHNjb3BlZCBkYXRhICovXHJcbiAgdXJsPzogc3RyaW5nO1xyXG4gIC8qKiBzY29wZWQgZGF0YSBtb2RlbCAqL1xyXG4gIHNjb3BlZERhdGE6IFNjb3BlZERhdGE8YW55PjtcclxufVxyXG5cclxuLyoqXHJcbiAqIEludGVybWVkaWF0ZSBtb2RlbCB0byBhY2NvbW1vZGF0ZSBhbGwgZGF0YSBuZWVkZWQgdG8gcGVyZm9ybSBvY2MgZmllbGRzIG9wdGltaXphdGlvbnNcclxuICogd3JhcHBpbmcgU2NvcGVkRGF0YSB3aXRoIHVybCBhbmQgZmllbGRzXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIE9jY0ZpZWxkc01vZGVsIGV4dGVuZHMgU2NvcGVkRGF0YVdpdGhVcmwge1xyXG4gIC8qKiBleHRyYWN0ZWQgZmllbGRzIG9iamVjdCwgdXNlZCB0byBleHRyYWN0IGRhdGEgZnJvbSBicm9hZGVyIG1vZGVsICovXHJcbiAgZmllbGRzPzogb2JqZWN0O1xyXG59XHJcblxyXG4vKipcclxuICogR3JvdXBlZCByZXN0IGNhbGxzIHdpdGggb3B0aW1hbCB1cmxzXHJcbiAqXHJcbiAqIE9uZSB1cmwgZ3JvdXBzIGFsbCBzY29wZXMgaXQgY292ZXJzIHdpdGggcmVsYXRlZCBvY2NGaWVsZHNNb2RlbHNcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgT2NjT3B0aW1pbWFsVXJsR3JvdXBzIHtcclxuICBbb3B0aW1hbFVybDogc3RyaW5nXToge1xyXG4gICAgW3Njb3BlOiBzdHJpbmddOiBPY2NGaWVsZHNNb2RlbDtcclxuICB9O1xyXG59XHJcblxyXG4vKipcclxuICogSGVscGVyIHNlcnZpY2UgZm9yIG9wdGltaXppbmcgZW5kcG9pbnQgY2FsbHMgdG8gb2NjIGJhY2tlbmRcclxuICovXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCcsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBPY2NGaWVsZHNTZXJ2aWNlIHtcclxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgaHR0cDogSHR0cENsaWVudCkge31cclxuXHJcbiAgcHJvdGVjdGVkIEZJRUxEU19QQVJBTSA9ICdmaWVsZHMnO1xyXG5cclxuICAvKipcclxuICAgKiBNZXJnZSBzaW1pbGFyIG9jYyBlbmRwb2ludHMgY2FsbHMgYnkgbWVyZ2luZyBmaWVsZHMgcGFyYW1ldGVyXHJcbiAgICpcclxuICAgKiBXZSBhc3N1bWUgdGhhdCBkaWZmZXJlbnQgc2NvcGVzIGFyZSBkZWZpbmVkIGJ5IGRpZmZlcmVudCBmaWVsZHMgcGFyYW1ldGVycyxcclxuICAgKiBzbyB3ZSBhcmUgZ3JvdXBpbmcgYWxsIHJlcXVlc3RzIHdpdGggdGhlIHNhbWUgdXJscyAoZXhjZXB0IGZpZWxkcyBkZWZpbml0aW9uKVxyXG4gICAqIGFuZCBtZXJnaW5nIGludG8gb25lIHJlcXVlc3Qgd2l0aCBmaWVsZHMgdGhhdCB3aWxsIHNhdGlzZnkgYWxsIHNlcGFyYXRlIG9uZXMuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gbW9kZWxzXHJcbiAgICovXHJcbiAgZ2V0T3B0aW1hbFVybEdyb3Vwcyhtb2RlbHM6IFNjb3BlZERhdGFXaXRoVXJsW10pOiBPY2NPcHRpbWltYWxVcmxHcm91cHMge1xyXG4gICAgY29uc3QgZ3JvdXBlZEJ5VXJsczogT2NjT3B0aW1pbWFsVXJsR3JvdXBzID0ge307XHJcbiAgICBmb3IgKGNvbnN0IG1vZGVsIG9mIG1vZGVscyBhcyBPY2NGaWVsZHNNb2RlbFtdKSB7XHJcbiAgICAgIGNvbnN0IFt1cmxQYXJ0LCBmaWVsZHNdID0gdGhpcy5zcGxpdEZpZWxkcyhtb2RlbC51cmwpO1xyXG4gICAgICBpZiAoIWdyb3VwZWRCeVVybHNbdXJsUGFydF0pIHtcclxuICAgICAgICBncm91cGVkQnlVcmxzW3VybFBhcnRdID0ge307XHJcbiAgICAgIH1cclxuICAgICAgbW9kZWwuZmllbGRzID0gZmllbGRzID8gcGFyc2VGaWVsZHMoZmllbGRzKSA6IHt9O1xyXG4gICAgICBncm91cGVkQnlVcmxzW3VybFBhcnRdW21vZGVsLnNjb3BlZERhdGEuc2NvcGVdID0gbW9kZWw7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbWVyZ2VkVXJsczogT2NjT3B0aW1pbWFsVXJsR3JvdXBzID0ge307XHJcbiAgICBmb3IgKGNvbnN0IFt1cmwsIGdyb3VwXSBvZiBPYmplY3QuZW50cmllcyhncm91cGVkQnlVcmxzKSkge1xyXG4gICAgICBjb25zdCB1cmxXaXRoRmllbGRzID0gdGhpcy5nZXRVcmxXaXRoRmllbGRzKFxyXG4gICAgICAgIHVybCxcclxuICAgICAgICBPYmplY3QudmFsdWVzKGdyb3VwKS5tYXAoKGxvKSA9PiBsby5maWVsZHMpXHJcbiAgICAgICk7XHJcbiAgICAgIG1lcmdlZFVybHNbdXJsV2l0aEZpZWxkc10gPSBncm91cDtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbWVyZ2VkVXJscztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEV4dHJhY3QgZmllbGRzIHBhcmFtZXRlciBmcm9tIG9jYyBlbmRwb2ludCB1cmxcclxuICAgKlxyXG4gICAqIEBwYXJhbSB1cmxXaXRoRmllbGRzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzcGxpdEZpZWxkcyh1cmxXaXRoRmllbGRzOiBzdHJpbmcpOiBbc3RyaW5nLCBzdHJpbmddIHtcclxuICAgIGNvbnN0IFt1cmwsIHBhcmFtc10gPSB1cmxXaXRoRmllbGRzLnNwbGl0KCc/Jyk7XHJcblxyXG4gICAgY29uc3QgcGFyYW1zTWFwID0ge307XHJcblxyXG4gICAgaWYgKHBhcmFtcykge1xyXG4gICAgICBwYXJhbXMuc3BsaXQoJyYnKS5tYXAoKHBhcmFtKSA9PiB7XHJcbiAgICAgICAgY29uc3Qga2V5VmFsdWUgPSBwYXJhbS5zcGxpdCgnPScpO1xyXG4gICAgICAgIHBhcmFtc01hcFtrZXlWYWx1ZVswXV0gPSBrZXlWYWx1ZVsxXTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgbm9uRmllbGRzUGFyYW1zID0gT2JqZWN0LmtleXMocGFyYW1zTWFwKVxyXG4gICAgICAuc29ydCgpXHJcbiAgICAgIC5yZWR1Y2UoKGlkLCBwYXIpID0+IHtcclxuICAgICAgICBpZiAocGFyICE9PSB0aGlzLkZJRUxEU19QQVJBTSkge1xyXG4gICAgICAgICAgaWQucHVzaChwYXJhbXNNYXBbcGFyXSA/IGAke3Bhcn09JHtwYXJhbXNNYXBbcGFyXX1gIDogcGFyKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGlkO1xyXG4gICAgICB9LCBbXSk7XHJcblxyXG4gICAgY29uc3Qgbm9uRmllbGRzID0gbm9uRmllbGRzUGFyYW1zLmpvaW4oJyYnKTtcclxuXHJcbiAgICByZXR1cm4gW1xyXG4gICAgICBub25GaWVsZHMgPyBgJHt1cmx9PyR7bm9uRmllbGRzfWAgOiB1cmwsXHJcbiAgICAgIHBhcmFtc01hcFt0aGlzLkZJRUxEU19QQVJBTV0sXHJcbiAgICBdO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ29tYmluZSB1cmwgd2l0aCBmaWVsZCBwYXJhbWV0ZXJzXHJcbiAgICpcclxuICAgKiBAcGFyYW0gdXJsXHJcbiAgICogQHBhcmFtIGZpZWxkc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0VXJsV2l0aEZpZWxkcyh1cmw6IHN0cmluZywgZmllbGRzOiAoc3RyaW5nIHwgb2JqZWN0KVtdKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IG1lcmdlZEZpZWxkcyA9IG1lcmdlRmllbGRzKGZpZWxkcyk7XHJcblxyXG4gICAgaWYgKG1lcmdlZEZpZWxkcykge1xyXG4gICAgICB1cmwgKz0gdXJsLmluY2x1ZGVzKCc/JykgPyAnJicgOiAnPyc7XHJcbiAgICAgIHVybCArPSBgJHt0aGlzLkZJRUxEU19QQVJBTX09JHttZXJnZWRGaWVsZHN9YDtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdXJsO1xyXG4gIH1cclxufVxyXG4iXX0=
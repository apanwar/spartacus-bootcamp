import { INIT, UPDATE } from '@ngrx/store';
import { deepMerge } from '../../config/utils/deep-merge';
import { StorageSyncType } from '../config/state-config';
import { filterKeysByType, getStateSlice } from '../utils/get-state-slice';
export function getStorageSyncReducer(winRef, config) {
    if (!winRef.nativeWindow ||
        !config ||
        !config.state ||
        !config.state.storageSync ||
        !config.state.storageSync.keys) {
        return function (reducer) { return reducer; };
    }
    var storageSyncConfig = config.state.storageSync;
    return function (reducer) {
        return function (state, action) {
            var newState = reducer(state, action);
            if (action.type === INIT || action.type === UPDATE) {
                var rehydratedState = rehydrate(config, winRef);
                return deepMerge({}, newState, rehydratedState);
            }
            if (action.type !== INIT) {
                // handle local storage
                var localStorageKeys = filterKeysByType(storageSyncConfig.keys, StorageSyncType.LOCAL_STORAGE);
                var localStorageExclusionKeys = filterKeysByType(storageSyncConfig.excludeKeys, StorageSyncType.LOCAL_STORAGE);
                var localStorageStateSlices = getStateSlice(localStorageKeys, localStorageExclusionKeys, newState);
                persistToStorage(config.state.storageSync.localStorageKeyName, localStorageStateSlices, winRef.localStorage);
                // handle session storage
                var sessionStorageKeys = filterKeysByType(storageSyncConfig.keys, StorageSyncType.SESSION_STORAGE);
                var sessionStorageExclusionKeys = filterKeysByType(storageSyncConfig.excludeKeys, StorageSyncType.SESSION_STORAGE);
                var sessionStorageStateSlices = getStateSlice(sessionStorageKeys, sessionStorageExclusionKeys, newState);
                persistToStorage(config.state.storageSync.sessionStorageKeyName, sessionStorageStateSlices, winRef.sessionStorage);
            }
            return newState;
        };
    };
}
export function rehydrate(config, winRef) {
    var localStorageValue = readFromStorage(winRef.localStorage, config.state.storageSync.localStorageKeyName);
    var sessionStorageValue = readFromStorage(winRef.sessionStorage, config.state.storageSync.sessionStorageKeyName);
    return deepMerge(localStorageValue, sessionStorageValue);
}
export function exists(value) {
    if (value != null) {
        if (typeof value === 'object') {
            return Object.keys(value).length !== 0;
        }
        return value !== '';
    }
    return false;
}
export function getStorage(storageType, winRef) {
    var storage;
    switch (storageType) {
        case StorageSyncType.LOCAL_STORAGE: {
            storage = winRef.localStorage;
            break;
        }
        case StorageSyncType.SESSION_STORAGE: {
            storage = winRef.sessionStorage;
            break;
        }
        case StorageSyncType.NO_STORAGE: {
            storage = undefined;
            break;
        }
        default: {
            storage = winRef.sessionStorage;
        }
    }
    return storage;
}
export function persistToStorage(configKey, value, storage) {
    if (!isSsr(storage) && value) {
        storage.setItem(configKey, JSON.stringify(value));
    }
}
export function readFromStorage(storage, key) {
    if (isSsr(storage)) {
        return;
    }
    var storageValue = storage.getItem(key);
    if (!storageValue) {
        return;
    }
    return JSON.parse(storageValue);
}
export function isSsr(storage) {
    return !Boolean(storage);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS1zeW5jLnJlZHVjZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ac3BhcnRhY3VzL2NvcmUvIiwic291cmNlcyI6WyJzcmMvc3RhdGUvcmVkdWNlcnMvc3RvcmFnZS1zeW5jLnJlZHVjZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUF5QixJQUFJLEVBQWUsTUFBTSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQy9FLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUUxRCxPQUFPLEVBQWUsZUFBZSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdEUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRTNFLE1BQU0sVUFBVSxxQkFBcUIsQ0FDbkMsTUFBaUIsRUFDakIsTUFBb0I7SUFFcEIsSUFDRSxDQUFDLE1BQU0sQ0FBQyxZQUFZO1FBQ3BCLENBQUMsTUFBTTtRQUNQLENBQUMsTUFBTSxDQUFDLEtBQUs7UUFDYixDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVztRQUN6QixDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLElBQUksRUFDOUI7UUFDQSxPQUFPLFVBQUMsT0FBTyxJQUFLLE9BQUEsT0FBTyxFQUFQLENBQU8sQ0FBQztLQUM3QjtJQUVELElBQU0saUJBQWlCLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUM7SUFFbkQsT0FBTyxVQUFDLE9BQWlDO1FBQ3ZDLE9BQU8sVUFBQyxLQUFLLEVBQUUsTUFBTTtZQUNuQixJQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBRXhDLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxJQUFJLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxNQUFNLEVBQUU7Z0JBQ2xELElBQU0sZUFBZSxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFD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T0FBTyxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUM7U0FDakM7S0FDRjtJQUVELE9BQU8sT0FBTyxDQUFDO0FBQ2pCLENBQUM7QUFFRCxNQUFNLFVBQVUsZ0JBQWdCLENBQzlCLFNBQWlCLEVBQ2pCLEtBQVUsRUFDVixPQUFnQjtJQUVoQixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEtBQUssRUFBRTtRQUM1QixPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7S0FDbkQ7QUFDSCxDQUFDO0FBRUQsTUFBTSxVQUFVLGVBQWUsQ0FBQyxPQUFnQixFQUFFLEdBQVc7SUFDM0QsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUU7UUFDbEIsT0FBTztLQUNSO0lBRUQsSUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMxQyxJQUFJLENBQUMsWUFBWSxFQUFFO1FBQ2pCLE9BQU87S0FDUjtJQUVELE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUNsQyxDQUFDO0FBRUQsTUFBTSxVQUFVLEtBQUssQ0FBQyxPQUFnQjtJQUNwQyxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzNCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBY3Rpb24sIEFjdGlvblJlZHVjZXIsIElOSVQsIE1ldGFSZWR1Y2VyLCBVUERBVEUgfSBmcm9tICdAbmdyeC9zdG9yZSc7XHJcbmltcG9ydCB7IGRlZXBNZXJnZSB9IGZyb20gJy4uLy4uL2NvbmZpZy91dGlscy9kZWVwLW1lcmdlJztcclxuaW1wb3J0IHsgV2luZG93UmVmIH0gZnJvbSAnLi4vLi4vd2luZG93L3dpbmRvdy1yZWYnO1xyXG5pbXBvcnQgeyBTdGF0ZUNvbmZpZywgU3RvcmFnZVN5bmNUeXBlIH0gZnJvbSAnLi4vY29uZmlnL3N0YXRlLWNvbmZpZyc7XHJcbmltcG9ydCB7IGZpbHRlcktleXNCeVR5cGUsIGdldFN0YXRlU2xpY2UgfSBmcm9tICcuLi91dGlscy9nZXQtc3RhdGUtc2xpY2UnO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFN0b3JhZ2VTeW5jUmVkdWNlcjxUPihcclxuICB3aW5SZWY6IFdpbmRvd1JlZixcclxuICBjb25maWc/OiBTdGF0ZUNvbmZpZ1xyXG4pOiBNZXRhUmVkdWNlcjxULCBBY3Rpb24+IHtcclxuICBpZiAoXHJcbiAgICAhd2luUmVmLm5hdGl2ZVdpbmRvdyB8fFxyXG4gICAgIWNvbmZpZyB8fFxyXG4gICAgIWNvbmZpZy5zdGF0ZSB8fFxyXG4gICAgIWNvbmZpZy5zdGF0ZS5zdG9yYWdlU3luYyB8fFxyXG4gICAgIWNvbmZpZy5zdGF0ZS5zdG9yYWdlU3luYy5rZXlzXHJcbiAgKSB7XHJcbiAgICByZXR1cm4gKHJlZHVjZXIpID0+IHJlZHVjZXI7XHJcbiAgfVxyXG5cclxuICBjb25zdCBzdG9yYWdlU3luY0NvbmZpZyA9IGNvbmZpZy5zdGF0ZS5zdG9yYWdlU3luYztcclxuXHJcbiAgcmV0dXJuIChyZWR1Y2VyOiBBY3Rpb25SZWR1Y2VyPFQsIEFjdGlvbj4pOiBBY3Rpb25SZWR1Y2VyPFQsIEFjdGlvbj4gPT4ge1xyXG4gICAgcmV0dXJuIChzdGF0ZSwgYWN0aW9uKTogVCA9PiB7XHJcbiAgICAgIGNvbnN0IG5ld1N0YXRlID0gcmVkdWNlcihzdGF0ZSwgYWN0aW9uKTtcclxuXHJcbiAgICAgIGlmIChhY3Rpb24udHlwZSA9PT0gSU5JVCB8fCBhY3Rpb24udHlwZSA9PT0gVVBEQVRFKSB7XHJcbiAgICAgICAgY29uc3QgcmVoeWRyYXRlZFN0YXRlID0gcmVoeWRyYXRlKGNvbmZpZywgd2luUmVmKTtcclxuICAgICAgICByZXR1cm4gZGVlcE1lcmdlKHt9LCBuZXdTdGF0ZSwgcmVoeWRyYXRlZFN0YXRlKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKGFjdGlvbi50eXBlICE9PSBJTklUKSB7XHJcbiAgICAgICAgLy8gaGFuZGxlIGxvY2FsIHN0b3JhZ2VcclxuICAgICAgICBjb25zdCBsb2NhbFN0b3JhZ2VLZXlzID0gZmlsdGVyS2V5c0J5VHlwZShcclxuICAgICAgICAgIHN0b3JhZ2VTeW5jQ29uZmlnLmtleXMsXHJcbiAgICAgICAgICBTdG9yYWdlU3luY1R5cGUuTE9DQUxfU1RPUkFHRVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgY29uc3QgbG9jYWxTdG9yYWdlRXhjbHVzaW9uS2V5cyA9IGZpbHRlcktleXNCeVR5cGUoXHJcbiAgICAgICAgICBzdG9yYWdlU3luY0NvbmZpZy5leGNsdWRlS2V5cyxcclxuICAgICAgICAgIFN0b3JhZ2VTeW5jVHlwZS5MT0NBTF9TVE9SQUdFXHJcbiAgICAgICAgKTtcclxuICAgICAgICBjb25zdCBsb2NhbFN0b3JhZ2VTdGF0ZVNsaWNlcyA9IGdldFN0YXRlU2xpY2UoXHJcbiAgICAgICAgICBsb2NhbFN0b3JhZ2VLZXlzLFxyXG4gICAgICAgICAgbG9jYWxTdG9yYWdlRXhjbHVzaW9uS2V5cyxcclxuICAgICAgICAgIG5ld1N0YXRlXHJcbiAgICAgICAgKTtcclxuICAgICAgICBwZXJzaXN0VG9TdG9yYWdlKFxyXG4gICAgICAgICAgY29uZmlnLnN0YXRlLnN0b3JhZ2VTeW5jLmxvY2FsU3RvcmFnZUtleU5hbWUsXHJcbiAgICAgICAgICBsb2NhbFN0b3JhZ2VTdGF0ZVNsaWNlcyxcclxuICAgICAgICAgIHdpblJlZi5sb2NhbFN0b3JhZ2VcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICAvLyBoYW5kbGUgc2Vzc2lvbiBzdG9yYWdlXHJcbiAgICAgICAgY29uc3Qgc2Vzc2lvblN0b3JhZ2VLZXlzID0gZmlsdGVyS2V5c0J5VHlwZShcclxuICAgICAgICAgIHN0b3JhZ2VTeW5jQ29uZmlnLmtleXMsXHJcbiAgICAgICAgICBTdG9yYWdlU3luY1R5cGUuU0VTU0lPTl9TVE9SQUdFXHJcbiAgICAgICAgKTtcclxuICAgICAgICBjb25zdCBzZXNzaW9uU3RvcmFnZUV4Y2x1c2lvbktleXMgPSBmaWx0ZXJLZXlzQnlUeXBlKFxyXG4gICAgICAgICAgc3RvcmFnZVN5bmNDb25maWcuZXhjbHVkZUtleXMsXHJcbiAgICAgICAgICBTdG9yYWdlU3luY1R5cGUuU0VTU0lPTl9TVE9SQUdFXHJcbiAgICAgICAgKTtcclxuICAgICAgICBjb25zdCBzZXNzaW9uU3RvcmFnZVN0YXRlU2xpY2VzID0gZ2V0U3RhdGVTbGljZShcclxuICAgICAgICAgIHNlc3Npb25TdG9yYWdlS2V5cyxcclxuICAgICAgICAgIHNlc3Npb25TdG9yYWdlRXhjbHVzaW9uS2V5cyxcclxuICAgICAgICAgIG5ld1N0YXRlXHJcbiAgICAgICAgKTtcclxuICAgICAgICBwZXJzaXN0VG9TdG9yYWdlKFxyXG4gICAgICAgICAgY29uZmlnLnN0YXRlLnN0b3JhZ2VTeW5jLnNlc3Npb25TdG9yYWdlS2V5TmFtZSxcclxuICAgICAgICAgIHNlc3Npb25TdG9yYWdlU3RhdGVTbGljZXMsXHJcbiAgICAgICAgICB3aW5SZWYuc2Vzc2lvblN0b3JhZ2VcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gbmV3U3RhdGU7XHJcbiAgICB9O1xyXG4gIH07XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiByZWh5ZHJhdGU8VD4oY29uZmlnOiBTdGF0ZUNvbmZpZywgd2luUmVmOiBXaW5kb3dSZWYpOiBUIHtcclxuICBjb25zdCBsb2NhbFN0b3JhZ2VWYWx1ZSA9IHJlYWRGcm9tU3RvcmFnZShcclxuICAgIHdpblJlZi5sb2NhbFN0b3JhZ2UsXHJcbiAgICBjb25maWcuc3RhdGUuc3RvcmFnZVN5bmMubG9jYWxTdG9yYWdlS2V5TmFtZVxyXG4gICk7XHJcbiAgY29uc3Qgc2Vzc2lvblN0b3JhZ2VWYWx1ZSA9IHJlYWRGcm9tU3RvcmFnZShcclxuICAgIHdpblJlZi5zZXNzaW9uU3RvcmFnZSxcclxuICAgIGNvbmZpZy5zdGF0ZS5zdG9yYWdlU3luYy5zZXNzaW9uU3RvcmFnZUtleU5hbWVcclxuICApO1xyXG5cclxuICByZXR1cm4gZGVlcE1lcmdlKGxvY2FsU3RvcmFnZVZhbHVlLCBzZXNzaW9uU3RvcmFnZVZhbHVlKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGV4aXN0cyh2YWx1ZTogT2JqZWN0KTogYm9vbGVhbiB7XHJcbiAgaWYgKHZhbHVlICE9IG51bGwpIHtcclxuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgIHJldHVybiBPYmplY3Qua2V5cyh2YWx1ZSkubGVuZ3RoICE9PSAwO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHZhbHVlICE9PSAnJztcclxuICB9XHJcbiAgcmV0dXJuIGZhbHNlO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0U3RvcmFnZShcclxuICBzdG9yYWdlVHlwZTogU3RvcmFnZVN5bmNUeXBlLFxyXG4gIHdpblJlZjogV2luZG93UmVmXHJcbik6IFN0b3JhZ2Uge1xyXG4gIGxldCBzdG9yYWdlOiBTdG9yYWdlO1xyXG5cclxuICBzd2l0Y2ggKHN0b3JhZ2VUeXBlKSB7XHJcbiAgICBjYXNlIFN0b3JhZ2VTeW5jVHlwZS5MT0NBTF9TVE9SQUdFOiB7XHJcbiAgICAgIHN0b3JhZ2UgPSB3aW5SZWYubG9jYWxTdG9yYWdlO1xyXG4gICAgICBicmVhaztcclxuICAgIH1cclxuICAgIGNhc2UgU3RvcmFnZVN5bmNUeXBlLlNFU1NJT05fU1RPUkFHRToge1xyXG4gICAgICBzdG9yYWdlID0gd2luUmVmLnNlc3Npb25TdG9yYWdlO1xyXG4gICAgICBicmVhaztcclxuICAgIH1cclxuICAgIGNhc2UgU3RvcmFnZVN5bmNUeXBlLk5PX1NUT1JBR0U6IHtcclxuICAgICAgc3RvcmFnZSA9IHVuZGVmaW5lZDtcclxuICAgICAgYnJlYWs7XHJcbiAgICB9XHJcblxyXG4gICAgZGVmYXVsdDoge1xyXG4gICAgICBzdG9yYWdlID0gd2luUmVmLnNlc3Npb25TdG9yYWdlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHN0b3JhZ2U7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBwZXJzaXN0VG9TdG9yYWdlKFxyXG4gIGNvbmZpZ0tleTogc3RyaW5nLFxyXG4gIHZhbHVlOiBhbnksXHJcbiAgc3RvcmFnZTogU3RvcmFnZVxyXG4pOiB2b2lkIHtcclxuICBpZiAoIWlzU3NyKHN0b3JhZ2UpICYmIHZhbHVlKSB7XHJcbiAgICBzdG9yYWdlLnNldEl0ZW0oY29uZmlnS2V5LCBKU09OLnN0cmluZ2lmeSh2YWx1ZSkpO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJlYWRGcm9tU3RvcmFnZShzdG9yYWdlOiBTdG9yYWdlLCBrZXk6IHN0cmluZyk6IGFueSB7XHJcbiAgaWYgKGlzU3NyKHN0b3JhZ2UpKSB7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG5cclxuICBjb25zdCBzdG9yYWdlVmFsdWUgPSBzdG9yYWdlLmdldEl0ZW0oa2V5KTtcclxuICBpZiAoIXN0b3JhZ2VWYWx1ZSkge1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIEpTT04ucGFyc2Uoc3RvcmFnZVZhbHVlKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzU3NyKHN0b3JhZ2U6IFN0b3JhZ2UpOiBib29sZWFuIHtcclxuICByZXR1cm4gIUJvb2xlYW4oc3RvcmFnZSk7XHJcbn1cclxuIl19
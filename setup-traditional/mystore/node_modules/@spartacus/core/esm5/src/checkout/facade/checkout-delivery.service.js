import { __decorate, __read } from "tslib";
import { Injectable } from '@angular/core';
import { select, Store } from '@ngrx/store';
import { filter, pluck, shareReplay, tap, withLatestFrom, } from 'rxjs/operators';
import { AuthService } from '../../auth/facade/auth.service';
import { ActiveCartService } from '../../cart/facade/active-cart.service';
import { OCC_USER_ID_ANONYMOUS } from '../../occ/utils/occ-constants';
import { getProcessStateFactory } from '../../process/store/selectors/process-group.selectors';
import { CheckoutActions } from '../store/actions/index';
import { SET_DELIVERY_ADDRESS_PROCESS_ID, SET_DELIVERY_MODE_PROCESS_ID, SET_SUPPORTED_DELIVERY_MODE_PROCESS_ID, } from '../store/checkout-state';
import { CheckoutSelectors } from '../store/selectors/index';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/store";
import * as i2 from "../../auth/facade/auth.service";
import * as i3 from "../../cart/facade/active-cart.service";
var CheckoutDeliveryService = /** @class */ (function () {
    function CheckoutDeliveryService(checkoutStore, authService, activeCartService) {
        this.checkoutStore = checkoutStore;
        this.authService = authService;
        this.activeCartService = activeCartService;
    }
    /**
     * Get supported delivery modes
     */
    CheckoutDeliveryService.prototype.getSupportedDeliveryModes = function () {
        var _this = this;
        return this.checkoutStore.pipe(select(CheckoutSelectors.getSupportedDeliveryModes), withLatestFrom(this.checkoutStore.pipe(select(getProcessStateFactory(SET_SUPPORTED_DELIVERY_MODE_PROCESS_ID)))), tap(function (_a) {
            var _b = __read(_a, 2), loadingState = _b[1];
            if (!(loadingState.loading || loadingState.success || loadingState.error)) {
                _this.loadSupportedDeliveryModes();
            }
        }), pluck(0), shareReplay({ bufferSize: 1, refCount: true }));
    };
    /**
     * Get selected delivery mode
     */
    CheckoutDeliveryService.prototype.getSelectedDeliveryMode = function () {
        return this.checkoutStore.pipe(select(CheckoutSelectors.getSelectedDeliveryMode));
    };
    /**
     * Get selected delivery mode code
     */
    CheckoutDeliveryService.prototype.getSelectedDeliveryModeCode = function () {
        return this.checkoutStore.pipe(select(CheckoutSelectors.getSelectedDeliveryModeCode));
    };
    /**
     * Get delivery address
     */
    CheckoutDeliveryService.prototype.getDeliveryAddress = function () {
        return this.checkoutStore.pipe(select(CheckoutSelectors.getDeliveryAddress));
    };
    /**
     * Get status about successfully set Delivery Address
     */
    CheckoutDeliveryService.prototype.getSetDeliveryAddressProcess = function () {
        return this.checkoutStore.pipe(select(getProcessStateFactory(SET_DELIVERY_ADDRESS_PROCESS_ID)));
    };
    /**
     * Clear info about process of setting Delivery Address
     */
    CheckoutDeliveryService.prototype.resetSetDeliveryAddressProcess = function () {
        this.checkoutStore.dispatch(new CheckoutActions.ResetSetDeliveryAddressProcess());
    };
    /**
     * Get status about of set Delivery Mode process
     */
    CheckoutDeliveryService.prototype.getSetDeliveryModeProcess = function () {
        return this.checkoutStore.pipe(select(getProcessStateFactory(SET_DELIVERY_MODE_PROCESS_ID)));
    };
    /**
     * Clear info about process of setting Delivery Mode
     */
    CheckoutDeliveryService.prototype.resetSetDeliveryModeProcess = function () {
        this.checkoutStore.dispatch(new CheckoutActions.ResetSetDeliveryModeProcess());
    };
    /**
     * Clear info about process of setting Supported Delivery Modes
     */
    CheckoutDeliveryService.prototype.resetLoadSupportedDeliveryModesProcess = function () {
        this.checkoutStore.dispatch(new CheckoutActions.ResetLoadSupportedDeliveryModesProcess());
    };
    /**
     * Get status about of set supported Delivery Modes process
     */
    CheckoutDeliveryService.prototype.getLoadSupportedDeliveryModeProcess = function () {
        return this.checkoutStore.pipe(select(getProcessStateFactory(SET_SUPPORTED_DELIVERY_MODE_PROCESS_ID)));
    };
    /**
     * Clear supported delivery modes loaded in last checkout process
     */
    CheckoutDeliveryService.prototype.clearCheckoutDeliveryModes = function () {
        this.checkoutStore.dispatch(new CheckoutActions.ClearSupportedDeliveryModes());
    };
    /**
     * Get address verification results
     */
    CheckoutDeliveryService.prototype.getAddressVerificationResults = function () {
        return this.checkoutStore.pipe(select(CheckoutSelectors.getAddressVerificationResults), filter(function (results) { return Object.keys(results).length !== 0; }));
    };
    /**
     * Create and set a delivery address using the address param
     * @param address : the Address to be created and set
     */
    CheckoutDeliveryService.prototype.createAndSetAddress = function (address) {
        if (this.actionAllowed()) {
            var userId_1;
            this.authService
                .getOccUserId()
                .subscribe(function (occUserId) { return (userId_1 = occUserId); })
                .unsubscribe();
            var cartId_1;
            this.activeCartService
                .getActiveCartId()
                .subscribe(function (activeCartId) { return (cartId_1 = activeCartId); })
                .unsubscribe();
            if (userId_1 && cartId_1) {
                this.checkoutStore.dispatch(new CheckoutActions.AddDeliveryAddress({
                    userId: userId_1,
                    cartId: cartId_1,
                    address: address,
                }));
            }
        }
    };
    /**
     * Load supported delivery modes
     */
    CheckoutDeliveryService.prototype.loadSupportedDeliveryModes = function () {
        if (this.actionAllowed()) {
            var userId_2;
            this.authService
                .getOccUserId()
                .subscribe(function (occUserId) { return (userId_2 = occUserId); })
                .unsubscribe();
            var cartId_2;
            this.activeCartService
                .getActiveCartId()
                .subscribe(function (activeCartId) { return (cartId_2 = activeCartId); })
                .unsubscribe();
            if (userId_2 && cartId_2) {
                this.checkoutStore.dispatch(new CheckoutActions.LoadSupportedDeliveryModes({
                    userId: userId_2,
                    cartId: cartId_2,
                }));
            }
        }
    };
    /**
     * Set delivery mode
     * @param mode : The delivery mode to be set
     */
    CheckoutDeliveryService.prototype.setDeliveryMode = function (mode) {
        if (this.actionAllowed()) {
            var userId_3;
            this.authService
                .getOccUserId()
                .subscribe(function (occUserId) { return (userId_3 = occUserId); })
                .unsubscribe();
            var cartId_3;
            this.activeCartService
                .getActiveCartId()
                .subscribe(function (activeCartId) { return (cartId_3 = activeCartId); })
                .unsubscribe();
            if (userId_3 && cartId_3) {
                this.checkoutStore.dispatch(new CheckoutActions.SetDeliveryMode({
                    userId: userId_3,
                    cartId: cartId_3,
                    selectedModeId: mode,
                }));
            }
        }
    };
    /**
     * Verifies the address
     * @param address : the address to be verified
     */
    CheckoutDeliveryService.prototype.verifyAddress = function (address) {
        if (this.actionAllowed()) {
            var userId_4;
            this.authService
                .getOccUserId()
                .subscribe(function (occUserId) { return (userId_4 = occUserId); })
                .unsubscribe();
            if (userId_4) {
                this.checkoutStore.dispatch(new CheckoutActions.VerifyAddress({
                    userId: userId_4,
                    address: address,
                }));
            }
        }
    };
    /**
     * Set delivery address
     * @param address : The address to be set
     */
    CheckoutDeliveryService.prototype.setDeliveryAddress = function (address) {
        if (this.actionAllowed()) {
            var userId_5;
            this.authService
                .getOccUserId()
                .subscribe(function (occUserId) { return (userId_5 = occUserId); })
                .unsubscribe();
            var cartId_4;
            this.activeCartService
                .getActiveCartId()
                .subscribe(function (activeCartId) { return (cartId_4 = activeCartId); })
                .unsubscribe();
            if (cartId_4 && userId_5) {
                this.checkoutStore.dispatch(new CheckoutActions.SetDeliveryAddress({
                    userId: userId_5,
                    cartId: cartId_4,
                    address: address,
                }));
            }
        }
    };
    /**
     * Clear address verification results
     */
    CheckoutDeliveryService.prototype.clearAddressVerificationResults = function () {
        this.checkoutStore.dispatch(new CheckoutActions.ClearAddressVerificationResults());
    };
    /**
     * Clear address already setup in last checkout process
     */
    CheckoutDeliveryService.prototype.clearCheckoutDeliveryAddress = function () {
        var userId;
        this.authService
            .getOccUserId()
            .subscribe(function (occUserId) { return (userId = occUserId); })
            .unsubscribe();
        var cartId;
        this.activeCartService
            .getActiveCartId()
            .subscribe(function (activeCartId) { return (cartId = activeCartId); })
            .unsubscribe();
        if (userId && cartId) {
            this.checkoutStore.dispatch(new CheckoutActions.ClearCheckoutDeliveryAddress({
                userId: userId,
                cartId: cartId,
            }));
        }
    };
    /**
     * Clear selected delivery mode setup in last checkout process
     */
    CheckoutDeliveryService.prototype.clearCheckoutDeliveryMode = function () {
        var userId;
        this.authService
            .getOccUserId()
            .subscribe(function (occUserId) { return (userId = occUserId); })
            .unsubscribe();
        var cartId;
        this.activeCartService
            .getActiveCartId()
            .subscribe(function (activeCartId) { return (cartId = activeCartId); })
            .unsubscribe();
        if (userId && cartId) {
            this.checkoutStore.dispatch(new CheckoutActions.ClearCheckoutDeliveryMode({
                userId: userId,
                cartId: cartId,
            }));
        }
    };
    /**
     * Clear address and delivery mode already setup in last checkout process
     */
    CheckoutDeliveryService.prototype.clearCheckoutDeliveryDetails = function () {
        this.clearCheckoutDeliveryAddress();
        this.clearCheckoutDeliveryMode();
        this.clearCheckoutDeliveryModes();
    };
    CheckoutDeliveryService.prototype.actionAllowed = function () {
        var userId;
        this.authService
            .getOccUserId()
            .subscribe(function (occUserId) { return (userId = occUserId); })
            .unsubscribe();
        return ((userId && userId !== OCC_USER_ID_ANONYMOUS) ||
            this.activeCartService.isGuestCart());
    };
    CheckoutDeliveryService.ctorParameters = function () { return [
        { type: Store },
        { type: AuthService },
        { type: ActiveCartService }
    ]; };
    CheckoutDeliveryService.ɵprov = i0.ɵɵdefineInjectable({ factory: function CheckoutDeliveryService_Factory() { return new CheckoutDeliveryService(i0.ɵɵinject(i1.Store), i0.ɵɵinject(i2.AuthService), i0.ɵɵinject(i3.ActiveCartService)); }, token: CheckoutDeliveryService, providedIn: "root" });
    CheckoutDeliveryService = __decorate([
        Injectable({
            providedIn: 'root',
        })
    ], CheckoutDeliveryService);
    return CheckoutDeliveryService;
}());
export { CheckoutDeliveryService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2tvdXQtZGVsaXZlcnkuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BzcGFydGFjdXMvY29yZS8iLCJzb3VyY2VzIjpbInNyYy9jaGVja291dC9mYWNhZGUvY2hlY2tvdXQtZGVsaXZlcnkuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUU1QyxPQUFPLEVBQ0wsTUFBTSxFQUNOLEtBQUssRUFDTCxXQUFXLEVBQ1gsR0FBRyxFQUNILGNBQWMsR0FDZixNQUFNLGdCQUFnQixDQUFDO0FBQ3hCLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUM3RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQztBQUcxRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUV0RSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx1REFBdUQsQ0FBQztBQUUvRixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDekQsT0FBTyxFQUNMLCtCQUErQixFQUMvQiw0QkFBNEIsRUFDNUIsc0NBQXNDLEdBRXZDLE1BQU0seUJBQXlCLENBQUM7QUFDakMsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7Ozs7O0FBSzdEO0lBQ0UsaUNBQ1ksYUFBZ0UsRUFDaEUsV0FBd0IsRUFDeEIsaUJBQW9DO1FBRnBDLGtCQUFhLEdBQWIsYUFBYSxDQUFtRDtRQUNoRSxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO0lBQzdDLENBQUM7SUFFSjs7T0FFRztJQUNILDJEQUF5QixHQUF6QjtRQUFBLGlCQWtCQztRQWpCQyxPQUFPLElBQUksQ0FBQyxh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cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBzZWxlY3QsIFN0b3JlIH0gZnJvbSAnQG5ncngvc3RvcmUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7XHJcbiAgZmlsdGVyLFxyXG4gIHBsdWNrLFxyXG4gIHNoYXJlUmVwbGF5LFxyXG4gIHRhcCxcclxuICB3aXRoTGF0ZXN0RnJvbSxcclxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEF1dGhTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vYXV0aC9mYWNhZGUvYXV0aC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQWN0aXZlQ2FydFNlcnZpY2UgfSBmcm9tICcuLi8uLi9jYXJ0L2ZhY2FkZS9hY3RpdmUtY2FydC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQWRkcmVzcywgQWRkcmVzc1ZhbGlkYXRpb24gfSBmcm9tICcuLi8uLi9tb2RlbC9hZGRyZXNzLm1vZGVsJztcclxuaW1wb3J0IHsgRGVsaXZlcnlNb2RlIH0gZnJvbSAnLi4vLi4vbW9kZWwvb3JkZXIubW9kZWwnO1xyXG5pbXBvcnQgeyBPQ0NfVVNFUl9JRF9BTk9OWU1PVVMgfSBmcm9tICcuLi8uLi9vY2MvdXRpbHMvb2NjLWNvbnN0YW50cyc7XHJcbmltcG9ydCB7IFN0YXRlV2l0aFByb2Nlc3MgfSBmcm9tICcuLi8uLi9wcm9jZXNzL3N0b3JlL3Byb2Nlc3Mtc3RhdGUnO1xyXG5pbXBvcnQgeyBnZXRQcm9jZXNzU3RhdGVGYWN0b3J5IH0gZnJvbSAnLi4vLi4vcHJvY2Vzcy9zdG9yZS9zZWxlY3RvcnMvcHJvY2Vzcy1ncm91cC5zZWxlY3RvcnMnO1xyXG5pbXBvcnQgeyBMb2FkZXJTdGF0ZSB9IGZyb20gJy4uLy4uL3N0YXRlL3V0aWxzL2xvYWRlci9sb2FkZXItc3RhdGUnO1xyXG5pbXBvcnQgeyBDaGVja291dEFjdGlvbnMgfSBmcm9tICcuLi9zdG9yZS9hY3Rpb25zL2luZGV4JztcclxuaW1wb3J0IHtcclxuICBTRVRfREVMSVZFUllfQUREUkVTU19QUk9DRVNTX0lELFxyXG4gIFNFVF9ERUxJVkVSWV9NT0RFX1BST0NFU1NfSUQsXHJcbiAgU0VUX1NVUFBPUlRFRF9ERUxJVkVSWV9NT0RFX1BST0NFU1NfSUQsXHJcbiAgU3RhdGVXaXRoQ2hlY2tvdXQsXHJcbn0gZnJvbSAnLi4vc3RvcmUvY2hlY2tvdXQtc3RhdGUnO1xyXG5pbXBvcnQgeyBDaGVja291dFNlbGVjdG9ycyB9IGZyb20gJy4uL3N0b3JlL3NlbGVjdG9ycy9pbmRleCc7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgQ2hlY2tvdXREZWxpdmVyeVNlcnZpY2Uge1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJvdGVjdGVkIGNoZWNrb3V0U3RvcmU6IFN0b3JlPFN0YXRlV2l0aENoZWNrb3V0IHwgU3RhdGVXaXRoUHJvY2Vzczx2b2lkPj4sXHJcbiAgICBwcm90ZWN0ZWQgYXV0aFNlcnZpY2U6IEF1dGhTZXJ2aWNlLFxyXG4gICAgcHJvdGVjdGVkIGFjdGl2ZUNhcnRTZXJ2aWNlOiBBY3RpdmVDYXJ0U2VydmljZVxyXG4gICkge31cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IHN1cHBvcnRlZCBkZWxpdmVyeSBtb2Rlc1xyXG4gICAqL1xyXG4gIGdldFN1cHBvcnRlZERlbGl2ZXJ5TW9kZXMoKTogT2JzZXJ2YWJsZTxEZWxpdmVyeU1vZGVbXT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuY2hlY2tvdXRTdG9yZS5waXBlKFxyXG4gICAgICBzZWxlY3QoQ2hlY2tvdXRTZWxlY3RvcnMuZ2V0U3VwcG9ydGVkRGVsaXZlcnlNb2RlcyksXHJcbiAgICAgIHdpdGhMYXRlc3RGcm9tKFxyXG4gICAgICAgIHRoaXMuY2hlY2tvdXRTdG9yZS5waXBlKFxyXG4gICAgICAgICAgc2VsZWN0KGdldFByb2Nlc3NTdGF0ZUZhY3RvcnkoU0VUX1NVUFBPUlRFRF9ERUxJVkVSWV9NT0RFX1BST0NFU1NfSUQpKVxyXG4gICAgICAgIClcclxuICAgICAgKSxcclxuICAgICAgdGFwKChbLCBsb2FkaW5nU3RhdGVdKSA9PiB7XHJcbiAgICAgICAgaWYgKFxyXG4gICAgICAgICAgIShsb2FkaW5nU3RhdGUubG9hZGluZyB8fCBsb2FkaW5nU3RhdGUuc3VjY2VzcyB8fCBsb2FkaW5nU3RhdGUuZXJyb3IpXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICB0aGlzLmxvYWRTdXBwb3J0ZWREZWxpdmVyeU1vZGVzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgICAgcGx1Y2soMCksXHJcbiAgICAgIHNoYXJlUmVwbGF5KHsgYnVmZmVyU2l6ZTogMSwgcmVmQ291bnQ6IHRydWUgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXQgc2VsZWN0ZWQgZGVsaXZlcnkgbW9kZVxyXG4gICAqL1xyXG4gIGdldFNlbGVjdGVkRGVsaXZlcnlNb2RlKCk6IE9ic2VydmFibGU8RGVsaXZlcnlNb2RlPiB7XHJcbiAgICByZXR1cm4gdGhpcy5jaGVja291dFN0b3JlLnBpcGUoXHJcbiAgICAgIHNlbGVjdChDaGVja291dFNlbGVjdG9ycy5nZXRTZWxlY3RlZERlbGl2ZXJ5TW9kZSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXQgc2VsZWN0ZWQgZGVsaXZlcnkgbW9kZSBjb2RlXHJcbiAgICovXHJcbiAgZ2V0U2VsZWN0ZWREZWxpdmVyeU1vZGVDb2RlKCk6IE9ic2VydmFibGU8c3RyaW5nPiB7XHJcbiAgICByZXR1cm4gdGhpcy5jaGVja291dFN0b3JlLnBpcGUoXHJcbiAgICAgIHNlbGVjdChDaGVja291dFNlbGVjdG9ycy5nZXRTZWxlY3RlZERlbGl2ZXJ5TW9kZUNvZGUpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IGRlbGl2ZXJ5IGFkZHJlc3NcclxuICAgKi9cclxuICBnZXREZWxpdmVyeUFkZHJlc3MoKTogT2JzZXJ2YWJsZTxBZGRyZXNzPiB7XHJcbiAgICByZXR1cm4gdGhpcy5jaGVja291dFN0b3JlLnBpcGUoXHJcbiAgICAgIHNlbGVjdChDaGVja291dFNlbGVjdG9ycy5nZXREZWxpdmVyeUFkZHJlc3MpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0IHN0YXR1cyBhYm91dCBzdWNjZXNzZnVsbHkgc2V0IERlbGl2ZXJ5IEFkZHJlc3NcclxuICAgKi9cclxuICBnZXRTZXREZWxpdmVyeUFkZHJlc3NQcm9jZXNzKCk6IE9ic2VydmFibGU8TG9hZGVyU3RhdGU8dm9pZD4+IHtcclxuICAgIHJldHVybiB0aGlzLmNoZWNrb3V0U3RvcmUucGlwZShcclxuICAgICAgc2VsZWN0KGdldFByb2Nlc3NTdGF0ZUZhY3RvcnkoU0VUX0RFTElWRVJZX0FERFJFU1NfUFJPQ0VTU19JRCkpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2xlYXIgaW5mbyBhYm91dCBwcm9jZXNzIG9mIHNldHRpbmcgRGVsaXZlcnkgQWRkcmVzc1xyXG4gICAqL1xyXG4gIHJlc2V0U2V0RGVsaXZlcnlBZGRyZXNzUHJvY2VzcygpOiB2b2lkIHtcclxuICAgIHRoaXMuY2hlY2tvdXRTdG9yZS5kaXNwYXRjaChcclxuICAgICAgbmV3IENoZWNrb3V0QWN0aW9ucy5SZXNldFNldERlbGl2ZXJ5QWRkcmVzc1Byb2Nlc3MoKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCBzdGF0dXMgYWJvdXQgb2Ygc2V0IERlbGl2ZXJ5IE1vZGUgcHJvY2Vzc1xyXG4gICAqL1xyXG4gIGdldFNldERlbGl2ZXJ5TW9kZVByb2Nlc3MoKTogT2JzZXJ2YWJsZTxMb2FkZXJTdGF0ZTx2b2lkPj4ge1xyXG4gICAgcmV0dXJuIHRoaXMuY2hlY2tvdXRTdG9yZS5waXBlKFxyXG4gICAgICBzZWxlY3QoZ2V0UHJvY2Vzc1N0YXRlRmFjdG9yeShTRVRfREVMSVZFUllfTU9ERV9QUk9DRVNTX0lEKSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDbGVhciBpbmZvIGFib3V0IHByb2Nlc3Mgb2Ygc2V0dGluZyBEZWxpdmVyeSBNb2RlXHJcbiAgICovXHJcbiAgcmVzZXRTZXREZWxpdmVyeU1vZGVQcm9jZXNzKCk6IHZvaWQge1xyXG4gICAgdGhpcy5jaGVja291dFN0b3JlLmRpc3BhdGNoKFxyXG4gICAgICBuZXcgQ2hlY2tvdXRBY3Rpb25zLlJlc2V0U2V0RGVsaXZlcnlNb2RlUHJvY2VzcygpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2xlYXIgaW5mbyBhYm91dCBwcm9jZXNzIG9mIHNldHRpbmcgU3VwcG9ydGVkIERlbGl2ZXJ5IE1vZGVzXHJcbiAgICovXHJcbiAgcmVzZXRMb2FkU3VwcG9ydGVkRGVsaXZlcnlNb2Rlc1Byb2Nlc3MoKTogdm9pZCB7XHJcbiAgICB0aGlzLmNoZWNrb3V0U3RvcmUuZGlzcGF0Y2goXHJcbiAgICAgIG5ldyBDaGVja291dEFjdGlvbnMuUmVzZXRMb2FkU3VwcG9ydGVkRGVsaXZlcnlNb2Rlc1Byb2Nlc3MoKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCBzdGF0dXMgYWJvdXQgb2Ygc2V0IHN1cHBvcnRlZCBEZWxpdmVyeSBNb2RlcyBwcm9jZXNzXHJcbiAgICovXHJcbiAgZ2V0TG9hZFN1cHBvcnRlZERlbGl2ZXJ5TW9kZVByb2Nlc3MoKTogT2JzZXJ2YWJsZTxMb2FkZXJTdGF0ZTx2b2lkPj4ge1xyXG4gICAgcmV0dXJuIHRoaXMuY2hlY2tvdXRTdG9yZS5waXBlKFxyXG4gICAgICBzZWxlY3QoZ2V0UHJvY2Vzc1N0YXRlRmFjdG9yeShTRVRfU1VQUE9SVEVEX0RFTElWRVJZX01PREVfUFJPQ0VTU19JRCkpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2xlYXIgc3VwcG9ydGVkIGRlbGl2ZXJ5IG1vZGVzIGxvYWRlZCBpbiBsYXN0IGNoZWNrb3V0IHByb2Nlc3NcclxuICAgKi9cclxuICBjbGVhckNoZWNrb3V0RGVsaXZlcnlNb2RlcygpOiB2b2lkIHtcclxuICAgIHRoaXMuY2hlY2tvdXRTdG9yZS5kaXNwYXRjaChcclxuICAgICAgbmV3IENoZWNrb3V0QWN0aW9ucy5DbGVhclN1cHBvcnRlZERlbGl2ZXJ5TW9kZXMoKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCBhZGRyZXNzIHZlcmlmaWNhdGlvbiByZXN1bHRzXHJcbiAgICovXHJcbiAgZ2V0QWRkcmVzc1ZlcmlmaWNhdGlvblJlc3VsdHMoKTogT2JzZXJ2YWJsZTxBZGRyZXNzVmFsaWRhdGlvbiB8IHN0cmluZz4ge1xyXG4gICAgcmV0dXJuIHRoaXMuY2hlY2tvdXRTdG9yZS5waXBlKFxyXG4gICAgICBzZWxlY3QoQ2hlY2tvdXRTZWxlY3RvcnMuZ2V0QWRkcmVzc1ZlcmlmaWNhdGlvblJlc3VsdHMpLFxyXG4gICAgICBmaWx0ZXIoKHJlc3VsdHMpID0+IE9iamVjdC5rZXlzKHJlc3VsdHMpLmxlbmd0aCAhPT0gMClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDcmVhdGUgYW5kIHNldCBhIGRlbGl2ZXJ5IGFkZHJlc3MgdXNpbmcgdGhlIGFkZHJlc3MgcGFyYW1cclxuICAgKiBAcGFyYW0gYWRkcmVzcyA6IHRoZSBBZGRyZXNzIHRvIGJlIGNyZWF0ZWQgYW5kIHNldFxyXG4gICAqL1xyXG4gIGNyZWF0ZUFuZFNldEFkZHJlc3MoYWRkcmVzczogQWRkcmVzcyk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMuYWN0aW9uQWxsb3dlZCgpKSB7XHJcbiAgICAgIGxldCB1c2VySWQ7XHJcbiAgICAgIHRoaXMuYXV0aFNlcnZpY2VcclxuICAgICAgICAuZ2V0T2NjVXNlcklkKClcclxuICAgICAgICAuc3Vic2NyaWJlKChvY2NVc2VySWQpID0+ICh1c2VySWQgPSBvY2NVc2VySWQpKVxyXG4gICAgICAgIC51bnN1YnNjcmliZSgpO1xyXG5cclxuICAgICAgbGV0IGNhcnRJZDtcclxuICAgICAgdGhpcy5hY3RpdmVDYXJ0U2VydmljZVxyXG4gICAgICAgIC5nZXRBY3RpdmVDYXJ0SWQoKVxyXG4gICAgICAgIC5zdWJzY3JpYmUoKGFjdGl2ZUNhcnRJZCkgPT4gKGNhcnRJZCA9IGFjdGl2ZUNhcnRJZCkpXHJcbiAgICAgICAgLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgIGlmICh1c2VySWQgJiYgY2FydElkKSB7XHJcbiAgICAgICAgdGhpcy5jaGVja291dFN0b3JlLmRpc3BhdGNoKFxyXG4gICAgICAgICAgbmV3IENoZWNrb3V0QWN0aW9ucy5BZGREZWxpdmVyeUFkZHJlc3Moe1xyXG4gICAgICAgICAgICB1c2VySWQsXHJcbiAgICAgICAgICAgIGNhcnRJZCxcclxuICAgICAgICAgICAgYWRkcmVzczogYWRkcmVzcyxcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTG9hZCBzdXBwb3J0ZWQgZGVsaXZlcnkgbW9kZXNcclxuICAgKi9cclxuICBsb2FkU3VwcG9ydGVkRGVsaXZlcnlNb2RlcygpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmFjdGlvbkFsbG93ZWQoKSkge1xyXG4gICAgICBsZXQgdXNlcklkO1xyXG4gICAgICB0aGlzLmF1dGhTZXJ2aWNlXHJcbiAgICAgICAgLmdldE9jY1VzZXJJZCgpXHJcbiAgICAgICAgLnN1YnNjcmliZSgob2NjVXNlcklkKSA9PiAodXNlcklkID0gb2NjVXNlcklkKSlcclxuICAgICAgICAudW5zdWJzY3JpYmUoKTtcclxuXHJcbiAgICAgIGxldCBjYXJ0SWQ7XHJcbiAgICAgIHRoaXMuYWN0aXZlQ2FydFNlcnZpY2VcclxuICAgICAgICAuZ2V0QWN0aXZlQ2FydElkKClcclxuICAgICAgICAuc3Vic2NyaWJlKChhY3RpdmVDYXJ0SWQpID0+IChjYXJ0SWQgPSBhY3RpdmVDYXJ0SWQpKVxyXG4gICAgICAgIC51bnN1YnNjcmliZSgpO1xyXG4gICAgICBpZiAodXNlcklkICYmIGNhcnRJZCkge1xyXG4gICAgICAgIHRoaXMuY2hlY2tvdXRTdG9yZS5kaXNwYXRjaChcclxuICAgICAgICAgIG5ldyBDaGVja291dEFjdGlvbnMuTG9hZFN1cHBvcnRlZERlbGl2ZXJ5TW9kZXMoe1xyXG4gICAgICAgICAgICB1c2VySWQsXHJcbiAgICAgICAgICAgIGNhcnRJZCxcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2V0IGRlbGl2ZXJ5IG1vZGVcclxuICAgKiBAcGFyYW0gbW9kZSA6IFRoZSBkZWxpdmVyeSBtb2RlIHRvIGJlIHNldFxyXG4gICAqL1xyXG4gIHNldERlbGl2ZXJ5TW9kZShtb2RlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmFjdGlvbkFsbG93ZWQoKSkge1xyXG4gICAgICBsZXQgdXNlcklkO1xyXG4gICAgICB0aGlzLmF1dGhTZXJ2aWNlXHJcbiAgICAgICAgLmdldE9jY1VzZXJJZCgpXHJcbiAgICAgICAgLnN1YnNjcmliZSgob2NjVXNlcklkKSA9PiAodXNlcklkID0gb2NjVXNlcklkKSlcclxuICAgICAgICAudW5zdWJzY3JpYmUoKTtcclxuXHJcbiAgICAgIGxldCBjYXJ0SWQ7XHJcbiAgICAgIHRoaXMuYWN0aXZlQ2FydFNlcnZpY2VcclxuICAgICAgICAuZ2V0QWN0aXZlQ2FydElkKClcclxuICAgICAgICAuc3Vic2NyaWJlKChhY3RpdmVDYXJ0SWQpID0+IChjYXJ0SWQgPSBhY3RpdmVDYXJ0SWQpKVxyXG4gICAgICAgIC51bnN1YnNjcmliZSgpO1xyXG4gICAgICBpZiAodXNlcklkICYmIGNhcnRJZCkge1xyXG4gICAgICAgIHRoaXMuY2hlY2tvdXRTdG9yZS5kaXNwYXRjaChcclxuICAgICAgICAgIG5ldyBDaGVja291dEFjdGlvbnMuU2V0RGVsaXZlcnlNb2RlKHtcclxuICAgICAgICAgICAgdXNlcklkLFxyXG4gICAgICAgICAgICBjYXJ0SWQsXHJcbiAgICAgICAgICAgIHNlbGVjdGVkTW9kZUlkOiBtb2RlLFxyXG4gICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBWZXJpZmllcyB0aGUgYWRkcmVzc1xyXG4gICAqIEBwYXJhbSBhZGRyZXNzIDogdGhlIGFkZHJlc3MgdG8gYmUgdmVyaWZpZWRcclxuICAgKi9cclxuICB2ZXJpZnlBZGRyZXNzKGFkZHJlc3M6IEFkZHJlc3MpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmFjdGlvbkFsbG93ZWQoKSkge1xyXG4gICAgICBsZXQgdXNlcklkO1xyXG4gICAgICB0aGlzLmF1dGhTZXJ2aWNlXHJcbiAgICAgICAgLmdldE9jY1VzZXJJZCgpXHJcbiAgICAgICAgLnN1YnNjcmliZSgob2NjVXNlcklkKSA9PiAodXNlcklkID0gb2NjVXNlcklkKSlcclxuICAgICAgICAudW5zdWJzY3JpYmUoKTtcclxuICAgICAgaWYgKHVzZXJJZCkge1xyXG4gICAgICAgIHRoaXMuY2hlY2tvdXRTdG9yZS5kaXNwYXRjaChcclxuICAgICAgICAgIG5ldyBDaGVja291dEFjdGlvbnMuVmVyaWZ5QWRkcmVzcyh7XHJcbiAgICAgICAgICAgIHVzZXJJZCxcclxuICAgICAgICAgICAgYWRkcmVzcyxcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2V0IGRlbGl2ZXJ5IGFkZHJlc3NcclxuICAgKiBAcGFyYW0gYWRkcmVzcyA6IFRoZSBhZGRyZXNzIHRvIGJlIHNldFxyXG4gICAqL1xyXG4gIHNldERlbGl2ZXJ5QWRkcmVzcyhhZGRyZXNzOiBBZGRyZXNzKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5hY3Rpb25BbGxvd2VkKCkpIHtcclxuICAgICAgbGV0IHVzZXJJZDtcclxuICAgICAgdGhpcy5hdXRoU2VydmljZVxyXG4gICAgICAgIC5nZXRPY2NVc2VySWQoKVxyXG4gICAgICAgIC5zdWJzY3JpYmUoKG9jY1VzZXJJZCkgPT4gKHVzZXJJZCA9IG9jY1VzZXJJZCkpXHJcbiAgICAgICAgLnVuc3Vic2NyaWJlKCk7XHJcblxyXG4gICAgICBsZXQgY2FydElkO1xyXG4gICAgICB0aGlzLmFjdGl2ZUNhcnRTZXJ2aWNlXHJcbiAgICAgICAgLmdldEFjdGl2ZUNhcnRJZCgpXHJcbiAgICAgICAgLnN1YnNjcmliZSgoYWN0aXZlQ2FydElkKSA9PiAoY2FydElkID0gYWN0aXZlQ2FydElkKSlcclxuICAgICAgICAudW5zdWJzY3JpYmUoKTtcclxuICAgICAgaWYgKGNhcnRJZCAmJiB1c2VySWQpIHtcclxuICAgICAgICB0aGlzLmNoZWNrb3V0U3RvcmUuZGlzcGF0Y2goXHJcbiAgICAgICAgICBuZXcgQ2hlY2tvdXRBY3Rpb25zLlNldERlbGl2ZXJ5QWRkcmVzcyh7XHJcbiAgICAgICAgICAgIHVzZXJJZCxcclxuICAgICAgICAgICAgY2FydElkLFxyXG4gICAgICAgICAgICBhZGRyZXNzOiBhZGRyZXNzLFxyXG4gICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDbGVhciBhZGRyZXNzIHZlcmlmaWNhdGlvbiByZXN1bHRzXHJcbiAgICovXHJcbiAgY2xlYXJBZGRyZXNzVmVyaWZpY2F0aW9uUmVzdWx0cygpOiB2b2lkIHtcclxuICAgIHRoaXMuY2hlY2tvdXRTdG9yZS5kaXNwYXRjaChcclxuICAgICAgbmV3IENoZWNrb3V0QWN0aW9ucy5DbGVhckFkZHJlc3NWZXJpZmljYXRpb25SZXN1bHRzKClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDbGVhciBhZGRyZXNzIGFscmVhZHkgc2V0dXAgaW4gbGFzdCBjaGVja291dCBwcm9jZXNzXHJcbiAgICovXHJcbiAgY2xlYXJDaGVja291dERlbGl2ZXJ5QWRkcmVzcygpOiB2b2lkIHtcclxuICAgIGxldCB1c2VySWQ7XHJcbiAgICB0aGlzLmF1dGhTZXJ2aWNlXHJcbiAgICAgIC5nZXRPY2NVc2VySWQoKVxyXG4gICAgICAuc3Vic2NyaWJlKChvY2NVc2VySWQpID0+ICh1c2VySWQgPSBvY2NVc2VySWQpKVxyXG4gICAgICAudW5zdWJzY3JpYmUoKTtcclxuXHJcbiAgICBsZXQgY2FydElkO1xyXG4gICAgdGhpcy5hY3RpdmVDYXJ0U2VydmljZVxyXG4gICAgICAuZ2V0QWN0aXZlQ2FydElkKClcclxuICAgICAgLnN1YnNjcmliZSgoYWN0aXZlQ2FydElkKSA9PiAoY2FydElkID0gYWN0aXZlQ2FydElkKSlcclxuICAgICAgLnVuc3Vic2NyaWJlKCk7XHJcbiAgICBpZiAodXNlcklkICYmIGNhcnRJZCkge1xyXG4gICAgICB0aGlzLmNoZWNrb3V0U3RvcmUuZGlzcGF0Y2goXHJcbiAgICAgICAgbmV3IENoZWNrb3V0QWN0aW9ucy5DbGVhckNoZWNrb3V0RGVsaXZlcnlBZGRyZXNzKHtcclxuICAgICAgICAgIHVzZXJJZCxcclxuICAgICAgICAgIGNhcnRJZCxcclxuICAgICAgICB9KVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2xlYXIgc2VsZWN0ZWQgZGVsaXZlcnkgbW9kZSBzZXR1cCBpbiBsYXN0IGNoZWNrb3V0IHByb2Nlc3NcclxuICAgKi9cclxuICBjbGVhckNoZWNrb3V0RGVsaXZlcnlNb2RlKCk6IHZvaWQge1xyXG4gICAgbGV0IHVzZXJJZDtcclxuICAgIHRoaXMuYXV0aFNlcnZpY2VcclxuICAgICAgLmdldE9jY1VzZXJJZCgpXHJcbiAgICAgIC5zdWJzY3JpYmUoKG9jY1VzZXJJZCkgPT4gKHVzZXJJZCA9IG9jY1VzZXJJZCkpXHJcbiAgICAgIC51bnN1YnNjcmliZSgpO1xyXG5cclxuICAgIGxldCBjYXJ0SWQ7XHJcbiAgICB0aGlzLmFjdGl2ZUNhcnRTZXJ2aWNlXHJcbiAgICAgIC5nZXRBY3RpdmVDYXJ0SWQoKVxyXG4gICAgICAuc3Vic2NyaWJlKChhY3RpdmVDYXJ0SWQpID0+IChjYXJ0SWQgPSBhY3RpdmVDYXJ0SWQpKVxyXG4gICAgICAudW5zdWJzY3JpYmUoKTtcclxuICAgIGlmICh1c2VySWQgJiYgY2FydElkKSB7XHJcbiAgICAgIHRoaXMuY2hlY2tvdXRTdG9yZS5kaXNwYXRjaChcclxuICAgICAgICBuZXcgQ2hlY2tvdXRBY3Rpb25zLkNsZWFyQ2hlY2tvdXREZWxpdmVyeU1vZGUoe1xyXG4gICAgICAgICAgdXNlcklkLFxyXG4gICAgICAgICAgY2FydElkLFxyXG4gICAgICAgIH0pXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDbGVhciBhZGRyZXNzIGFuZCBkZWxpdmVyeSBtb2RlIGFscmVhZHkgc2V0dXAgaW4gbGFzdCBjaGVja291dCBwcm9jZXNzXHJcbiAgICovXHJcbiAgY2xlYXJDaGVja291dERlbGl2ZXJ5RGV0YWlscygpOiB2b2lkIHtcclxuICAgIHRoaXMuY2xlYXJDaGVja291dERlbGl2ZXJ5QWRkcmVzcygpO1xyXG4gICAgdGhpcy5jbGVhckNoZWNrb3V0RGVsaXZlcnlNb2RlKCk7XHJcbiAgICB0aGlzLmNsZWFyQ2hlY2tvdXREZWxpdmVyeU1vZGVzKCk7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgYWN0aW9uQWxsb3dlZCgpOiBib29sZWFuIHtcclxuICAgIGxldCB1c2VySWQ7XHJcbiAgICB0aGlzLmF1dGhTZXJ2aWNlXHJcbiAgICAgIC5nZXRPY2NVc2VySWQoKVxyXG4gICAgICAuc3Vic2NyaWJlKChvY2NVc2VySWQpID0+ICh1c2VySWQgPSBvY2NVc2VySWQpKVxyXG4gICAgICAudW5zdWJzY3JpYmUoKTtcclxuICAgIHJldHVybiAoXHJcbiAgICAgICh1c2VySWQgJiYgdXNlcklkICE9PSBPQ0NfVVNFUl9JRF9BTk9OWU1PVVMpIHx8XHJcbiAgICAgIHRoaXMuYWN0aXZlQ2FydFNlcnZpY2UuaXNHdWVzdENhcnQoKVxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuIl19
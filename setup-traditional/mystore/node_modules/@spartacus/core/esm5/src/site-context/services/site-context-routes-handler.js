import { __decorate } from "tslib";
import { Location } from '@angular/common';
import { Injectable, Injector, OnDestroy } from '@angular/core';
import { NavigationCancel, NavigationEnd, NavigationError, NavigationStart, Router, } from '@angular/router';
import { Subscription } from 'rxjs';
import { filter } from 'rxjs/operators';
import { SiteContextParamsService } from './site-context-params.service';
import { SiteContextUrlSerializer } from './site-context-url-serializer';
import * as i0 from "@angular/core";
import * as i1 from "./site-context-params.service";
import * as i2 from "./site-context-url-serializer";
var SiteContextRoutesHandler = /** @class */ (function () {
    function SiteContextRoutesHandler(siteContextParams, serializer, injector) {
        this.siteContextParams = siteContextParams;
        this.serializer = serializer;
        this.injector = injector;
        this.subscription = new Subscription();
        this.contextValues = {};
        /**
         * Tells whether there is a pending navigation at the moment, so we can avoid an infinite loop caused by the cyclic dependency:
         * - `subscribeChanges` method triggers a navigation on update of site context state
         * - `subscribeRouting` method updates the site context state on navigation
         */
        this.isNavigating = false;
    }
    /**
     * Initializes the two-way synchronization between the site context state and the URL.
     *
     * @returns Promise that is resolved when the site context state is initialized (updated for the first time) based on the URL.
     */
    SiteContextRoutesHandler.prototype.init = function () {
        var _this = this;
        return new Promise(function (resolve) {
            _this.router = _this.injector.get(Router);
            _this.location = _this.injector.get(Location);
            var routingParams = _this.siteContextParams.getUrlEncodingParameters();
            if (routingParams.length) {
                _this.subscribeChanges(routingParams);
                _this.subscribeRouting(resolve);
            }
            else {
                resolve();
            }
        });
    };
    /**
     * After each change of the site context state, it modifies the current URL in place.
     * But it happens only for the parameters configured to be persisted in the URL.
     */
    SiteContextRoutesHandler.prototype.subscribeChanges = function (params) {
        var _this = this;
        params.forEach(function (param) {
            var service = _this.siteContextParams.getSiteContextService(param);
            if (service) {
                _this.subscription.add(service.getActive().subscribe(function (value) {
                    if (!_this.isNavigating &&
                        _this.contextValues[param] &&
                        _this.contextValues[param] !== value) {
                        var parsed = _this.router.parseUrl(_this.router.url);
                        var serialized = _this.router.serializeUrl(parsed);
                        _this.location.replaceState(serialized);
                    }
                    _this.contextValues[param] = value;
                }));
            }
        });
    };
    /**
     * After each Angular NavigationStart event it updates the site context state based on
     * site context params encoded in the anticipated URL.
     *
     * In particular, it's responsible for initializing the state of the context params
     * on page start, reading the values from the URL.
     *
     * @param onContextInitialized notify that the initialization of the context was done based on the URL
     */
    SiteContextRoutesHandler.prototype.subscribeRouting = function (onContextInitialized) {
        var _this = this;
        var contextInitialized = false;
        this.subscription.add(this.router.events
            .pipe(filter(function (event) {
            return event instanceof NavigationStart ||
                event instanceof NavigationEnd ||
                event instanceof NavigationError ||
                event instanceof NavigationCancel;
        }))
            .subscribe(function (event) {
            _this.isNavigating = event instanceof NavigationStart;
            if (_this.isNavigating) {
                _this.setContextParamsFromRoute(event.url);
                if (!contextInitialized) {
                    contextInitialized = true;
                    onContextInitialized();
                }
            }
        }));
    };
    /**
     * Updates the site context state based on the context params encoded in the given URL
     *
     * @param url URL with encoded context params
     */
    SiteContextRoutesHandler.prototype.setContextParamsFromRoute = function (url) {
        var _this = this;
        var params = this.serializer.urlExtractContextParameters(url).params;
        Object.keys(params).forEach(function (param) {
            return _this.siteContextParams.setValue(param, params[param]);
        });
    };
    SiteContextRoutesHandler.prototype.ngOnDestroy = function () {
        this.subscription.unsubscribe();
    };
    SiteContextRoutesHandler.ctorParameters = function () { return [
        { type: SiteContextParamsService },
        { type: SiteContextUrlSerializer },
        { type: Injector }
    ]; };
    SiteContextRoutesHandler.ɵprov = i0.ɵɵdefineInjectable({ factory: function SiteContextRoutesHandler_Factory() { return new SiteContextRoutesHandler(i0.ɵɵinject(i1.SiteContextParamsService), i0.ɵɵinject(i2.SiteContextUrlSerializer), i0.ɵɵinject(i0.INJECTOR)); }, token: SiteContextRoutesHandler, providedIn: "root" });
    SiteContextRoutesHandler = __decorate([
        Injectable({
            providedIn: 'root',
        })
    ], SiteContextRoutesHandler);
    return SiteContextRoutesHandler;
}());
export { SiteContextRoutesHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2l0ZS1jb250ZXh0LXJvdXRlcy1oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHNwYXJ0YWN1cy9jb3JlLyIsInNvdXJjZXMiOlsic3JjL3NpdGUtY29udGV4dC9zZXJ2aWNlcy9zaXRlLWNvbnRleHQtcm91dGVzLWhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDaEUsT0FBTyxFQUNMLGdCQUFnQixFQUNoQixhQUFhLEVBQ2IsZUFBZSxFQUNmLGVBQWUsRUFDZixNQUFNLEdBRVAsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQzs7OztBQUt6RTtJQUNFLGtDQUNVLGlCQUEyQyxFQUMzQyxVQUFvQyxFQUNwQyxRQUFrQjtRQUZsQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQTBCO1FBQzNDLGVBQVUsR0FBVixVQUFVLENBQTBCO1FBQ3BDLGFBQVEsR0FBUixRQUFRLENBQVU7UUFHcEIsaUJBQVksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBRWxDLGtCQUFhLEdBRWpCLEVBQUUsQ0FBQztRQUtQOzs7O1dBSUc7UUFDSyxpQkFBWSxHQUFHLEtBQUssQ0FBQztJQWhCMUIsQ0FBQztJQWtCSjs7OztPQUlHO0lBQ0gsdUNBQUksR0FBSjtRQUFBLGlCQWNDO1FBYkMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU87WUFDekIsS0FBSSxDQUFDLE1BQU0sR0FB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LEtBQUs7WUFDaEMsT0FBQSxLQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFBckQsQ0FBcUQsQ0FDdEQsQ0FBQztJQUNKLENBQUM7SUFFRCw4Q0FBVyxHQUFYO1FBQ0UsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNsQyxDQUFDOztnQkF2SDRCLHdCQUF3QjtnQkFDL0Isd0JBQXdCO2dCQUMxQixRQUFROzs7SUFKakIsd0JBQXdCO1FBSHBDLFVBQVUsQ0FBQztZQUNWLFVBQVUsRUFBRSxNQUFNO1NBQ25CLENBQUM7T0FDVyx3QkFBd0IsQ0EwSHBDO21DQTVJRDtDQTRJQyxBQTFIRCxJQTBIQztTQTFIWSx3QkFBd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMb2NhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcbmltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtcclxuICBOYXZpZ2F0aW9uQ2FuY2VsLFxyXG4gIE5hdmlnYXRpb25FbmQsXHJcbiAgTmF2aWdhdGlvbkVycm9yLFxyXG4gIE5hdmlnYXRpb25TdGFydCxcclxuICBSb3V0ZXIsXHJcbiAgUm91dGVyRXZlbnQsXHJcbn0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcclxuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgU2l0ZUNvbnRleHRQYXJhbXNTZXJ2aWNlIH0gZnJvbSAnLi9zaXRlLWNvbnRleHQtcGFyYW1zLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBTaXRlQ29udGV4dFVybFNlcmlhbGl6ZXIgfSBmcm9tICcuL3NpdGUtY29udGV4dC11cmwtc2VyaWFsaXplcic7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgU2l0ZUNvbnRleHRSb3V0ZXNIYW5kbGVyIGltcGxlbWVudHMgT25EZXN0cm95IHtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgc2l0ZUNvbnRleHRQYXJhbXM6IFNpdGVDb250ZXh0UGFyYW1zU2VydmljZSxcclxuICAgIHByaXZhdGUgc2VyaWFsaXplcjogU2l0ZUNvbnRleHRVcmxTZXJpYWxpemVyLFxyXG4gICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3JcclxuICApIHt9XHJcblxyXG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigpO1xyXG5cclxuICBwcml2YXRlIGNvbnRleHRWYWx1ZXM6IHtcclxuICAgIFtwYXJhbTogc3RyaW5nXTogc3RyaW5nO1xyXG4gIH0gPSB7fTtcclxuXHJcbiAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcjtcclxuICBwcml2YXRlIGxvY2F0aW9uOiBMb2NhdGlvbjtcclxuXHJcbiAgLyoqXHJcbiAgICogVGVsbHMgd2hldGhlciB0aGVyZSBpcyBhIHBlbmRpbmcgbmF2aWdhdGlvbiBhdCB0aGUgbW9tZW50LCBzbyB3ZSBjYW4gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCBjYXVzZWQgYnkgdGhlIGN5Y2xpYyBkZXBlbmRlbmN5OlxyXG4gICAqIC0gYHN1YnNjcmliZUNoYW5nZXNgIG1ldGhvZCB0cmlnZ2VycyBhIG5hdmlnYXRpb24gb24gdXBkYXRlIG9mIHNpdGUgY29udGV4dCBzdGF0ZVxyXG4gICAqIC0gYHN1YnNjcmliZVJvdXRpbmdgIG1ldGhvZCB1cGRhdGVzIHRoZSBzaXRlIGNvbnRleHQgc3RhdGUgb24gbmF2aWdhdGlvblxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNOYXZpZ2F0aW5nID0gZmFsc2U7XHJcblxyXG4gIC8qKlxyXG4gICAqIEluaXRpYWxpemVzIHRoZSB0d28td2F5IHN5bmNocm9uaXphdGlvbiBiZXR3ZWVuIHRoZSBzaXRlIGNvbnRleHQgc3RhdGUgYW5kIHRoZSBVUkwuXHJcbiAgICpcclxuICAgKiBAcmV0dXJucyBQcm9taXNlIHRoYXQgaXMgcmVzb2x2ZWQgd2hlbiB0aGUgc2l0ZSBjb250ZXh0IHN0YXRlIGlzIGluaXRpYWxpemVkICh1cGRhdGVkIGZvciB0aGUgZmlyc3QgdGltZSkgYmFzZWQgb24gdGhlIFVSTC5cclxuICAgKi9cclxuICBpbml0KCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XHJcbiAgICAgIHRoaXMucm91dGVyID0gdGhpcy5pbmplY3Rvci5nZXQ8Um91dGVyPihSb3V0ZXIpO1xyXG5cclxuICAgICAgdGhpcy5sb2NhdGlvbiA9IHRoaXMuaW5qZWN0b3IuZ2V0PExvY2F0aW9uPihMb2NhdGlvbik7XHJcbiAgICAgIGNvbnN0IHJvdXRpbmdQYXJhbXMgPSB0aGlzLnNpdGVDb250ZXh0UGFyYW1zLmdldFVybEVuY29kaW5nUGFyYW1ldGVycygpO1xyXG5cclxuICAgICAgaWYgKHJvdXRpbmdQYXJhbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgdGhpcy5zdWJzY3JpYmVDaGFuZ2VzKHJvdXRpbmdQYXJhbXMpO1xyXG4gICAgICAgIHRoaXMuc3Vic2NyaWJlUm91dGluZyhyZXNvbHZlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWZ0ZXIgZWFjaCBjaGFuZ2Ugb2YgdGhlIHNpdGUgY29udGV4dCBzdGF0ZSwgaXQgbW9kaWZpZXMgdGhlIGN1cnJlbnQgVVJMIGluIHBsYWNlLlxyXG4gICAqIEJ1dCBpdCBoYXBwZW5zIG9ubHkgZm9yIHRoZSBwYXJhbWV0ZXJzIGNvbmZpZ3VyZWQgdG8gYmUgcGVyc2lzdGVkIGluIHRoZSBVUkwuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdWJzY3JpYmVDaGFuZ2VzKHBhcmFtczogc3RyaW5nW10pIHtcclxuICAgIHBhcmFtcy5mb3JFYWNoKChwYXJhbSkgPT4ge1xyXG4gICAgICBjb25zdCBzZXJ2aWNlID0gdGhpcy5zaXRlQ29udGV4dFBhcmFtcy5nZXRTaXRlQ29udGV4dFNlcnZpY2UocGFyYW0pO1xyXG4gICAgICBpZiAoc2VydmljZSkge1xyXG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZChcclxuICAgICAgICAgIHNlcnZpY2UuZ2V0QWN0aXZlKCkuc3Vic2NyaWJlKCh2YWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgICAgIXRoaXMuaXNOYXZpZ2F0aW5nICYmXHJcbiAgICAgICAgICAgICAgdGhpcy5jb250ZXh0VmFsdWVzW3BhcmFtXSAmJlxyXG4gICAgICAgICAgICAgIHRoaXMuY29udGV4dFZhbHVlc1twYXJhbV0gIT09IHZhbHVlXHJcbiAgICAgICAgICAgICkge1xyXG4gICAgICAgICAgICAgIGNvbnN0IHBhcnNlZCA9IHRoaXMucm91dGVyLnBhcnNlVXJsKHRoaXMucm91dGVyLnVybCk7XHJcbiAgICAgICAgICAgICAgY29uc3Qgc2VyaWFsaXplZCA9IHRoaXMucm91dGVyLnNlcmlhbGl6ZVVybChwYXJzZWQpO1xyXG4gICAgICAgICAgICAgIHRoaXMubG9jYXRpb24ucmVwbGFjZVN0YXRlKHNlcmlhbGl6ZWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuY29udGV4dFZhbHVlc1twYXJhbV0gPSB2YWx1ZTtcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBZnRlciBlYWNoIEFuZ3VsYXIgTmF2aWdhdGlvblN0YXJ0IGV2ZW50IGl0IHVwZGF0ZXMgdGhlIHNpdGUgY29udGV4dCBzdGF0ZSBiYXNlZCBvblxyXG4gICAqIHNpdGUgY29udGV4dCBwYXJhbXMgZW5jb2RlZCBpbiB0aGUgYW50aWNpcGF0ZWQgVVJMLlxyXG4gICAqXHJcbiAgICogSW4gcGFydGljdWxhciwgaXQncyByZXNwb25zaWJsZSBmb3IgaW5pdGlhbGl6aW5nIHRoZSBzdGF0ZSBvZiB0aGUgY29udGV4dCBwYXJhbXNcclxuICAgKiBvbiBwYWdlIHN0YXJ0LCByZWFkaW5nIHRoZSB2YWx1ZXMgZnJvbSB0aGUgVVJMLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIG9uQ29udGV4dEluaXRpYWxpemVkIG5vdGlmeSB0aGF0IHRoZSBpbml0aWFsaXphdGlvbiBvZiB0aGUgY29udGV4dCB3YXMgZG9uZSBiYXNlZCBvbiB0aGUgVVJMXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdWJzY3JpYmVSb3V0aW5nKG9uQ29udGV4dEluaXRpYWxpemVkOiBGdW5jdGlvbikge1xyXG4gICAgbGV0IGNvbnRleHRJbml0aWFsaXplZCA9IGZhbHNlO1xyXG5cclxuICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZChcclxuICAgICAgdGhpcy5yb3V0ZXIuZXZlbnRzXHJcbiAgICAgICAgLnBpcGUoXHJcbiAgICAgICAgICBmaWx0ZXIoXHJcbiAgICAgICAgICAgIChldmVudCkgPT5cclxuICAgICAgICAgICAgICBldmVudCBpbnN0YW5jZW9mIE5hdmlnYXRpb25TdGFydCB8fFxyXG4gICAgICAgICAgICAgIGV2ZW50IGluc3RhbmNlb2YgTmF2aWdhdGlvbkVuZCB8fFxyXG4gICAgICAgICAgICAgIGV2ZW50IGluc3RhbmNlb2YgTmF2aWdhdGlvbkVycm9yIHx8XHJcbiAgICAgICAgICAgICAgZXZlbnQgaW5zdGFuY2VvZiBOYXZpZ2F0aW9uQ2FuY2VsXHJcbiAgICAgICAgICApXHJcbiAgICAgICAgKVxyXG4gICAgICAgIC5zdWJzY3JpYmUoKGV2ZW50OiBSb3V0ZXJFdmVudCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5pc05hdmlnYXRpbmcgPSBldmVudCBpbnN0YW5jZW9mIE5hdmlnYXRpb25TdGFydDtcclxuICAgICAgICAgIGlmICh0aGlzLmlzTmF2aWdhdGluZykge1xyXG4gICAgICAgICAgICB0aGlzLnNldENvbnRleHRQYXJhbXNGcm9tUm91dGUoZXZlbnQudXJsKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghY29udGV4dEluaXRpYWxpemVkKSB7XHJcbiAgICAgICAgICAgICAgY29udGV4dEluaXRpYWxpemVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICBvbkNvbnRleHRJbml0aWFsaXplZCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBVcGRhdGVzIHRoZSBzaXRlIGNvbnRleHQgc3RhdGUgYmFzZWQgb24gdGhlIGNvbnRleHQgcGFyYW1zIGVuY29kZWQgaW4gdGhlIGdpdmVuIFVSTFxyXG4gICAqXHJcbiAgICogQHBhcmFtIHVybCBVUkwgd2l0aCBlbmNvZGVkIGNvbnRleHQgcGFyYW1zXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzZXRDb250ZXh0UGFyYW1zRnJvbVJvdXRlKHVybDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB7IHBhcmFtcyB9ID0gdGhpcy5zZXJpYWxpemVyLnVybEV4dHJhY3RDb250ZXh0UGFyYW1ldGVycyh1cmwpO1xyXG4gICAgT2JqZWN0LmtleXMocGFyYW1zKS5mb3JFYWNoKChwYXJhbSkgPT5cclxuICAgICAgdGhpcy5zaXRlQ29udGV4dFBhcmFtcy5zZXRWYWx1ZShwYXJhbSwgcGFyYW1zW3BhcmFtXSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgfVxyXG59XHJcbiJdfQ==
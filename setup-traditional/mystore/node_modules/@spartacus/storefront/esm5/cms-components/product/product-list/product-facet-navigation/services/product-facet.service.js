import { __assign, __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { ActivatedRouterStateSnapshot, Breadcrumb, PageType, ProductSearchPage, RoutingService, } from '@spartacus/core';
import { filter, map, pluck, switchMap } from 'rxjs/operators';
import { ProductListComponentService } from '../../container/product-list-component.service';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/core";
import * as i2 from "../../container/product-list-component.service";
/**
 * Provides access to all the facets and active facets for the Product Listing Page.
 */
var ProductFacetService = /** @class */ (function () {
    function ProductFacetService(routing, productListComponentService) {
        var _this = this;
        this.routing = routing;
        this.productListComponentService = productListComponentService;
        this.routeState$ = this.routing
            .getRouterState()
            .pipe(pluck('state'));
        this.searchResult$ = this.routeState$.pipe(switchMap(function (state) {
            return _this.productListComponentService.model$.pipe(filter(function (page) { return _this.filterForPage(state, page); }), map(function (page) { return _this.mapResults(state, page); }));
        }));
        /**
         * Observes the facets and active facets for the given page. The facet data
         * is provided in a `FacetList`.
         */
        this.facetList$ = this.searchResult$.pipe(map(function (result) {
            return ({
                facets: result.facets,
                activeFacets: result.breadcrumbs,
            });
        }));
    }
    /**
     * Filters the current result by verifying if the result is related to the page.
     * This is done to avoid a combination of the next page and the current search results.
     */
    ProductFacetService.prototype.filterForPage = function (state, page) {
        var _a, _b, _c;
        if (state.context.type === PageType.CATEGORY_PAGE) {
            return (((_c = (_b = (_a = page.currentQuery) === null || _a === void 0 ? void 0 : _a.query) === null || _b === void 0 ? void 0 : _b.value) === null || _c === void 0 ? void 0 : _c.indexOf("allCategories:" + state.context.id)) > -1);
        }
        if (state.context.type === PageType.CONTENT_PAGE &&
            state.context.id === 'search') {
            return page.currentQuery.query.value.startsWith(state.params.query + ":");
        }
        return false;
    };
    ProductFacetService.prototype.mapResults = function (state, page) {
        return __assign(__assign({}, page), { breadcrumbs: this.filterBreadcrumbs(page.breadcrumbs, state.params) });
    };
    /**
     * filter breadcrumbs which are not actively selected
     * but coming from the route navigation
     */
    ProductFacetService.prototype.filterBreadcrumbs = function (breadcrumbs, params) {
        var _this = this;
        return breadcrumbs
            ? breadcrumbs.filter(function (breadcrumb) { return !_this.hasBreadcrumb(breadcrumb, params); })
            : [];
    };
    /**
     * Indicates whether the breadcrumb is related to navigation parameters,
     * since either the category or brand code should match those codes.
     */
    ProductFacetService.prototype.hasBreadcrumb = function (breadcrumb, params) {
        return (breadcrumb.facetCode === 'allCategories' &&
            breadcrumb.facetValueCode === params.categoryCode);
    };
    ProductFacetService.ctorParameters = function () { return [
        { type: RoutingService },
        { type: ProductListComponentService }
    ]; };
    ProductFacetService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ProductFacetService_Factory() { return new ProductFacetService(i0.ɵɵinject(i1.RoutingService), i0.ɵɵinject(i2.ProductListComponentService)); }, token: ProductFacetService, providedIn: "root" });
    ProductFacetService = __decorate([
        Injectable({
            providedIn: 'root',
        })
    ], ProductFacetService);
    return ProductFacetService;
}());
export { ProductFacetService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZHVjdC1mYWNldC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHNwYXJ0YWN1cy9zdG9yZWZyb250LyIsInNvdXJjZXMiOlsiY21zLWNvbXBvbmVudHMvcHJvZHVjdC9wcm9kdWN0LWxpc3QvcHJvZHVjdC1mYWNldC1uYXZpZ2F0aW9uL3NlcnZpY2VzL3Byb2R1Y3QtZmFjZXQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQ0wsNEJBQTRCLEVBQzVCLFVBQVUsRUFDVixRQUFRLEVBQ1IsaUJBQWlCLEVBQ2pCLGNBQWMsR0FDZixNQUFNLGlCQUFpQixDQUFDO0FBRXpCLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxnREFBZ0QsQ0FBQzs7OztBQUc3Rjs7R0FFRztBQUlIO0lBZ0JFLDZCQUNZLE9BQXVCLEVBQ3ZCLDJCQUF3RDtRQUZwRSxpQkFHSTtRQUZRLFlBQU8sR0FBUCxPQUFPLENBQWdCO1FBQ3ZCLGdDQUEyQixHQUEzQiwyQkFBMkIsQ0FBNkI7UUFqQmpELGdCQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU87YUFDMUMsY0FBYyxFQUFFO2FBQ2hCLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUVMLGtCQUFhLEdBRTVCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUN2QixTQUFTLENBQUMsVUFBQyxLQUFLO1lBQ2QsT0FBQSxLQUFJLENBQUMsMkJBQTJCLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDMUMsTUFBTSxDQUFDLFVBQUMsSUFBSSxJQUFLLE9BQUEsS0FBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQS9CLENBQStCLENBQUMsRUFDakQsR0FBRyxDQUFDLFVBQUMsSUFBSSxJQUFLLE9BQUEsS0FBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQTVCLENBQTRCLENBQUMsQ0FDNUM7UUFIRCxDQUdDLENBQ0YsQ0FDRixDQUFDO1FBT0Y7OztXQUdHO1FBQ00sZUFBVSxHQUEwQixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FDbEUsR0FBRyxDQUNELFVBQUMsTUFBeUI7WUFDeEIsT0FBQSxDQUFDO2dCQUNDLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTTtnQkFDckIsWUFBWSxFQUFFLE1BQU0sQ0FBQyxXQUFXO2FBQ25CLENBQUE7UUFIZixDQUdlLENBQ2xCLENBQ0YsQ0FBQztJQWRDLENBQUM7SUFnQko7OztPQUdHO0lBQ08sMkNBQWEsR0FBdkIsVUFDRSxLQUFtQyxFQUNuQyxJQUF1Qjs7UUFFdkIsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksS0FBSyxRQUFRLENBQUMsYUFBYSxFQUFFO1lBQ2pELE9BQU8sQ0FDTCxtQkFBQSxJQUFJLENBQUMsWUFBWSwwQ0FBRSxLQUFLLDBDQUFFLEtBQUssMENBQUUsT0FBTyxDQUN0QyxtQkFBaUIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFJLEtBQ2pDLENBQUMsQ0FBQyxDQUNQLENBQUM7U0FDSDtRQUVELElBQ0UsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEtBQUssUUFBUSxDQUFDLFlBQVk7WUFDNUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLEtBQUssUUFBUSxFQUM3QjtZQUNBLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBSSxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssTUFBRyxDQUFDLENBQUM7U0FDM0U7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFTyx3Q0FBVSxHQUFsQixVQUNFLEtBQW1DLEVBQ25DLElBQXVCO1FBRXZCLDZCQUNLLElBQUksS0FDUCxXQUFXLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUNuRTtJQUNKLENBQUM7SUFFRDs7O09BR0c7SUFDSywrQ0FBaUIsR0FBekIsVUFDRSxXQUF5QixFQUN6QixNQUFjO1FBRmhCLGlCQVNDO1FBTEMsT0FBTyxXQUFXO1lBQ2hCLENBQUMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUNoQixVQUFDLFVBQVUsSUFBSyxPQUFBLENBQUMsS0FBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUUsTUFBTSxDQUFDLEVBQXZDLENBQXVDLENBQ3hEO1lBQ0gsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUNULENBQUM7SUFFRDs7O09BR0c7SUFDSywyQ0FBYSxHQUFyQixVQUFzQixVQUFzQixFQUFFLE1BQWM7UUFDMUQsT0FBTyxDQUNMLFVBQVUsQ0FBQyxTQUFTLEtBQUssZUFBZTtZQUN4QyxVQUFVLENBQUMsY0FBYyxLQUFLLE1BQU0sQ0FBQyxZQUFZLENBQ2xELENBQUM7SUFDSixDQUFDOztnQkE3RW9CLGNBQWM7Z0JBQ00sMkJBQTJCOzs7SUFsQnpELG1CQUFtQjtRQUgvQixVQUFVLENBQUM7WUFDVixVQUFVLEVBQUUsTUFBTTtTQUNuQixDQUFDO09BQ1csbUJBQW1CLENBK0YvQjs4QkFuSEQ7Q0FtSEMsQUEvRkQsSUErRkM7U0EvRlksbUJBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBQYXJhbXMgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xyXG5pbXBvcnQge1xyXG4gIEFjdGl2YXRlZFJvdXRlclN0YXRlU25hcHNob3QsXHJcbiAgQnJlYWRjcnVtYixcclxuICBQYWdlVHlwZSxcclxuICBQcm9kdWN0U2VhcmNoUGFnZSxcclxuICBSb3V0aW5nU2VydmljZSxcclxufSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGZpbHRlciwgbWFwLCBwbHVjaywgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBQcm9kdWN0TGlzdENvbXBvbmVudFNlcnZpY2UgfSBmcm9tICcuLi8uLi9jb250YWluZXIvcHJvZHVjdC1saXN0LWNvbXBvbmVudC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRmFjZXRMaXN0IH0gZnJvbSAnLi4vZmFjZXQubW9kZWwnO1xyXG5cclxuLyoqXHJcbiAqIFByb3ZpZGVzIGFjY2VzcyB0byBhbGwgdGhlIGZhY2V0cyBhbmQgYWN0aXZlIGZhY2V0cyBmb3IgdGhlIFByb2R1Y3QgTGlzdGluZyBQYWdlLlxyXG4gKi9cclxuQEluamVjdGFibGUoe1xyXG4gIHByb3ZpZGVkSW46ICdyb290JyxcclxufSlcclxuZXhwb3J0IGNsYXNzIFByb2R1Y3RGYWNldFNlcnZpY2Uge1xyXG4gIHByb3RlY3RlZCByZWFkb25seSByb3V0ZVN0YXRlJCA9IHRoaXMucm91dGluZ1xyXG4gICAgLmdldFJvdXRlclN0YXRlKClcclxuICAgIC5waXBlKHBsdWNrKCdzdGF0ZScpKTtcclxuXHJcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IHNlYXJjaFJlc3VsdCQ6IE9ic2VydmFibGU8XHJcbiAgICBQcm9kdWN0U2VhcmNoUGFnZVxyXG4gID4gPSB0aGlzLnJvdXRlU3RhdGUkLnBpcGUoXHJcbiAgICBzd2l0Y2hNYXAoKHN0YXRlKSA9PlxyXG4gICAgICB0aGlzLnByb2R1Y3RMaXN0Q29tcG9uZW50U2VydmljZS5tb2RlbCQucGlwZShcclxuICAgICAgICBmaWx0ZXIoKHBhZ2UpID0+IHRoaXMuZmlsdGVyRm9yUGFnZShzdGF0ZSwgcGFnZSkpLFxyXG4gICAgICAgIG1hcCgocGFnZSkgPT4gdGhpcy5tYXBSZXN1bHRzKHN0YXRlLCBwYWdlKSlcclxuICAgICAgKVxyXG4gICAgKVxyXG4gICk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJvdGVjdGVkIHJvdXRpbmc6IFJvdXRpbmdTZXJ2aWNlLFxyXG4gICAgcHJvdGVjdGVkIHByb2R1Y3RMaXN0Q29tcG9uZW50U2VydmljZTogUHJvZHVjdExpc3RDb21wb25lbnRTZXJ2aWNlXHJcbiAgKSB7fVxyXG5cclxuICAvKipcclxuICAgKiBPYnNlcnZlcyB0aGUgZmFjZXRzIGFuZCBhY3RpdmUgZmFjZXRzIGZvciB0aGUgZ2l2ZW4gcGFnZS4gVGhlIGZhY2V0IGRhdGFcclxuICAgKiBpcyBwcm92aWRlZCBpbiBhIGBGYWNldExpc3RgLlxyXG4gICAqL1xyXG4gIHJlYWRvbmx5IGZhY2V0TGlzdCQ6IE9ic2VydmFibGU8RmFjZXRMaXN0PiA9IHRoaXMuc2VhcmNoUmVzdWx0JC5waXBlKFxyXG4gICAgbWFwKFxyXG4gICAgICAocmVzdWx0OiBQcm9kdWN0U2VhcmNoUGFnZSkgPT5cclxuICAgICAgICAoe1xyXG4gICAgICAgICAgZmFjZXRzOiByZXN1bHQuZmFjZXRzLFxyXG4gICAgICAgICAgYWN0aXZlRmFjZXRzOiByZXN1bHQuYnJlYWRjcnVtYnMsXHJcbiAgICAgICAgfSBhcyBGYWNldExpc3QpXHJcbiAgICApXHJcbiAgKTtcclxuXHJcbiAgLyoqXHJcbiAgICogRmlsdGVycyB0aGUgY3VycmVudCByZXN1bHQgYnkgdmVyaWZ5aW5nIGlmIHRoZSByZXN1bHQgaXMgcmVsYXRlZCB0byB0aGUgcGFnZS5cclxuICAgKiBUaGlzIGlzIGRvbmUgdG8gYXZvaWQgYSBjb21iaW5hdGlvbiBvZiB0aGUgbmV4dCBwYWdlIGFuZCB0aGUgY3VycmVudCBzZWFyY2ggcmVzdWx0cy5cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZmlsdGVyRm9yUGFnZShcclxuICAgIHN0YXRlOiBBY3RpdmF0ZWRSb3V0ZXJTdGF0ZVNuYXBzaG90LFxyXG4gICAgcGFnZTogUHJvZHVjdFNlYXJjaFBhZ2VcclxuICApOiBib29sZWFuIHtcclxuICAgIGlmIChzdGF0ZS5jb250ZXh0LnR5cGUgPT09IFBhZ2VUeXBlLkNBVEVHT1JZX1BBR0UpIHtcclxuICAgICAgcmV0dXJuIChcclxuICAgICAgICBwYWdlLmN1cnJlbnRRdWVyeT8ucXVlcnk/LnZhbHVlPy5pbmRleE9mKFxyXG4gICAgICAgICAgYGFsbENhdGVnb3JpZXM6JHtzdGF0ZS5jb250ZXh0LmlkfWBcclxuICAgICAgICApID4gLTFcclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoXHJcbiAgICAgIHN0YXRlLmNvbnRleHQudHlwZSA9PT0gUGFnZVR5cGUuQ09OVEVOVF9QQUdFICYmXHJcbiAgICAgIHN0YXRlLmNvbnRleHQuaWQgPT09ICdzZWFyY2gnXHJcbiAgICApIHtcclxuICAgICAgcmV0dXJuIHBhZ2UuY3VycmVudFF1ZXJ5LnF1ZXJ5LnZhbHVlLnN0YXJ0c1dpdGgoYCR7c3RhdGUucGFyYW1zLnF1ZXJ5fTpgKTtcclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgbWFwUmVzdWx0cyhcclxuICAgIHN0YXRlOiBBY3RpdmF0ZWRSb3V0ZXJTdGF0ZVNuYXBzaG90LFxyXG4gICAgcGFnZTogUHJvZHVjdFNlYXJjaFBhZ2VcclxuICApOiBQcm9kdWN0U2VhcmNoUGFnZSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAuLi5wYWdlLFxyXG4gICAgICBicmVhZGNydW1iczogdGhpcy5maWx0ZXJCcmVhZGNydW1icyhwYWdlLmJyZWFkY3J1bWJzLCBzdGF0ZS5wYXJhbXMpLFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIGZpbHRlciBicmVhZGNydW1icyB3aGljaCBhcmUgbm90IGFjdGl2ZWx5IHNlbGVjdGVkXHJcbiAgICogYnV0IGNvbWluZyBmcm9tIHRoZSByb3V0ZSBuYXZpZ2F0aW9uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmaWx0ZXJCcmVhZGNydW1icyhcclxuICAgIGJyZWFkY3J1bWJzOiBCcmVhZGNydW1iW10sXHJcbiAgICBwYXJhbXM6IFBhcmFtc1xyXG4gICk6IEJyZWFkY3J1bWJbXSB7XHJcbiAgICByZXR1cm4gYnJlYWRjcnVtYnNcclxuICAgICAgPyBicmVhZGNydW1icy5maWx0ZXIoXHJcbiAgICAgICAgICAoYnJlYWRjcnVtYikgPT4gIXRoaXMuaGFzQnJlYWRjcnVtYihicmVhZGNydW1iLCBwYXJhbXMpXHJcbiAgICAgICAgKVxyXG4gICAgICA6IFtdO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSW5kaWNhdGVzIHdoZXRoZXIgdGhlIGJyZWFkY3J1bWIgaXMgcmVsYXRlZCB0byBuYXZpZ2F0aW9uIHBhcmFtZXRlcnMsXHJcbiAgICogc2luY2UgZWl0aGVyIHRoZSBjYXRlZ29yeSBvciBicmFuZCBjb2RlIHNob3VsZCBtYXRjaCB0aG9zZSBjb2Rlcy5cclxuICAgKi9cclxuICBwcml2YXRlIGhhc0JyZWFkY3J1bWIoYnJlYWRjcnVtYjogQnJlYWRjcnVtYiwgcGFyYW1zOiBQYXJhbXMpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAoXHJcbiAgICAgIGJyZWFkY3J1bWIuZmFjZXRDb2RlID09PSAnYWxsQ2F0ZWdvcmllcycgJiZcclxuICAgICAgYnJlYWRjcnVtYi5mYWNldFZhbHVlQ29kZSA9PT0gcGFyYW1zLmNhdGVnb3J5Q29kZVxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuIl19
import { __decorate, __read } from "tslib";
import { Component } from '@angular/core';
import { CustomerCouponSearchResult, CustomerCouponService, PaginationModel, } from '@spartacus/core';
import { combineLatest, Subscription } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { ICON_TYPE } from '../../misc/icon/icon.model';
import { MyCouponsComponentService } from './my-coupons.component.service';
var MyCouponsComponent = /** @class */ (function () {
    function MyCouponsComponent(couponService, myCouponsComponentService) {
        this.couponService = couponService;
        this.myCouponsComponentService = myCouponsComponentService;
        this.iconTypes = ICON_TYPE;
        this.subscriptions = new Subscription();
        this.PAGE_SIZE = 10;
        this.sortMapping = {
            byStartDateAsc: 'startDate:asc',
            byStartDateDesc: 'startDate:desc',
            byEndDateAsc: 'endDate:asc',
            byEndDateDesc: 'endDate:desc',
        };
        this.sort = 'byStartDateAsc';
        this.sortOptions = [
            {
                code: 'byStartDateAsc',
                selected: false,
            },
            {
                code: 'byStartDateDesc',
                selected: false,
            },
            {
                code: 'byEndDateAsc',
                selected: false,
            },
            {
                code: 'byEndDateDesc',
                selected: false,
            },
        ];
    }
    MyCouponsComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.couponResult$ = this.couponService
            .getCustomerCoupons(this.PAGE_SIZE)
            .pipe(tap(function (coupons) {
            return (_this.pagination = {
                currentPage: coupons.pagination.page,
                pageSize: coupons.pagination.count,
                totalPages: coupons.pagination.totalPages,
                totalResults: coupons.pagination.totalCount,
                sort: _this.sort,
            });
        }));
        this.couponsLoading$ = this.couponService.getCustomerCouponsLoading();
        this.couponSubscriptionLoading$ = combineLatest([
            this.couponService.getSubscribeCustomerCouponResultLoading(),
            this.couponService.getUnsubscribeCustomerCouponResultLoading(),
        ]).pipe(map(function (_a) {
            var _b = __read(_a, 2), subscribing = _b[0], unsubscribing = _b[1];
            return subscribing || unsubscribing;
        }));
        this.sortLabels = this.myCouponsComponentService.getSortLabels();
        this.subscriptions
            .add(this.couponService
            .getSubscribeCustomerCouponResultError()
            .subscribe(function (error) {
            _this.subscriptionFail(error);
        }))
            .add(this.couponService
            .getUnsubscribeCustomerCouponResultError()
            .subscribe(function (error) {
            _this.subscriptionFail(error);
        }));
    };
    MyCouponsComponent.prototype.subscriptionFail = function (error) {
        if (error) {
            this.couponService.loadCustomerCoupons(this.PAGE_SIZE);
        }
    };
    MyCouponsComponent.prototype.sortChange = function (sort) {
        this.sort = sort;
        this.couponService.loadCustomerCoupons(this.PAGE_SIZE, this.pagination.currentPage, this.sortMapping[sort]);
    };
    MyCouponsComponent.prototype.pageChange = function (page) {
        this.couponService.loadCustomerCoupons(this.PAGE_SIZE, page, this.sortMapping[this.sort]);
    };
    MyCouponsComponent.prototype.notificationChange = function (_a) {
        var couponId = _a.couponId, notification = _a.notification;
        if (notification) {
            this.couponService.subscribeCustomerCoupon(couponId);
        }
        else {
            this.couponService.unsubscribeCustomerCoupon(couponId);
        }
    };
    MyCouponsComponent.prototype.ngOnDestroy = function () {
        this.subscriptions.unsubscribe();
    };
    MyCouponsComponent.ctorParameters = function () { return [
        { type: CustomerCouponService },
        { type: MyCouponsComponentService }
    ]; };
    MyCouponsComponent = __decorate([
        Component({
            selector: 'cx-my-coupons',
            template: "<div class=\"cx-section\">\n  <ng-container *ngIf=\"!(couponsLoading$ | async); else loading\">\n    <ng-container *ngIf=\"couponResult$ | async as couponResult\">\n      <div class=\"cx-my-coupons-header\">\n        <h3>{{ 'myCoupons.myCoupons' | cxTranslate }}</h3>\n      </div>\n\n      <ng-container\n        *ngIf=\"couponResult.pagination.totalCount > 0; else noCoupons\"\n      >\n        <div class=\"cx-my-coupons-sort top row\">\n          <div\n            class=\"cx-my-coupons-form-group form-group col-sm-12 col-md-4 col-lg-4\"\n          >\n            <cx-sorting\n              [sortOptions]=\"sortOptions\"\n              [sortLabels]=\"sortLabels | async\"\n              (sortListEvent)=\"sortChange($event)\"\n              [selectedOption]=\"sort\"\n            >\n            </cx-sorting>\n          </div>\n          <div class=\"cx-my-coupons-pagination cx-mycoupon-thead-mobile\">\n            <cx-pagination\n              [pagination]=\"pagination\"\n              (viewPageEvent)=\"pageChange($event)\"\n            ></cx-pagination>\n          </div>\n        </div>\n\n        <div class=\"row cx-coupon-deck\">\n          <div\n            *ngFor=\"let coupon of couponResult.coupons\"\n            class=\"col-md-6 cx-coupon-card\"\n          >\n            <cx-coupon-card\n              [coupon]=\"coupon\"\n              [couponSubscriptionLoading$]=\"couponSubscriptionLoading$\"\n              (notificationChanged)=\"notificationChange($event)\"\n            ></cx-coupon-card>\n          </div>\n        </div>\n\n        <div class=\"cx-my-coupons-sort bottom row\">\n          <div\n            class=\"cx-my-coupons-form-group form-group cx-mycoupon-thead-mobile col-sm-12 col-md-4 col-lg-4\"\n          >\n            <cx-sorting\n              [sortOptions]=\"sortOptions\"\n              [sortLabels]=\"sortLabels | async\"\n              (sortListEvent)=\"sortChange($event)\"\n              [selectedOption]=\"sort\"\n              placeholder=\"{{ 'myCoupons.sortByMostRecent' | cxTranslate }}\"\n            >\n            </cx-sorting>\n          </div>\n          <div class=\"cx-my-coupons-pagination\">\n            <cx-pagination\n              [pagination]=\"pagination\"\n              (viewPageEvent)=\"pageChange($event)\"\n            ></cx-pagination>\n          </div>\n        </div>\n        <div class=\"cx-my-coupons-notes\">\n          <span>\n            <cx-icon [type]=\"iconTypes.INFO\"></cx-icon>\n            {{ 'myCoupons.notesPreffix' | cxTranslate\n            }}<a [routerLink]=\"['/my-account/notification-preference']\">{{\n              'myCoupons.notesLink' | cxTranslate\n            }}</a\n            >{{ 'myCoupons.notesSuffix' | cxTranslate }}</span\n          >\n        </div>\n      </ng-container>\n    </ng-container>\n\n    <ng-template #noCoupons>\n      <section>\n        <p class=\"cx-section-msg\">\n          {{ 'myCoupons.noCouponsMessage' | cxTranslate }}\n        </p>\n      </section>\n    </ng-template>\n  </ng-container>\n\n  <ng-template #loading>\n    <div class=\"col-md-12 cx-coupon-spinner\">\n      <cx-spinner></cx-spinner>\n    </div>\n  </ng-template>\n</div>\n"
        })
    ], MyCouponsComponent);
    return MyCouponsComponent;
}());
export { MyCouponsComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXktY291cG9ucy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ac3BhcnRhY3VzL3N0b3JlZnJvbnQvIiwic291cmNlcyI6WyJjbXMtY29tcG9uZW50cy9teWFjY291bnQvbXktY291cG9ucy9teS1jb3Vwb25zLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBcUIsTUFBTSxlQUFlLENBQUM7QUFDN0QsT0FBTyxFQUNMLDBCQUEwQixFQUMxQixxQkFBcUIsRUFDckIsZUFBZSxHQUNoQixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxhQUFhLEVBQWMsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBTTNFO0lBNkNFLDRCQUNZLGFBQW9DLEVBQ3BDLHlCQUFvRDtRQURwRCxrQkFBYSxHQUFiLGFBQWEsQ0FBdUI7UUFDcEMsOEJBQXlCLEdBQXpCLHlCQUF5QixDQUEyQjtRQTFDaEUsY0FBUyxHQUFHLFNBQVMsQ0FBQztRQUVkLGtCQUFhLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUVuQyxjQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ2YsZ0JBQVcsR0FBRztZQUNwQixjQUFjLEVBQUUsZUFBZTtZQUMvQixlQUFlLEVBQUUsZ0JBQWdCO1lBQ2pDLFlBQVksRUFBRSxhQUFhO1lBQzNCLGFBQWEsRUFBRSxjQUFjO1NBQzlCLENBQUM7UUFDRixTQUFJLEdBQUcsZ0JBQWdCLENBQUM7UUFFeEIsZ0JBQVcsR0FBRztZQUNaO2dCQUNFLElBQUksRUFBRSxnQkFBZ0I7Z0JBQ3RCLFFBQVEsRUFBRSxLQUFLO2FBQ2hCO1lBQ0Q7Z0JBQ0Us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Q1IsOEJBQVk7UUFLWixJQUFJLFlBQVksRUFBRTtZQUNoQixJQUFJLENBQUMsYUFBYSxDQUFDLHVCQUF1QixDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3REO2FBQU07WUFDTCxJQUFJLENBQUMsYUFBYSxDQUFDLHlCQUF5QixDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3hEO0lBQ0gsQ0FBQztJQUVELHdDQUFXLEdBQVg7UUFDRSxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ25DLENBQUM7O2dCQXJGMEIscUJBQXFCO2dCQUNULHlCQUF5Qjs7SUEvQ3JELGtCQUFrQjtRQUo5QixTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsZUFBZTtZQUN6QixzbkdBQTBDO1NBQzNDLENBQUM7T0FDVyxrQkFBa0IsQ0FvSTlCO0lBQUQseUJBQUM7Q0FBQSxBQXBJRCxJQW9JQztTQXBJWSxrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uRGVzdHJveSwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7XHJcbiAgQ3VzdG9tZXJDb3Vwb25TZWFyY2hSZXN1bHQsXHJcbiAgQ3VzdG9tZXJDb3Vwb25TZXJ2aWNlLFxyXG4gIFBhZ2luYXRpb25Nb2RlbCxcclxufSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xyXG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgbWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IElDT05fVFlQRSB9IGZyb20gJy4uLy4uL21pc2MvaWNvbi9pY29uLm1vZGVsJztcclxuaW1wb3J0IHsgTXlDb3Vwb25zQ29tcG9uZW50U2VydmljZSB9IGZyb20gJy4vbXktY291cG9ucy5jb21wb25lbnQuc2VydmljZSc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ2N4LW15LWNvdXBvbnMnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9teS1jb3Vwb25zLmNvbXBvbmVudC5odG1sJyxcclxufSlcclxuZXhwb3J0IGNsYXNzIE15Q291cG9uc0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcclxuICBjb3Vwb25SZXN1bHQkOiBPYnNlcnZhYmxlPEN1c3RvbWVyQ291cG9uU2VhcmNoUmVzdWx0PjtcclxuICBjb3Vwb25zTG9hZGluZyQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XHJcbiAgY291cG9uU3Vic2NyaXB0aW9uTG9hZGluZyQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XHJcblxyXG4gIGljb25UeXBlcyA9IElDT05fVFlQRTtcclxuXHJcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb25zID0gbmV3IFN1YnNjcmlwdGlvbigpO1xyXG5cclxuICBwcml2YXRlIFBBR0VfU0laRSA9IDEwO1xyXG4gIHByaXZhdGUgc29ydE1hcHBpbmcgPSB7XHJcbiAgICBieVN0YXJ0RGF0ZUFzYzogJ3N0YXJ0RGF0ZTphc2MnLFxyXG4gICAgYnlTdGFydERhdGVEZXNjOiAnc3RhcnREYXRlOmRlc2MnLFxyXG4gICAgYnlFbmREYXRlQXNjOiAnZW5kRGF0ZTphc2MnLFxyXG4gICAgYnlFbmREYXRlRGVzYzogJ2VuZERhdGU6ZGVzYycsXHJcbiAgfTtcclxuICBzb3J0ID0gJ2J5U3RhcnREYXRlQXNjJztcclxuXHJcbiAgc29ydE9wdGlvbnMgPSBbXHJcbiAgICB7XHJcbiAgICAgIGNvZGU6ICdieVN0YXJ0RGF0ZUFzYycsXHJcbiAgICAgIHNlbGVjdGVkOiBmYWxzZSxcclxuICAgIH0sXHJcbiAgICB7XHJcbiAgICAgIGNvZGU6ICdieVN0YXJ0RGF0ZURlc2MnLFxyXG4gICAgICBzZWxlY3RlZDogZmFsc2UsXHJcbiAgICB9LFxyXG4gICAge1xyXG4gICAgICBjb2RlOiAnYnlFbmREYXRlQXNjJyxcclxuICAgICAgc2VsZWN0ZWQ6IGZhbHNlLFxyXG4gICAgfSxcclxuICAgIHtcclxuICAgICAgY29kZTogJ2J5RW5kRGF0ZURlc2MnLFxyXG4gICAgICBzZWxlY3RlZDogZmFsc2UsXHJcbiAgICB9LFxyXG4gIF07XHJcblxyXG4gIHBhZ2luYXRpb246IFBhZ2luYXRpb25Nb2RlbDtcclxuICBzb3J0TGFiZWxzOiBPYnNlcnZhYmxlPHtcclxuICAgIGJ5U3RhcnREYXRlQXNjOiBzdHJpbmc7XHJcbiAgICBieVN0YXJ0RGF0ZURlc2M6IHN0cmluZztcclxuICAgIGJ5RW5kRGF0ZUFzYzogc3RyaW5nO1xyXG4gICAgYnlFbmREYXRlRGVzYzogc3RyaW5nO1xyXG4gIH0+O1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByb3RlY3RlZCBjb3Vwb25TZXJ2aWNlOiBDdXN0b21lckNvdXBvblNlcnZpY2UsXHJcbiAgICBwcm90ZWN0ZWQgbXlDb3Vwb25zQ29tcG9uZW50U2VydmljZTogTXlDb3Vwb25zQ29tcG9uZW50U2VydmljZVxyXG4gICkge31cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLmNvdXBvblJlc3VsdCQgPSB0aGlzLmNvdXBvblNlcnZpY2VcclxuICAgICAgLmdldEN1c3RvbWVyQ291cG9ucyh0aGlzLlBBR0VfU0laRSlcclxuICAgICAgLnBpcGUoXHJcbiAgICAgICAgdGFwKFxyXG4gICAgICAgICAgKGNvdXBvbnMpID0+XHJcbiAgICAgICAgICAgICh0aGlzLnBhZ2luYXRpb24gPSB7XHJcbiAgICAgICAgICAgICAgY3VycmVudFBhZ2U6IGNvdXBvbnMucGFnaW5hdGlvbi5wYWdlLFxyXG4gICAgICAgICAgICAgIHBhZ2VTaXplOiBjb3Vwb25zLnBhZ2luYXRpb24uY291bnQsXHJcbiAgICAgICAgICAgICAgdG90YWxQYWdlczogY291cG9ucy5wYWdpbmF0aW9uLnRvdGFsUGFnZXMsXHJcbiAgICAgICAgICAgICAgdG90YWxSZXN1bHRzOiBjb3Vwb25zLnBhZ2luYXRpb24udG90YWxDb3VudCxcclxuICAgICAgICAgICAgICBzb3J0OiB0aGlzLnNvcnQsXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgKVxyXG4gICAgICApO1xyXG4gICAgdGhpcy5jb3Vwb25zTG9hZGluZyQgPSB0aGlzLmNvdXBvblNlcnZpY2UuZ2V0Q3VzdG9tZXJDb3Vwb25zTG9hZGluZygpO1xyXG4gICAgdGhpcy5jb3Vwb25TdWJzY3JpcHRpb25Mb2FkaW5nJCA9IGNvbWJpbmVMYXRlc3QoW1xyXG4gICAgICB0aGlzLmNvdXBvblNlcnZpY2UuZ2V0U3Vic2NyaWJlQ3VzdG9tZXJDb3Vwb25SZXN1bHRMb2FkaW5nKCksXHJcbiAgICAgIHRoaXMuY291cG9uU2VydmljZS5nZXRVbnN1YnNjcmliZUN1c3RvbWVyQ291cG9uUmVzdWx0TG9hZGluZygpLFxyXG4gICAgXSkucGlwZShcclxuICAgICAgbWFwKChbc3Vic2NyaWJpbmcsIHVuc3Vic2NyaWJpbmddKSA9PiBzdWJzY3JpYmluZyB8fCB1bnN1YnNjcmliaW5nKVxyXG4gICAgKTtcclxuICAgIHRoaXMuc29ydExhYmVscyA9IHRoaXMubXlDb3Vwb25zQ29tcG9uZW50U2VydmljZS5nZXRTb3J0TGFiZWxzKCk7XHJcblxyXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zXHJcbiAgICAgIC5hZGQoXHJcbiAgICAgICAgdGhpcy5jb3Vwb25TZXJ2aWNlXHJcbiAgICAgICAgICAuZ2V0U3Vic2NyaWJlQ3VzdG9tZXJDb3Vwb25SZXN1bHRFcnJvcigpXHJcbiAgICAgICAgICAuc3Vic2NyaWJlKChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbkZhaWwoZXJyb3IpO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgKVxyXG4gICAgICAuYWRkKFxyXG4gICAgICAgIHRoaXMuY291cG9uU2VydmljZVxyXG4gICAgICAgICAgLmdldFVuc3Vic2NyaWJlQ3VzdG9tZXJDb3Vwb25SZXN1bHRFcnJvcigpXHJcbiAgICAgICAgICAuc3Vic2NyaWJlKChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbkZhaWwoZXJyb3IpO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uRmFpbChlcnJvcjogYm9vbGVhbikge1xyXG4gICAgaWYgKGVycm9yKSB7XHJcbiAgICAgIHRoaXMuY291cG9uU2VydmljZS5sb2FkQ3VzdG9tZXJDb3Vwb25zKHRoaXMuUEFHRV9TSVpFKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNvcnRDaGFuZ2Uoc29ydDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnNvcnQgPSBzb3J0O1xyXG5cclxuICAgIHRoaXMuY291cG9uU2VydmljZS5sb2FkQ3VzdG9tZXJDb3Vwb25zKFxyXG4gICAgICB0aGlzLlBBR0VfU0laRSxcclxuICAgICAgdGhpcy5wYWdpbmF0aW9uLmN1cnJlbnRQYWdlLFxyXG4gICAgICB0aGlzLnNvcnRNYXBwaW5nW3NvcnRdXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcGFnZUNoYW5nZShwYWdlOiBudW1iZXIpOiB2b2lkIHtcclxuICAgIHRoaXMuY291cG9uU2VydmljZS5sb2FkQ3VzdG9tZXJDb3Vwb25zKFxyXG4gICAgICB0aGlzLlBBR0VfU0laRSxcclxuICAgICAgcGFnZSxcclxuICAgICAgdGhpcy5zb3J0TWFwcGluZ1t0aGlzLnNvcnRdXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgbm90aWZpY2F0aW9uQ2hhbmdlKHtcclxuICAgIGNvdXBvbklkLFxyXG4gICAgbm90aWZpY2F0aW9uLFxyXG4gIH06IHtcclxuICAgIGNvdXBvbklkOiBzdHJpbmc7XHJcbiAgICBub3RpZmljYXRpb246IGJvb2xlYW47XHJcbiAgfSk6IHZvaWQge1xyXG4gICAgaWYgKG5vdGlmaWNhdGlvbikge1xyXG4gICAgICB0aGlzLmNvdXBvblNlcnZpY2Uuc3Vic2NyaWJlQ3VzdG9tZXJDb3Vwb24oY291cG9uSWQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5jb3Vwb25TZXJ2aWNlLnVuc3Vic2NyaWJlQ3VzdG9tZXJDb3Vwb24oY291cG9uSWQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMudW5zdWJzY3JpYmUoKTtcclxuICB9XHJcbn1cclxuIl19
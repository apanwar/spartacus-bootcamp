import { __decorate, __read, __spread } from "tslib";
import { Injectable } from '@angular/core';
import { PaginationConfig } from './config/pagination.config';
import { PaginationItemType, PaginationNavigationPosition, } from './pagination.model';
import * as i0 from "@angular/core";
import * as i1 from "./config/pagination.config";
var FALLBACK_PAGINATION_OPTIONS = {
    rangeCount: 3,
    dotsLabel: '...',
    startLabel: '«',
    previousLabel: '‹',
    nextLabel: '›',
    endLabel: '»',
};
/**
 * Builds a pagination structures based on a pageCount and current page number.
 * There are various {@link PaginationConfig} options which can be used to configure
 * the behaviour of the build. Alternatively, CSS can be used to further customise
 * the pagination.
 *
 * Examples:
 * The full blown pagination items contain the follow elements:
 *
 * `« ‹ 1 ... 4 (5) 6 ... 9 › »`
 *
 * This includes pagination items to the following pages:
 * - start page
 * - previous page
 * - first page
 * - page range
 * - last page
 * - next page
 * - end page
 *
 * All of those links are configurable, including the size of the page range.
 * The current page will always be centered in the page range to provide direct access
 * to the previous and next page.
 */
var PaginationBuilder = /** @class */ (function () {
    function PaginationBuilder(paginationConfig) {
        this.paginationConfig = paginationConfig;
    }
    /**
     * Builds a list of `PaginationItem`. The give pageCount and current are used
     * to build out the full pagination. There are various {@link PaginationConfig} options
     * which can be used to configure the behaviour of the build. Alternatively, CSS
     * can be used to further specialize visibility of the pagination.
     *
     * @param pageCount The total number of pages
     * @param current The current page number, 0-index based
     * @returns An array of `PaginationItem`
     */
    PaginationBuilder.prototype.paginate = function (pageCount, current) {
        var pages = [];
        if (pageCount < 2) {
            return pages;
        }
        this.addPages(pages, pageCount, current);
        this.addDots(pages, pageCount);
        this.addFirstLast(pages, pageCount);
        this.addNavigation(pages, pageCount, current);
        return pages;
    };
    /**
     * Returns the current page with surrounding pages (based on the `config.rangeCount`).
     * The current page is always centered to provide direct access to the previous and next page.
     *
     * @param pages The list of page items that is used to amend
     * @param pageCount The total number of pages
     * @param current The current page number, 0-index based
     */
    PaginationBuilder.prototype.addPages = function (pages, pageCount, current) {
        var start = this.getStartOfRange(pageCount, current);
        var max = Math.min(this.config.rangeCount, pageCount);
        Array.from(Array(max)).forEach(function (_, i) {
            pages.push({
                number: i + start,
                label: String(i + start + 1),
                type: PaginationItemType.PAGE,
            });
        });
    };
    /**
     * Adds dots before and after the given pages, if configured (defaults to true).
     * If the dots only represent a single page, the page number is added instead of
     * the dots, unless the configuration requires dots always.
     *
     * @param pages The list of page items that is used to amend
     * @param pageCount The total number of pages
     */
    PaginationBuilder.prototype.addDots = function (pages, pageCount) {
        var _this = this;
        if (!this.config.addDots) {
            return;
        }
        var addFirstGap = function () {
            var firstItemNumber = pages[0].number;
            var gapNumber = _this.config.addFirst ? 1 : 0;
            if (firstItemNumber > gapNumber) {
                var isGap = !_this.config.substituteDotsForSingularPage ||
                    firstItemNumber !== gapNumber + 1;
                var isSubstitued = _this.config.addFirst &&
                    _this.config.substituteDotsForSingularPage &&
                    gapNumber === 0;
                var type = isGap
                    ? PaginationItemType.GAP
                    : isSubstitued
                        ? PaginationItemType.FIRST
                        : PaginationItemType.PAGE;
                return [
                    Object.assign({
                        label: isGap ? _this.config.dotsLabel : String(gapNumber + 1),
                        type: type,
                    }, isGap ? null : { number: gapNumber }),
                ];
            }
            else
                return [];
        };
        var addLastGap = function () {
            var nextPageNumber = pages[pages.length - 1].number + 1;
            var last = pageCount - (_this.config.addLast ? 2 : 1);
            if (nextPageNumber <= last) {
                var isSubstitued = _this.config.addLast &&
                    _this.config.substituteDotsForSingularPage &&
                    nextPageNumber === last;
                var isGap = nextPageNumber <
                    pageCount -
                        (_this.config.substituteDotsForSingularPage ? 1 : 0) -
                        (_this.config.addLast ? 1 : 0);
                var type = isGap
                    ? PaginationItemType.GAP
                    : isSubstitued
                        ? PaginationItemType.LAST
                        : PaginationItemType.PAGE;
                return [
                    Object.assign({
                        label: isGap ? _this.config.dotsLabel : String(nextPageNumber + 1),
                        type: type,
                    }, isGap ? null : { number: nextPageNumber }),
                ];
            }
            else
                return [];
        };
        pages.unshift.apply(pages, __spread(addFirstGap()));
        pages.push.apply(pages, __spread(addLastGap()));
    };
    /**
     * Add links to the first and last page, if configured to do so.
     *
     * @param pages The list of page items that is used to amend
     * @param pageCount The total number of pages
     *
     */
    PaginationBuilder.prototype.addFirstLast = function (pages, pageCount) {
        if (this.config.addFirst && pages[0].number !== 0) {
            pages.unshift({
                number: 0,
                label: '1',
                type: PaginationItemType.FIRST,
            });
        }
        if (this.config.addLast &&
            pages[pages.length - 1].number !== pageCount - 1) {
            pages.push({
                number: pageCount - 1,
                label: String(pageCount),
                type: PaginationItemType.LAST,
            });
        }
    };
    /**
     * Add links to the start, previous, next and last page, if configured to do so.
     * The order of the links can be configured by using the {@link PaginationConfig},
     * using the `PaginationNavigationPosition` (`BEFORE` or `AFTER`).
     * The `PaginationNavigationPosition` allows for 3 flavours:
     *
     * - by default the pagination starts with start and previous and ends with the next and end links
     * - BEFORE – all navigation links are added in the front of the pagination list
     * - AFTER – all navigation links are pushed to the end of the pagination list
     *
     * @param pages The list of page items that is used to amend
     * @param pageCount The total number of pages
     * @param current The current page number, 0-index based
     *
     */
    PaginationBuilder.prototype.addNavigation = function (pages, pageCount, current) {
        var before = this.getBeforeLinks(current);
        var after = this.getAfter(pageCount, current);
        var pos = this.config.navigationPosition;
        if (!pos || pos === PaginationNavigationPosition.ASIDE) {
            pages.unshift.apply(pages, __spread(before));
            pages.push.apply(pages, __spread(after));
        }
        else {
            if (pos === PaginationNavigationPosition.BEFORE) {
                pages.unshift.apply(pages, __spread(before, after));
            }
            if (pos === PaginationNavigationPosition.AFTER) {
                pages.push.apply(pages, __spread(before, after));
            }
        }
    };
    /**
     * Returns the start and previous links, if applicable.
     */
    PaginationBuilder.prototype.getBeforeLinks = function (current) {
        var _this = this;
        var list = [];
        if (this.config.addStart) {
            var start = function () {
                return Object.assign({
                    label: _this.config.startLabel,
                    type: PaginationItemType.START,
                }, current > 0 ? { number: 0 } : null);
            };
            list.push(start());
        }
        if (this.config.addPrevious) {
            var previous = function () {
                return Object.assign({
                    label: _this.config.previousLabel,
                    type: PaginationItemType.PREVIOUS,
                }, current > 0 ? { number: current - 1 } : null);
            };
            list.push(previous());
        }
        return list;
    };
    /**
     * Returns the next and end links, if applicable.
     */
    PaginationBuilder.prototype.getAfter = function (pageCount, current) {
        var _this = this;
        var list = [];
        if (this.config.addNext) {
            var next = function () {
                return Object.assign({
                    label: _this.config.nextLabel,
                    type: PaginationItemType.NEXT,
                }, current < pageCount - 1 ? { number: current + 1 } : null);
            };
            list.push(next());
        }
        if (this.config.addEnd) {
            var end = function () {
                return Object.assign({
                    label: _this.config.endLabel,
                    type: PaginationItemType.END,
                }, current < pageCount - 1 ? { number: pageCount - 1 } : null);
            };
            list.push(end());
        }
        return list;
    };
    /**
     * Resolves the first page of the range we need to build.
     * This is the page that is leading up to the range of the
     * current page.
     *
     * @param pageCount The total number of pages.
     * @param current The current page number, 0-index based.
     */
    PaginationBuilder.prototype.getStartOfRange = function (pageCount, current) {
        var count = this.config.rangeCount - 1;
        // the least number of pages before and after the current
        var delta = Math.round(count / 2);
        // ensure that we start with at least the first page
        var minStart = Math.max(0, current - delta);
        // ensures that we start with at least 1 and do not pass the last range
        var maxStart = Math.max(0, pageCount - count - 1);
        // ensure that we get at least a full range at the end
        return Math.min(maxStart, minStart);
    };
    Object.defineProperty(PaginationBuilder.prototype, "config", {
        get: function () {
            return Object.assign(FALLBACK_PAGINATION_OPTIONS, this.paginationConfig.pagination);
        },
        enumerable: true,
        configurable: true
    });
    PaginationBuilder.ctorParameters = function () { return [
        { type: PaginationConfig }
    ]; };
    PaginationBuilder.ɵprov = i0.ɵɵdefineInjectable({ factory: function PaginationBuilder_Factory() { return new PaginationBuilder(i0.ɵɵinject(i1.PaginationConfig)); }, token: PaginationBuilder, providedIn: "root" });
    PaginationBuilder = __decorate([
        Injectable({
            providedIn: 'root',
        })
    ], PaginationBuilder);
    return PaginationBuilder;
}());
export { PaginationBuilder };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnaW5hdGlvbi5idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHNwYXJ0YWN1cy9zdG9yZWZyb250LyIsInNvdXJjZXMiOlsic2hhcmVkL2NvbXBvbmVudHMvbGlzdC1uYXZpZ2F0aW9uL3BhZ2luYXRpb24vcGFnaW5hdGlvbi5idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzlELE9BQU8sRUFFTCxrQkFBa0IsRUFDbEIsNEJBQTRCLEdBRTdCLE1BQU0sb0JBQW9CLENBQUM7OztBQUU1QixJQUFNLDJCQUEyQixHQUFzQjtJQUNyRCxVQUFVLEVBQUUsQ0FBQztJQUNiLFNBQVMsRUFBRSxLQUFLO0lBQ2hCLFVBQVUsRUFBRSxHQUFHO0lBQ2YsYUFBYSxFQUFFLEdBQUc7SUFDbEIsU0FBUyxFQUFFLEdBQUc7SUFDZCxRQUFRLEVBQUUsR0FBRztDQUNkLENBQUM7QUFFRjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F1Qkc7QUFJSDtJQUNFLDJCQUFzQixnQkFBa0M7UUFBbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtJQUFHLENBQUM7SUFFNUQ7Ozs7Ozs7OztPQVNHO0lBQ0gsb0NBQVEsR0FBUixVQUFTLFNBQWlCLEVBQUUsT0FBZTtRQUN6QyxJQUFNLEtBQUssR0FBcUIsRUFBRSxDQUFDO1FBQ25DLElBQUksU0FBUyxHQUFHLENBQUMsRUFBRTtZQUNqQixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQy9CLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFD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QUFDLENBQUM7WUFDRixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7U0FDbEI7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFDRDs7Ozs7OztPQU9HO0lBQ0ssMkNBQWUsR0FBdkIsVUFBd0IsU0FBaUIsRUFBRSxPQUFlO1FBQ3hELElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQztRQUN6Qyx5REFBeUQ7UUFDekQsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFcEMsb0RBQW9EO1FBQ3BELElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLE9BQU8sR0FBRyxLQUFLLENBQUMsQ0FBQztRQUM5Qyx1RUFBdUU7UUFDdkUsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsU0FBUyxHQUFHLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztRQUVwRCxzREFBc0Q7UUFDdEQsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRUQsc0JBQVkscUNBQU07YUFBbEI7WUFDRSxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQ2xCLDJCQUEyQixFQUMzQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUNqQyxDQUFDO1FBQ0osQ0FBQzs7O09BQUE7O2dCQTFSdUMsZ0JBQWdCOzs7SUFEN0MsaUJBQWlCO1FBSDdCLFVBQVUsQ0FBQztZQUNWLFVBQVUsRUFBRSxNQUFNO1NBQ25CLENBQUM7T0FDVyxpQkFBaUIsQ0E0UjdCOzRCQXpVRDtDQXlVQyxBQTVSRCxJQTRSQztTQTVSWSxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFBhZ2luYXRpb25Db25maWcgfSBmcm9tICcuL2NvbmZpZy9wYWdpbmF0aW9uLmNvbmZpZyc7XHJcbmltcG9ydCB7XHJcbiAgUGFnaW5hdGlvbkl0ZW0sXHJcbiAgUGFnaW5hdGlvbkl0ZW1UeXBlLFxyXG4gIFBhZ2luYXRpb25OYXZpZ2F0aW9uUG9zaXRpb24sXHJcbiAgUGFnaW5hdGlvbk9wdGlvbnMsXHJcbn0gZnJvbSAnLi9wYWdpbmF0aW9uLm1vZGVsJztcclxuXHJcbmNvbnN0IEZBTExCQUNLX1BBR0lOQVRJT05fT1BUSU9OUzogUGFnaW5hdGlvbk9wdGlvbnMgPSB7XHJcbiAgcmFuZ2VDb3VudDogMyxcclxuICBkb3RzTGFiZWw6ICcuLi4nLFxyXG4gIHN0YXJ0TGFiZWw6ICfCqycsXHJcbiAgcHJldmlvdXNMYWJlbDogJ+KAuScsXHJcbiAgbmV4dExhYmVsOiAn4oC6JyxcclxuICBlbmRMYWJlbDogJ8K7JyxcclxufTtcclxuXHJcbi8qKlxyXG4gKiBCdWlsZHMgYSBwYWdpbmF0aW9uIHN0cnVjdHVyZXMgYmFzZWQgb24gYSBwYWdlQ291bnQgYW5kIGN1cnJlbnQgcGFnZSBudW1iZXIuXHJcbiAqIFRoZXJlIGFyZSB2YXJpb3VzIHtAbGluayBQYWdpbmF0aW9uQ29uZmlnfSBvcHRpb25zIHdoaWNoIGNhbiBiZSB1c2VkIHRvIGNvbmZpZ3VyZVxyXG4gKiB0aGUgYmVoYXZpb3VyIG9mIHRoZSBidWlsZC4gQWx0ZXJuYXRpdmVseSwgQ1NTIGNhbiBiZSB1c2VkIHRvIGZ1cnRoZXIgY3VzdG9taXNlXHJcbiAqIHRoZSBwYWdpbmF0aW9uLlxyXG4gKlxyXG4gKiBFeGFtcGxlczpcclxuICogVGhlIGZ1bGwgYmxvd24gcGFnaW5hdGlvbiBpdGVtcyBjb250YWluIHRoZSBmb2xsb3cgZWxlbWVudHM6XHJcbiAqXHJcbiAqIGDCqyDigLkgMSAuLi4gNCAoNSkgNiAuLi4gOSDigLogwrtgXHJcbiAqXHJcbiAqIFRoaXMgaW5jbHVkZXMgcGFnaW5hdGlvbiBpdGVtcyB0byB0aGUgZm9sbG93aW5nIHBhZ2VzOlxyXG4gKiAtIHN0YXJ0IHBhZ2VcclxuICogLSBwcmV2aW91cyBwYWdlXHJcbiAqIC0gZmlyc3QgcGFnZVxyXG4gKiAtIHBhZ2UgcmFuZ2VcclxuICogLSBsYXN0IHBhZ2VcclxuICogLSBuZXh0IHBhZ2VcclxuICogLSBlbmQgcGFnZVxyXG4gKlxyXG4gKiBBbGwgb2YgdGhvc2UgbGlua3MgYXJlIGNvbmZpZ3VyYWJsZSwgaW5jbHVkaW5nIHRoZSBzaXplIG9mIHRoZSBwYWdlIHJhbmdlLlxyXG4gKiBUaGUgY3VycmVudCBwYWdlIHdpbGwgYWx3YXlzIGJlIGNlbnRlcmVkIGluIHRoZSBwYWdlIHJhbmdlIHRvIHByb3ZpZGUgZGlyZWN0IGFjY2Vzc1xyXG4gKiB0byB0aGUgcHJldmlvdXMgYW5kIG5leHQgcGFnZS5cclxuICovXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCcsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBQYWdpbmF0aW9uQnVpbGRlciB7XHJcbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIHBhZ2luYXRpb25Db25maWc6IFBhZ2luYXRpb25Db25maWcpIHt9XHJcblxyXG4gIC8qKlxyXG4gICAqIEJ1aWxkcyBhIGxpc3Qgb2YgYFBhZ2luYXRpb25JdGVtYC4gVGhlIGdpdmUgcGFnZUNvdW50IGFuZCBjdXJyZW50IGFyZSB1c2VkXHJcbiAgICogdG8gYnVpbGQgb3V0IHRoZSBmdWxsIHBhZ2luYXRpb24uIFRoZXJlIGFyZSB2YXJpb3VzIHtAbGluayBQYWdpbmF0aW9uQ29uZmlnfSBvcHRpb25zXHJcbiAgICogd2hpY2ggY2FuIGJlIHVzZWQgdG8gY29uZmlndXJlIHRoZSBiZWhhdmlvdXIgb2YgdGhlIGJ1aWxkLiBBbHRlcm5hdGl2ZWx5LCBDU1NcclxuICAgKiBjYW4gYmUgdXNlZCB0byBmdXJ0aGVyIHNwZWNpYWxpemUgdmlzaWJpbGl0eSBvZiB0aGUgcGFnaW5hdGlvbi5cclxuICAgKlxyXG4gICAqIEBwYXJhbSBwYWdlQ291bnQgVGhlIHRvdGFsIG51bWJlciBvZiBwYWdlc1xyXG4gICAqIEBwYXJhbSBjdXJyZW50IFRoZSBjdXJyZW50IHBhZ2UgbnVtYmVyLCAwLWluZGV4IGJhc2VkXHJcbiAgICogQHJldHVybnMgQW4gYXJyYXkgb2YgYFBhZ2luYXRpb25JdGVtYFxyXG4gICAqL1xyXG4gIHBhZ2luYXRlKHBhZ2VDb3VudDogbnVtYmVyLCBjdXJyZW50OiBudW1iZXIpOiBQYWdpbmF0aW9uSXRlbVtdIHtcclxuICAgIGNvbnN0IHBhZ2VzOiBQYWdpbmF0aW9uSXRlbVtdID0gW107XHJcbiAgICBpZiAocGFnZUNvdW50IDwgMikge1xyXG4gICAgICByZXR1cm4gcGFnZXM7XHJcbiAgICB9XHJcbiAgICB0aGlzLmFkZFBhZ2VzKHBhZ2VzLCBwYWdlQ291bnQsIGN1cnJlbnQpO1xyXG4gICAgdGhpcy5hZGREb3RzKHBhZ2VzLCBwYWdlQ291bnQpO1xyXG4gICAgdGhpcy5hZGRGaXJzdExhc3QocGFnZXMsIHBhZ2VDb3VudCk7XHJcbiAgICB0aGlzLmFkZE5hdmlnYXRpb24ocGFnZXMsIHBhZ2VDb3VudCwgY3VycmVudCk7XHJcblxyXG4gICAgcmV0dXJuIHBhZ2VzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJucyB0aGUgY3VycmVudCBwYWdlIHdpdGggc3Vycm91bmRpbmcgcGFnZXMgKGJhc2VkIG9uIHRoZSBgY29uZmlnLnJhbmdlQ291bnRgKS5cclxuICAgKiBUaGUgY3VycmVudCBwYWdlIGlzIGFsd2F5cyBjZW50ZXJlZCB0byBwcm92aWRlIGRpcmVjdCBhY2Nlc3MgdG8gdGhlIHByZXZpb3VzIGFuZCBuZXh0IHBhZ2UuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gcGFnZXMgVGhlIGxpc3Qgb2YgcGFnZSBpdGVtcyB0aGF0IGlzIHVzZWQgdG8gYW1lbmRcclxuICAgKiBAcGFyYW0gcGFnZUNvdW50IFRoZSB0b3RhbCBudW1iZXIgb2YgcGFnZXNcclxuICAgKiBAcGFyYW0gY3VycmVudCBUaGUgY3VycmVudCBwYWdlIG51bWJlciwgMC1pbmRleCBiYXNlZFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBhZGRQYWdlcyhcclxuICAgIHBhZ2VzOiBQYWdpbmF0aW9uSXRlbVtdLFxyXG4gICAgcGFnZUNvdW50OiBudW1iZXIsXHJcbiAgICBjdXJyZW50OiBudW1iZXJcclxuICApOiB2b2lkIHtcclxuICAgIGNvbnN0IHN0YXJ0ID0gdGhpcy5nZXRTdGFydE9mUmFuZ2UocGFnZUNvdW50LCBjdXJyZW50KTtcclxuICAgIGNvbnN0IG1heCA9IE1hdGgubWluKHRoaXMuY29uZmlnLnJhbmdlQ291bnQsIHBhZ2VDb3VudCk7XHJcblxyXG4gICAgQXJyYXkuZnJvbShBcnJheShtYXgpKS5mb3JFYWNoKChfLCBpKSA9PiB7XHJcbiAgICAgIHBhZ2VzLnB1c2goe1xyXG4gICAgICAgIG51bWJlcjogaSArIHN0YXJ0LFxyXG4gICAgICAgIGxhYmVsOiBTdHJpbmcoaSArIHN0YXJ0ICsgMSksXHJcbiAgICAgICAgdHlwZTogUGFnaW5hdGlvbkl0ZW1UeXBlLlBBR0UsXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBZGRzIGRvdHMgYmVmb3JlIGFuZCBhZnRlciB0aGUgZ2l2ZW4gcGFnZXMsIGlmIGNvbmZpZ3VyZWQgKGRlZmF1bHRzIHRvIHRydWUpLlxyXG4gICAqIElmIHRoZSBkb3RzIG9ubHkgcmVwcmVzZW50IGEgc2luZ2xlIHBhZ2UsIHRoZSBwYWdlIG51bWJlciBpcyBhZGRlZCBpbnN0ZWFkIG9mXHJcbiAgICogdGhlIGRvdHMsIHVubGVzcyB0aGUgY29uZmlndXJhdGlvbiByZXF1aXJlcyBkb3RzIGFsd2F5cy5cclxuICAgKlxyXG4gICAqIEBwYXJhbSBwYWdlcyBUaGUgbGlzdCBvZiBwYWdlIGl0ZW1zIHRoYXQgaXMgdXNlZCB0byBhbWVuZFxyXG4gICAqIEBwYXJhbSBwYWdlQ291bnQgVGhlIHRvdGFsIG51bWJlciBvZiBwYWdlc1xyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBhZGREb3RzKHBhZ2VzOiBQYWdpbmF0aW9uSXRlbVtdLCBwYWdlQ291bnQ6IG51bWJlcik6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLmNvbmZpZy5hZGREb3RzKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBhZGRGaXJzdEdhcCA9ICgpID0+IHtcclxuICAgICAgY29uc3QgZmlyc3RJdGVtTnVtYmVyID0gcGFnZXNbMF0ubnVtYmVyO1xyXG4gICAgICBjb25zdCBnYXBOdW1iZXIgPSB0aGlzLmNvbmZpZy5hZGRGaXJzdCA/IDEgOiAwO1xyXG4gICAgICBpZiAoZmlyc3RJdGVtTnVtYmVyID4gZ2FwTnVtYmVyKSB7XHJcbiAgICAgICAgY29uc3QgaXNHYXAgPVxyXG4gICAgICAgICAgIXRoaXMuY29uZmlnLnN1YnN0aXR1dGVEb3RzRm9yU2luZ3VsYXJQYWdlIHx8XHJcbiAgICAgICAgICBmaXJzdEl0ZW1OdW1iZXIgIT09IGdhcE51bWJlciArIDE7XHJcbiAgICAgICAgY29uc3QgaXNTdWJzdGl0dWVkID1cclxuICAgICAgICAgIHRoaXMuY29uZmlnLmFkZEZpcnN0ICYmXHJcbiAgICAgICAgICB0aGlzLmNvbmZpZy5zdWJzdGl0dXRlRG90c0ZvclNpbmd1bGFyUGFnZSAmJlxyXG4gICAgICAgICAgZ2FwTnVtYmVyID09PSAwO1xyXG4gICAgICAgIGNvbnN0IHR5cGUgPSBpc0dhcFxyXG4gICAgICAgICAgPyBQYWdpbmF0aW9uSXRlbVR5cGUuR0FQXHJcbiAgICAgICAgICA6IGlzU3Vic3RpdHVlZFxyXG4gICAgICAgICAgPyBQYWdpbmF0aW9uSXRlbVR5cGUuRklSU1RcclxuICAgICAgICAgIDogUGFnaW5hdGlvbkl0ZW1UeXBlLlBBR0U7XHJcbiAgICAgICAgcmV0dXJuIFtcclxuICAgICAgICAgIE9iamVjdC5hc3NpZ24oXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICBsYWJlbDogaXNHYXAgPyB0aGlzLmNvbmZpZy5kb3RzTGFiZWwgOiBTdHJpbmcoZ2FwTnVtYmVyICsgMSksXHJcbiAgICAgICAgICAgICAgdHlwZSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgaXNHYXAgPyBudWxsIDogeyBudW1iZXI6IGdhcE51bWJlciB9XHJcbiAgICAgICAgICApLFxyXG4gICAgICAgIF07XHJcbiAgICAgIH0gZWxzZSByZXR1cm4gW107XHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IGFkZExhc3RHYXAgPSAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5leHRQYWdlTnVtYmVyID0gcGFnZXNbcGFnZXMubGVuZ3RoIC0gMV0ubnVtYmVyICsgMTtcclxuICAgICAgY29uc3QgbGFzdCA9IHBhZ2VDb3VudCAtICh0aGlzLmNvbmZpZy5hZGRMYXN0ID8gMiA6IDEpO1xyXG4gICAgICBpZiAobmV4dFBhZ2VOdW1iZXIgPD0gbGFzdCkge1xyXG4gICAgICAgIGNvbnN0IGlzU3Vic3RpdHVlZCA9XHJcbiAgICAgICAgICB0aGlzLmNvbmZpZy5hZGRMYXN0ICYmXHJcbiAgICAgICAgICB0aGlzLmNvbmZpZy5zdWJzdGl0dXRlRG90c0ZvclNpbmd1bGFyUGFnZSAmJlxyXG4gICAgICAgICAgbmV4dFBhZ2VOdW1iZXIgPT09IGxhc3Q7XHJcbiAgICAgICAgY29uc3QgaXNHYXAgPVxyXG4gICAgICAgICAgbmV4dFBhZ2VOdW1iZXIgPFxyXG4gICAgICAgICAgcGFnZUNvdW50IC1cclxuICAgICAgICAgICAgKHRoaXMuY29uZmlnLnN1YnN0aXR1dGVEb3RzRm9yU2luZ3VsYXJQYWdlID8gMSA6IDApIC1cclxuICAgICAgICAgICAgKHRoaXMuY29uZmlnLmFkZExhc3QgPyAxIDogMCk7XHJcblxyXG4gICAgICAgIGNvbnN0IHR5cGUgPSBpc0dhcFxyXG4gICAgICAgICAgPyBQYWdpbmF0aW9uSXRlbVR5cGUuR0FQXHJcbiAgICAgICAgICA6IGlzU3Vic3RpdHVlZFxyXG4gICAgICAgICAgPyBQYWdpbmF0aW9uSXRlbVR5cGUuTEFTVFxyXG4gICAgICAgICAgOiBQYWdpbmF0aW9uSXRlbVR5cGUuUEFHRTtcclxuICAgICAgICByZXR1cm4gW1xyXG4gICAgICAgICAgT2JqZWN0LmFzc2lnbihcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgIGxhYmVsOiBpc0dhcCA/IHRoaXMuY29uZmlnLmRvdHNMYWJlbCA6IFN0cmluZyhuZXh0UGFnZU51bWJlciArIDEpLFxyXG4gICAgICAgICAgICAgIHR5cGUsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGlzR2FwID8gbnVsbCA6IHsgbnVtYmVyOiBuZXh0UGFnZU51bWJlciB9XHJcbiAgICAgICAgICApLFxyXG4gICAgICAgIF07XHJcbiAgICAgIH0gZWxzZSByZXR1cm4gW107XHJcbiAgICB9O1xyXG5cclxuICAgIHBhZ2VzLnVuc2hpZnQoLi4uYWRkRmlyc3RHYXAoKSk7XHJcbiAgICBwYWdlcy5wdXNoKC4uLmFkZExhc3RHYXAoKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBZGQgbGlua3MgdG8gdGhlIGZpcnN0IGFuZCBsYXN0IHBhZ2UsIGlmIGNvbmZpZ3VyZWQgdG8gZG8gc28uXHJcbiAgICpcclxuICAgKiBAcGFyYW0gcGFnZXMgVGhlIGxpc3Qgb2YgcGFnZSBpdGVtcyB0aGF0IGlzIHVzZWQgdG8gYW1lbmRcclxuICAgKiBAcGFyYW0gcGFnZUNvdW50IFRoZSB0b3RhbCBudW1iZXIgb2YgcGFnZXNcclxuICAgKlxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBhZGRGaXJzdExhc3QocGFnZXM6IFBhZ2luYXRpb25JdGVtW10sIHBhZ2VDb3VudDogbnVtYmVyKSB7XHJcbiAgICBpZiAodGhpcy5jb25maWcuYWRkRmlyc3QgJiYgcGFnZXNbMF0ubnVtYmVyICE9PSAwKSB7XHJcbiAgICAgIHBhZ2VzLnVuc2hpZnQoe1xyXG4gICAgICAgIG51bWJlcjogMCxcclxuICAgICAgICBsYWJlbDogJzEnLFxyXG4gICAgICAgIHR5cGU6IFBhZ2luYXRpb25JdGVtVHlwZS5GSVJTVCxcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpZiAoXHJcbiAgICAgIHRoaXMuY29uZmlnLmFkZExhc3QgJiZcclxuICAgICAgcGFnZXNbcGFnZXMubGVuZ3RoIC0gMV0ubnVtYmVyICE9PSBwYWdlQ291bnQgLSAxXHJcbiAgICApIHtcclxuICAgICAgcGFnZXMucHVzaCh7XHJcbiAgICAgICAgbnVtYmVyOiBwYWdlQ291bnQgLSAxLFxyXG4gICAgICAgIGxhYmVsOiBTdHJpbmcocGFnZUNvdW50KSxcclxuICAgICAgICB0eXBlOiBQYWdpbmF0aW9uSXRlbVR5cGUuTEFTVCxcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBZGQgbGlua3MgdG8gdGhlIHN0YXJ0LCBwcmV2aW91cywgbmV4dCBhbmQgbGFzdCBwYWdlLCBpZiBjb25maWd1cmVkIHRvIGRvIHNvLlxyXG4gICAqIFRoZSBvcmRlciBvZiB0aGUgbGlua3MgY2FuIGJlIGNvbmZpZ3VyZWQgYnkgdXNpbmcgdGhlIHtAbGluayBQYWdpbmF0aW9uQ29uZmlnfSxcclxuICAgKiB1c2luZyB0aGUgYFBhZ2luYXRpb25OYXZpZ2F0aW9uUG9zaXRpb25gIChgQkVGT1JFYCBvciBgQUZURVJgKS5cclxuICAgKiBUaGUgYFBhZ2luYXRpb25OYXZpZ2F0aW9uUG9zaXRpb25gIGFsbG93cyBmb3IgMyBmbGF2b3VyczpcclxuICAgKlxyXG4gICAqIC0gYnkgZGVmYXVsdCB0aGUgcGFnaW5hdGlvbiBzdGFydHMgd2l0aCBzdGFydCBhbmQgcHJldmlvdXMgYW5kIGVuZHMgd2l0aCB0aGUgbmV4dCBhbmQgZW5kIGxpbmtzXHJcbiAgICogLSBCRUZPUkUg4oCTwqBhbGwgbmF2aWdhdGlvbiBsaW5rcyBhcmUgYWRkZWQgaW4gdGhlIGZyb250IG9mIHRoZSBwYWdpbmF0aW9uIGxpc3RcclxuICAgKiAtIEFGVEVSIOKAk8KgYWxsIG5hdmlnYXRpb24gbGlua3MgYXJlIHB1c2hlZCB0byB0aGUgZW5kIG9mIHRoZSBwYWdpbmF0aW9uIGxpc3RcclxuICAgKlxyXG4gICAqIEBwYXJhbSBwYWdlcyBUaGUgbGlzdCBvZiBwYWdlIGl0ZW1zIHRoYXQgaXMgdXNlZCB0byBhbWVuZFxyXG4gICAqIEBwYXJhbSBwYWdlQ291bnQgVGhlIHRvdGFsIG51bWJlciBvZiBwYWdlc1xyXG4gICAqIEBwYXJhbSBjdXJyZW50IFRoZSBjdXJyZW50IHBhZ2UgbnVtYmVyLCAwLWluZGV4IGJhc2VkXHJcbiAgICpcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgYWRkTmF2aWdhdGlvbihcclxuICAgIHBhZ2VzOiBQYWdpbmF0aW9uSXRlbVtdLFxyXG4gICAgcGFnZUNvdW50OiBudW1iZXIsXHJcbiAgICBjdXJyZW50OiBudW1iZXJcclxuICApOiB2b2lkIHtcclxuICAgIGNvbnN0IGJlZm9yZSA9IHRoaXMuZ2V0QmVmb3JlTGlua3MoY3VycmVudCk7XHJcbiAgICBjb25zdCBhZnRlciA9IHRoaXMuZ2V0QWZ0ZXIocGFnZUNvdW50LCBjdXJyZW50KTtcclxuICAgIGNvbnN0IHBvcyA9IHRoaXMuY29uZmlnLm5hdmlnYXRpb25Qb3NpdGlvbjtcclxuICAgIGlmICghcG9zIHx8IHBvcyA9PT0gUGFnaW5hdGlvbk5hdmlnYXRpb25Qb3NpdGlvbi5BU0lERSkge1xyXG4gICAgICBwYWdlcy51bnNoaWZ0KC4uLmJlZm9yZSk7XHJcbiAgICAgIHBhZ2VzLnB1c2goLi4uYWZ0ZXIpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaWYgKHBvcyA9PT0gUGFnaW5hdGlvbk5hdmlnYXRpb25Qb3NpdGlvbi5CRUZPUkUpIHtcclxuICAgICAgICBwYWdlcy51bnNoaWZ0KC4uLmJlZm9yZSwgLi4uYWZ0ZXIpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChwb3MgPT09IFBhZ2luYXRpb25OYXZpZ2F0aW9uUG9zaXRpb24uQUZURVIpIHtcclxuICAgICAgICBwYWdlcy5wdXNoKC4uLmJlZm9yZSwgLi4uYWZ0ZXIpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIHRoZSBzdGFydCBhbmQgcHJldmlvdXMgbGlua3MsIGlmIGFwcGxpY2FibGUuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRCZWZvcmVMaW5rcyhjdXJyZW50OiBudW1iZXIpOiBQYWdpbmF0aW9uSXRlbVtdIHtcclxuICAgIGNvbnN0IGxpc3QgPSBbXTtcclxuXHJcbiAgICBpZiAodGhpcy5jb25maWcuYWRkU3RhcnQpIHtcclxuICAgICAgY29uc3Qgc3RhcnQgPSAoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oXHJcbiAgICAgICAgICB7XHJcbiAgICAgICAgICAgIGxhYmVsOiB0aGlzLmNvbmZpZy5zdGFydExhYmVsLFxyXG4gICAgICAgICAgICB0eXBlOiBQYWdpbmF0aW9uSXRlbVR5cGUuU1RBUlQsXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgY3VycmVudCA+IDAgPyB7IG51bWJlcjogMCB9IDogbnVsbFxyXG4gICAgICAgICk7XHJcbiAgICAgIH07XHJcbiAgICAgIGxpc3QucHVzaChzdGFydCgpKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmNvbmZpZy5hZGRQcmV2aW91cykge1xyXG4gICAgICBjb25zdCBwcmV2aW91cyA9ICgpID0+IHtcclxuICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgbGFiZWw6IHRoaXMuY29uZmlnLnByZXZpb3VzTGFiZWwsXHJcbiAgICAgICAgICAgIHR5cGU6IFBhZ2luYXRpb25JdGVtVHlwZS5QUkVWSU9VUyxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBjdXJyZW50ID4gMCA/IHsgbnVtYmVyOiBjdXJyZW50IC0gMSB9IDogbnVsbFxyXG4gICAgICAgICk7XHJcbiAgICAgIH07XHJcbiAgICAgIGxpc3QucHVzaChwcmV2aW91cygpKTtcclxuICAgIH1cclxuICAgIHJldHVybiBsaXN0O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJucyB0aGUgbmV4dCBhbmQgZW5kIGxpbmtzLCBpZiBhcHBsaWNhYmxlLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0QWZ0ZXIocGFnZUNvdW50OiBudW1iZXIsIGN1cnJlbnQ6IG51bWJlcik6IFBhZ2luYXRpb25JdGVtW10ge1xyXG4gICAgY29uc3QgbGlzdCA9IFtdO1xyXG5cclxuICAgIGlmICh0aGlzLmNvbmZpZy5hZGROZXh0KSB7XHJcbiAgICAgIGNvbnN0IG5leHQgPSAoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oXHJcbiAgICAgICAgICB7XHJcbiAgICAgICAgICAgIGxhYmVsOiB0aGlzLmNvbmZpZy5uZXh0TGFiZWwsXHJcbiAgICAgICAgICAgIHR5cGU6IFBhZ2luYXRpb25JdGVtVHlwZS5ORVhULFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIGN1cnJlbnQgPCBwYWdlQ291bnQgLSAxID8geyBudW1iZXI6IGN1cnJlbnQgKyAxIH0gOiBudWxsXHJcbiAgICAgICAgKTtcclxuICAgICAgfTtcclxuICAgICAgbGlzdC5wdXNoKG5leHQoKSk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5jb25maWcuYWRkRW5kKSB7XHJcbiAgICAgIGNvbnN0IGVuZCA9ICgpID0+IHtcclxuICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgbGFiZWw6IHRoaXMuY29uZmlnLmVuZExhYmVsLFxyXG4gICAgICAgICAgICB0eXBlOiBQYWdpbmF0aW9uSXRlbVR5cGUuRU5ELFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIGN1cnJlbnQgPCBwYWdlQ291bnQgLSAxID8geyBudW1iZXI6IHBhZ2VDb3VudCAtIDEgfSA6IG51bGxcclxuICAgICAgICApO1xyXG4gICAgICB9O1xyXG4gICAgICBsaXN0LnB1c2goZW5kKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBsaXN0O1xyXG4gIH1cclxuICAvKipcclxuICAgKiBSZXNvbHZlcyB0aGUgZmlyc3QgcGFnZSBvZiB0aGUgcmFuZ2Ugd2UgbmVlZCB0byBidWlsZC5cclxuICAgKiBUaGlzIGlzIHRoZSBwYWdlIHRoYXQgaXMgbGVhZGluZyB1cCB0byB0aGUgcmFuZ2Ugb2YgdGhlXHJcbiAgICogY3VycmVudCBwYWdlLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIHBhZ2VDb3VudCBUaGUgdG90YWwgbnVtYmVyIG9mIHBhZ2VzLlxyXG4gICAqIEBwYXJhbSBjdXJyZW50IFRoZSBjdXJyZW50IHBhZ2UgbnVtYmVyLCAwLWluZGV4IGJhc2VkLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0U3RhcnRPZlJhbmdlKHBhZ2VDb3VudDogbnVtYmVyLCBjdXJyZW50OiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgY29uc3QgY291bnQgPSB0aGlzLmNvbmZpZy5yYW5nZUNvdW50IC0gMTtcclxuICAgIC8vIHRoZSBsZWFzdCBudW1iZXIgb2YgcGFnZXMgYmVmb3JlIGFuZCBhZnRlciB0aGUgY3VycmVudFxyXG4gICAgY29uc3QgZGVsdGEgPSBNYXRoLnJvdW5kKGNvdW50IC8gMik7XHJcblxyXG4gICAgLy8gZW5zdXJlIHRoYXQgd2Ugc3RhcnQgd2l0aCBhdCBsZWFzdCB0aGUgZmlyc3QgcGFnZVxyXG4gICAgY29uc3QgbWluU3RhcnQgPSBNYXRoLm1heCgwLCBjdXJyZW50IC0gZGVsdGEpO1xyXG4gICAgLy8gZW5zdXJlcyB0aGF0IHdlIHN0YXJ0IHdpdGggYXQgbGVhc3QgMSBhbmQgZG8gbm90IHBhc3MgdGhlIGxhc3QgcmFuZ2VcclxuICAgIGNvbnN0IG1heFN0YXJ0ID0gTWF0aC5tYXgoMCwgcGFnZUNvdW50IC0gY291bnQgLSAxKTtcclxuXHJcbiAgICAvLyBlbnN1cmUgdGhhdCB3ZSBnZXQgYXQgbGVhc3QgYSBmdWxsIHJhbmdlIGF0IHRoZSBlbmRcclxuICAgIHJldHVybiBNYXRoLm1pbihtYXhTdGFydCwgbWluU3RhcnQpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXQgY29uZmlnKCk6IFBhZ2luYXRpb25PcHRpb25zIHtcclxuICAgIHJldHVybiBPYmplY3QuYXNzaWduKFxyXG4gICAgICBGQUxMQkFDS19QQUdJTkFUSU9OX09QVElPTlMsXHJcbiAgICAgIHRoaXMucGFnaW5hdGlvbkNvbmZpZy5wYWdpbmF0aW9uXHJcbiAgICApO1xyXG4gIH1cclxufVxyXG4iXX0=
import { __decorate, __param } from "tslib";
import { isPlatformServer } from '@angular/common';
import { Inject, Injectable, PLATFORM_ID } from '@angular/core';
import { DeferLoadingStrategy } from '@spartacus/core';
import { of } from 'rxjs';
import { LayoutConfig } from '../config/layout-config';
import { IntersectionService } from './intersection.service';
import * as i0 from "@angular/core";
import * as i1 from "../config/layout-config";
import * as i2 from "./intersection.service";
/**
 * The defer loading serivce is used to defer loading of DOM elements
 * until the elements are required for the user experience.
 */
let DeferLoaderService = class DeferLoaderService {
    constructor(platformId, config, intersectionService) {
        this.platformId = platformId;
        this.config = config;
        this.intersectionService = intersectionService;
        this.globalLoadStrategy = config.deferredLoading
            ? config.deferredLoading.strategy
            : DeferLoadingStrategy.INSTANT;
    }
    /**
     * Defer loading till the element intersects the viewport.
     *
     * We evaluate whether we instantly load the element for different reasons:
     * - we run in SSR mode
     * - there's no global strategy given
     * - the global loading strategy is set to INSTANT loading,
     *   and the loading strategy in the given is not set to DEFER
     * - the loading strategy in the given options is set to INSTANT
     */
    load(element, options) {
        if (this.shouldLoadInstantly((options || {}).deferLoading)) {
            return of(true);
        }
        else {
            return this.intersectionService.isIntersected(element, options);
        }
    }
    shouldLoadInstantly(elementLoadingStrategy) {
        return (isPlatformServer(this.platformId) ||
            elementLoadingStrategy === DeferLoadingStrategy.INSTANT ||
            (elementLoadingStrategy !== DeferLoadingStrategy.DEFER &&
                this.globalLoadStrategy === DeferLoadingStrategy.INSTANT));
    }
};
DeferLoaderService.ctorParameters = () => [
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: LayoutConfig },
    { type: IntersectionService }
];
DeferLoaderService.ɵprov = i0.ɵɵdefineInjectable({ factory: function DeferLoaderService_Factory() { return new DeferLoaderService(i0.ɵɵinject(i0.PLATFORM_ID), i0.ɵɵinject(i1.LayoutConfig), i0.ɵɵinject(i2.IntersectionService)); }, token: DeferLoaderService, providedIn: "root" });
DeferLoaderService = __decorate([
    Injectable({
        providedIn: 'root',
    }),
    __param(0, Inject(PLATFORM_ID))
], DeferLoaderService);
export { DeferLoaderService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmZXItbG9hZGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ac3BhcnRhY3VzL3N0b3JlZnJvbnQvIiwic291cmNlcyI6WyJsYXlvdXQvbG9hZGluZy9kZWZlci1sb2FkZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3ZELE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRXZELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDOzs7O0FBRTdEOzs7R0FHRztBQUlILElBQWEsa0JBQWtCLEdBQS9CLE1BQWEsa0JBQWtCO0lBRzdCLFlBQytCLFVBQWtCLEVBQ3JDLE1BQW9CLEVBQ3BCLG1CQUF3QztRQUZyQixlQUFVLEdBQVYsVUFBVSxDQUFRO1FBQ3JDLFdBQU0sR0FBTixNQUFNLENBQWM7UUFDcEIsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUVsRCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsTUFBTSxDQUFDLGVBQWU7WUFDOUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsUUFBUTtZQUNqQyxDQUFDLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDO0lBQ25DLENBQUM7SUFFRDs7Ozs7Ozs7O09BU0c7SUFDSCxJQUFJLENBQ0YsT0FBb0IsRUFDcEIsT0FBNkI7UUFFN0IsSUFBSSxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDMUQsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDakI7YUFBTTtZQUNMLE9BQU8sSUFBSSxDQUFDLG1CQUFtQixDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDakU7SUFDSCxDQUFDO0lBRU8sbUJBQW1CLENBQ3pCLHNCQUE0QztRQUU1QyxPQUFPLENBQ0wsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUNqQyxzQkFBc0IsS0FBSyxvQkFBb0IsQ0FBQyxPQUFPO1lBQ3ZELENBQUMsc0JBQXNCLEtBQUssb0JBQW9CLENBQUMsS0FBSztnQkFDcEQsSUFBSSxDQUFDLGtCQUFrQixLQUFLLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxDQUM1RCxDQUFDO0lBQ0osQ0FBQztDQUNGLENBQUE7O1lBeEM0QyxNQUFNLHVCQUE5QyxNQUFNLFNBQUMsV0FBVztZQUNELFlBQVk7WUFDQyxtQkFBbUI7OztBQU56QyxrQkFBa0I7SUFIOUIsVUFBVSxDQUFDO1FBQ1YsVUFBVSxFQUFFLE1BQU07S0FDbkIsQ0FBQztJQUtHLFdBQUEsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0dBSlgsa0JBQWtCLENBNEM5QjtTQTVDWSxrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc1BsYXRmb3JtU2VydmVyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcclxuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBQTEFURk9STV9JRCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBEZWZlckxvYWRpbmdTdHJhdGVneSB9IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IExheW91dENvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9sYXlvdXQtY29uZmlnJztcclxuaW1wb3J0IHsgSW50ZXJzZWN0aW9uT3B0aW9ucyB9IGZyb20gJy4vaW50ZXJzZWN0aW9uLm1vZGVsJztcclxuaW1wb3J0IHsgSW50ZXJzZWN0aW9uU2VydmljZSB9IGZyb20gJy4vaW50ZXJzZWN0aW9uLnNlcnZpY2UnO1xyXG5cclxuLyoqXHJcbiAqIFRoZSBkZWZlciBsb2FkaW5nIHNlcml2Y2UgaXMgdXNlZCB0byBkZWZlciBsb2FkaW5nIG9mIERPTSBlbGVtZW50c1xyXG4gKiB1bnRpbCB0aGUgZWxlbWVudHMgYXJlIHJlcXVpcmVkIGZvciB0aGUgdXNlciBleHBlcmllbmNlLlxyXG4gKi9cclxuQEluamVjdGFibGUoe1xyXG4gIHByb3ZpZGVkSW46ICdyb290JyxcclxufSlcclxuZXhwb3J0IGNsYXNzIERlZmVyTG9hZGVyU2VydmljZSB7XHJcbiAgZ2xvYmFsTG9hZFN0cmF0ZWd5OiBEZWZlckxvYWRpbmdTdHJhdGVneTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ6IE9iamVjdCxcclxuICAgIHByb3RlY3RlZCBjb25maWc6IExheW91dENvbmZpZyxcclxuICAgIHByb3RlY3RlZCBpbnRlcnNlY3Rpb25TZXJ2aWNlOiBJbnRlcnNlY3Rpb25TZXJ2aWNlXHJcbiAgKSB7XHJcbiAgICB0aGlzLmdsb2JhbExvYWRTdHJhdGVneSA9IGNvbmZpZy5kZWZlcnJlZExvYWRpbmdcclxuICAgICAgPyBjb25maWcuZGVmZXJyZWRMb2FkaW5nLnN0cmF0ZWd5XHJcbiAgICAgIDogRGVmZXJMb2FkaW5nU3RyYXRlZ3kuSU5TVEFOVDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIERlZmVyIGxvYWRpbmcgdGlsbCB0aGUgZWxlbWVudCBpbnRlcnNlY3RzIHRoZSB2aWV3cG9ydC5cclxuICAgKlxyXG4gICAqIFdlIGV2YWx1YXRlIHdoZXRoZXIgd2UgaW5zdGFudGx5IGxvYWQgdGhlIGVsZW1lbnQgZm9yIGRpZmZlcmVudCByZWFzb25zOlxyXG4gICAqIC0gd2UgcnVuIGluIFNTUiBtb2RlXHJcbiAgICogLSB0aGVyZSdzIG5vIGdsb2JhbCBzdHJhdGVneSBnaXZlblxyXG4gICAqIC0gdGhlIGdsb2JhbCBsb2FkaW5nIHN0cmF0ZWd5IGlzIHNldCB0byBJTlNUQU5UIGxvYWRpbmcsXHJcbiAgICogICBhbmQgdGhlIGxvYWRpbmcgc3RyYXRlZ3kgaW4gdGhlIGdpdmVuIGlzIG5vdCBzZXQgdG8gREVGRVJcclxuICAgKiAtIHRoZSBsb2FkaW5nIHN0cmF0ZWd5IGluIHRoZSBnaXZlbiBvcHRpb25zIGlzIHNldCB0byBJTlNUQU5UXHJcbiAgICovXHJcbiAgbG9hZChcclxuICAgIGVsZW1lbnQ6IEhUTUxFbGVtZW50LFxyXG4gICAgb3B0aW9ucz86IEludGVyc2VjdGlvbk9wdGlvbnNcclxuICApOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIGlmICh0aGlzLnNob3VsZExvYWRJbnN0YW50bHkoKG9wdGlvbnMgfHwge30pLmRlZmVyTG9hZGluZykpIHtcclxuICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRoaXMuaW50ZXJzZWN0aW9uU2VydmljZS5pc0ludGVyc2VjdGVkKGVsZW1lbnQsIG9wdGlvbnMpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzaG91bGRMb2FkSW5zdGFudGx5KFxyXG4gICAgZWxlbWVudExvYWRpbmdTdHJhdGVneTogRGVmZXJMb2FkaW5nU3RyYXRlZ3lcclxuICApOiBib29sZWFuIHtcclxuICAgIHJldHVybiAoXHJcbiAgICAgIGlzUGxhdGZvcm1TZXJ2ZXIodGhpcy5wbGF0Zm9ybUlkKSB8fFxyXG4gICAgICBlbGVtZW50TG9hZGluZ1N0cmF0ZWd5ID09PSBEZWZlckxvYWRpbmdTdHJhdGVneS5JTlNUQU5UIHx8XHJcbiAgICAgIChlbGVtZW50TG9hZGluZ1N0cmF0ZWd5ICE9PSBEZWZlckxvYWRpbmdTdHJhdGVneS5ERUZFUiAmJlxyXG4gICAgICAgIHRoaXMuZ2xvYmFsTG9hZFN0cmF0ZWd5ID09PSBEZWZlckxvYWRpbmdTdHJhdGVneS5JTlNUQU5UKVxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuIl19
import { __decorate, __param } from "tslib";
import { Inject, Injectable } from '@angular/core';
import { Config } from '@spartacus/core';
import { BreakpointService } from '../../../layout/breakpoint/breakpoint.service';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/core";
import * as i2 from "../../../layout/breakpoint/breakpoint.service";
/**
 * Service which generates media URLs. It leverage the MediaContainer and MediaFormats so
 * that URLs and sizes are generated for the same media. This helps to improve performance
 * across difference devices and layouts.
 *
 * Media formats are optional, but highly recommended. The format will help the browser to
 * identify the right media for the right experience.
 *
 * The MediaService will generate absolute URLs in case relative URLs are provided for the Media.
 * The baseUrl is read from the `occConfig.backend.media.baseUrl` or
 * `occConfig.backend.occ.baseUrl`.
 */
let MediaService = class MediaService {
    constructor(config, 
    /**
     * The BreakpointService is no longer used in version 2.0 as the different size formats are
     * driven by configuration only. There's however a change that this service will play a role
     * in the near future, which is why we keep the constructor as-is.
     */
    breakpointService) {
        this.config = config;
        this.breakpointService = breakpointService;
    }
    /**
     * Returns a `Media` object with the main media (`src`) and various media (`src`)
     * for specific formats.
     */
    getMedia(mediaContainer, format, alt) {
        if (!mediaContainer) {
            return;
        }
        const mainMedia = mediaContainer.url
            ? mediaContainer
            : this.resolveMedia(mediaContainer, format);
        return {
            src: this.resolveAbsoluteUrl(mainMedia === null || mainMedia === void 0 ? void 0 : mainMedia.url),
            alt: alt || (mainMedia === null || mainMedia === void 0 ? void 0 : mainMedia.altText),
            srcset: this.resolveSrcSet(mediaContainer),
        };
    }
    /**
     * Creates the media formats in a logical sorted order. The map contains the
     * format key and the format size information. We do this only once for performance
     * benefits.
     */
    get sortedFormats() {
        if (!this._sortedFormats) {
            this._sortedFormats = Object.keys(this.config.mediaFormats)
                .map((key) => ({
                code: key,
                size: this.config.mediaFormats[key],
            }))
                .sort((a, b) => (a.size.width > b.size.width ? 1 : -1));
        }
        return this._sortedFormats;
    }
    /**
     * Creates the media formats in a reversed sorted order.
     */
    get reversedFormats() {
        if (!this._reversedFormats) {
            this._reversedFormats = this.sortedFormats.slice().reverse();
        }
        return this._reversedFormats;
    }
    /**
     * Resolves the right media for the given format. The fo
     */
    resolveMedia(media, format) {
        return media[this.resolveFormat(media, format)];
    }
    /**
     * Validates the format against the given mediaContainer. If there is no format available,
     * or if the mediaContainer doesn't contain a media for the given media, the most optimal
     * format is resolved. If even that is not possible, the first format is returned.
     */
    resolveFormat(mediaContainer, format) {
        if (format && mediaContainer[format]) {
            return format;
        }
        return (this.resolveBestFormat(mediaContainer) || Object.keys(mediaContainer)[0]);
    }
    /**
     * Returns the media format code with the best size.
     */
    resolveBestFormat(media) {
        var _a;
        return (_a = this.reversedFormats.find((format) => media.hasOwnProperty(format.code))) === null || _a === void 0 ? void 0 : _a.code;
    }
    /**
     * Returns a set of media for the available media formats. Additionally, the congiured media
     * format width is added to the srcset, so that browsers can select the appropriate media.
     */
    resolveSrcSet(media) {
        if (!media) {
            return undefined;
        }
        const srcset = this.sortedFormats.reduce((set, format) => {
            if (!!media[format.code]) {
                if (set) {
                    set += ', ';
                }
                set += `${this.resolveAbsoluteUrl(media[format.code].url)} ${format.size.width}w`;
            }
            return set;
        }, '');
        return srcset === '' ? undefined : srcset;
    }
    /**
     * Resolves the absolute URL for the given url. In most cases, this URL represents
     * the relative URL on the backend. In that case, we prefix the url with the baseUrl.
     */
    resolveAbsoluteUrl(url) {
        if (!url) {
            return null;
        }
        return url.startsWith('http') ? url : this.getBaseUrl() + url;
    }
    /**
     * The base URL is either driven by a specific `backend.media.baseUrl`, or by the
     * `backend.occ.baseUrl`.
     *
     * The `backend.media.baseUrl` can be used to load media from a different location.
     *
     * In Commerce Cloud, a differnt location could mean a different "aspect".
     */
    getBaseUrl() {
        return (this.config.backend.media.baseUrl ||
            this.config.backend.occ.baseUrl ||
            '');
    }
};
MediaService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [Config,] }] },
    { type: BreakpointService }
];
MediaService.ɵprov = i0.ɵɵdefineInjectable({ factory: function MediaService_Factory() { return new MediaService(i0.ɵɵinject(i1.Config), i0.ɵɵinject(i2.BreakpointService)); }, token: MediaService, providedIn: "root" });
MediaService = __decorate([
    Injectable({
        providedIn: 'root',
    }),
    __param(0, Inject(Config))
], MediaService);
export { MediaService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVkaWEuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BzcGFydGFjdXMvc3RvcmVmcm9udC8iLCJzb3VyY2VzIjpbInNoYXJlZC9jb21wb25lbnRzL21lZGlhL21lZGlhLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQW9CLE1BQU0saUJBQWlCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sK0NBQStDLENBQUM7Ozs7QUFLbEY7Ozs7Ozs7Ozs7O0dBV0c7QUFJSCxJQUFhLFlBQVksR0FBekIsTUFBYSxZQUFZO0lBUXZCLFlBQzRCLE1BQXdCO0lBQ2xEOzs7O09BSUc7SUFDTyxpQkFBb0M7UUFOcEIsV0FBTSxHQUFOLE1BQU0sQ0FBa0I7UUFNeEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtJQUM3QyxDQUFDO0lBRUo7OztPQUdHO0lBQ0gsUUFBUSxDQUNOLGNBQXNDLEVBQ3RDLE1BQWUsRUFDZixHQUFZO1FBRVosSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUNuQixPQUFPO1NBQ1I7UUFFRCxNQUFNLFNBQVMsR0FBVSxjQUFjLENBQUMsR0FBRztZQUN6QyxDQUFDLENBQUMsY0FBYztZQUNoQixDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxjQUFnQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRWhFLE9BQU87WUFDTCxHQUFHLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsYUFBVCxTQUFTLHVCQUFULFNBQVMsQ0FBRSxHQUFHLENBQUM7WUFDNUMsR0FBRyxFQUFFLEdBQUcsS0FBSSxTQUFTLGFBQVQsU0FBUyx1QkFBVCxTQUFTLENBQUUsT0FBTyxDQUFBO1lBQzlCLE1BQU0sRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQztTQUMzQyxDQUFDO0lBQ0os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QUFXO1FBQ3RDLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDUixPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsT0FBTyxHQUFHLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsR0FBRyxHQUFHLENBQUM7SUFDaEUsQ0FBQztJQUVEOzs7Ozs7O09BT0c7SUFDTyxVQUFVO1FBQ2xCLE9BQU8sQ0FDSixJQUFJLENBQUMsTUFBb0IsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLE9BQU87WUFDL0MsSUFBSSxDQUFDLE1BQW9CLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPO1lBQzlDLEVBQUUsQ0FDSCxDQUFDO0lBQ0osQ0FBQztDQUNGLENBQUE7OzRDQWpKSSxNQUFNLFNBQUMsTUFBTTtZQU1lLGlCQUFpQjs7O0FBZnJDLFlBQVk7SUFIeEIsVUFBVSxDQUFDO1FBQ1YsVUFBVSxFQUFFLE1BQU07S0FDbkIsQ0FBQztJQVVHLFdBQUEsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0dBVE4sWUFBWSxDQTBKeEI7U0ExSlksWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBDb25maWcsIEltYWdlLCBPY2NDb25maWcgfSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xyXG5pbXBvcnQgeyBCcmVha3BvaW50U2VydmljZSB9IGZyb20gJy4uLy4uLy4uL2xheW91dC9icmVha3BvaW50L2JyZWFrcG9pbnQuc2VydmljZSc7XHJcbmltcG9ydCB7IFN0b3JlZnJvbnRDb25maWcgfSBmcm9tICcuLi8uLi8uLi9zdG9yZWZyb250LWNvbmZpZyc7XHJcbmltcG9ydCB7IE1lZGlhQ29uZmlnIH0gZnJvbSAnLi9tZWRpYS5jb25maWcnO1xyXG5pbXBvcnQgeyBNZWRpYSwgTWVkaWFDb250YWluZXIsIE1lZGlhRm9ybWF0U2l6ZSB9IGZyb20gJy4vbWVkaWEubW9kZWwnO1xyXG5cclxuLyoqXHJcbiAqIFNlcnZpY2Ugd2hpY2ggZ2VuZXJhdGVzIG1lZGlhIFVSTHMuIEl0IGxldmVyYWdlIHRoZSBNZWRpYUNvbnRhaW5lciBhbmQgTWVkaWFGb3JtYXRzIHNvXHJcbiAqIHRoYXQgVVJMcyBhbmQgc2l6ZXMgYXJlIGdlbmVyYXRlZCBmb3IgdGhlIHNhbWUgbWVkaWEuIFRoaXMgaGVscHMgdG8gaW1wcm92ZSBwZXJmb3JtYW5jZVxyXG4gKiBhY3Jvc3MgZGlmZmVyZW5jZSBkZXZpY2VzIGFuZCBsYXlvdXRzLlxyXG4gKlxyXG4gKiBNZWRpYSBmb3JtYXRzIGFyZSBvcHRpb25hbCwgYnV0IGhpZ2hseSByZWNvbW1lbmRlZC4gVGhlIGZvcm1hdCB3aWxsIGhlbHAgdGhlIGJyb3dzZXIgdG9cclxuICogaWRlbnRpZnkgdGhlIHJpZ2h0IG1lZGlhIGZvciB0aGUgcmlnaHQgZXhwZXJpZW5jZS5cclxuICpcclxuICogVGhlIE1lZGlhU2VydmljZSB3aWxsIGdlbmVyYXRlIGFic29sdXRlIFVSTHMgaW4gY2FzZSByZWxhdGl2ZSBVUkxzIGFyZSBwcm92aWRlZCBmb3IgdGhlIE1lZGlhLlxyXG4gKiBUaGUgYmFzZVVybCBpcyByZWFkIGZyb20gdGhlIGBvY2NDb25maWcuYmFja2VuZC5tZWRpYS5iYXNlVXJsYCBvclxyXG4gKiBgb2NjQ29uZmlnLmJhY2tlbmQub2NjLmJhc2VVcmxgLlxyXG4gKi9cclxuQEluamVjdGFibGUoe1xyXG4gIHByb3ZpZGVkSW46ICdyb290JyxcclxufSlcclxuZXhwb3J0IGNsYXNzIE1lZGlhU2VydmljZSB7XHJcbiAgLyoqXHJcbiAgICogVGhlIG1lZGlhIGZvcm1hdHMgc29ydGVkIGJ5IHNpemUuIFRoZSBtZWRpYSBmb3JtYXQgcmVwcmVzZW50aW5nIHRoZSBzbWFsbGVzdFxyXG4gICAqIHNpemUgaXMgc29ydGVkIG9uIHRvcC5cclxuICAgKi9cclxuICBwcml2YXRlIF9zb3J0ZWRGb3JtYXRzOiB7IGNvZGU6IHN0cmluZzsgc2l6ZTogTWVkaWFGb3JtYXRTaXplIH1bXTtcclxuICBwcml2YXRlIF9yZXZlcnNlZEZvcm1hdHM6IHsgY29kZTogc3RyaW5nOyBzaXplOiBNZWRpYUZvcm1hdFNpemUgfVtdO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIEBJbmplY3QoQ29uZmlnKSBwcm90ZWN0ZWQgY29uZmlnOiBTdG9yZWZyb250Q29uZmlnLFxyXG4gICAgLyoqXHJcbiAgICAgKiBUaGUgQnJlYWtwb2ludFNlcnZpY2UgaXMgbm8gbG9uZ2VyIHVzZWQgaW4gdmVyc2lvbiAyLjAgYXMgdGhlIGRpZmZlcmVudCBzaXplIGZvcm1hdHMgYXJlXHJcbiAgICAgKiBkcml2ZW4gYnkgY29uZmlndXJhdGlvbiBvbmx5LiBUaGVyZSdzIGhvd2V2ZXIgYSBjaGFuZ2UgdGhhdCB0aGlzIHNlcnZpY2Ugd2lsbCBwbGF5IGEgcm9sZVxyXG4gICAgICogaW4gdGhlIG5lYXIgZnV0dXJlLCB3aGljaCBpcyB3aHkgd2Uga2VlcCB0aGUgY29uc3RydWN0b3IgYXMtaXMuXHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBicmVha3BvaW50U2VydmljZTogQnJlYWtwb2ludFNlcnZpY2VcclxuICApIHt9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgYSBgTWVkaWFgIG9iamVjdCB3aXRoIHRoZSBtYWluIG1lZGlhIChgc3JjYCkgYW5kIHZhcmlvdXMgbWVkaWEgKGBzcmNgKVxyXG4gICAqIGZvciBzcGVjaWZpYyBmb3JtYXRzLlxyXG4gICAqL1xyXG4gIGdldE1lZGlhKFxyXG4gICAgbWVkaWFDb250YWluZXI6IE1lZGlhQ29udGFpbmVyIHwgSW1hZ2UsXHJcbiAgICBmb3JtYXQ/OiBzdHJpbmcsXHJcbiAgICBhbHQ/OiBzdHJpbmdcclxuICApOiBNZWRpYSB7XHJcbiAgICBpZiAoIW1lZGlhQ29udGFpbmVyKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBtYWluTWVkaWE6IEltYWdlID0gbWVkaWFDb250YWluZXIudXJsXHJcbiAgICAgID8gbWVkaWFDb250YWluZXJcclxuICAgICAgOiB0aGlzLnJlc29sdmVNZWRpYShtZWRpYUNvbnRhaW5lciBhcyBNZWRpYUNvbnRhaW5lciwgZm9ybWF0KTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzcmM6IHRoaXMucmVzb2x2ZUFic29sdXRlVXJsKG1haW5NZWRpYT8udXJsKSxcclxuICAgICAgYWx0OiBhbHQgfHwgbWFpbk1lZGlhPy5hbHRUZXh0LFxyXG4gICAgICBzcmNzZXQ6IHRoaXMucmVzb2x2ZVNyY1NldChtZWRpYUNvbnRhaW5lciksXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JlYXRlcyB0aGUgbWVkaWEgZm9ybWF0cyBpbiBhIGxvZ2ljYWwgc29ydGVkIG9yZGVyLiBUaGUgbWFwIGNvbnRhaW5zIHRoZVxyXG4gICAqIGZvcm1hdCBrZXkgYW5kIHRoZSBmb3JtYXQgc2l6ZSBpbmZvcm1hdGlvbi4gV2UgZG8gdGhpcyBvbmx5IG9uY2UgZm9yIHBlcmZvcm1hbmNlXHJcbiAgICogYmVuZWZpdHMuXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGdldCBzb3J0ZWRGb3JtYXRzKCk6IHsgY29kZTogc3RyaW5nOyBzaXplOiBNZWRpYUZvcm1hdFNpemUgfVtdIHtcclxuICAgIGlmICghdGhpcy5fc29ydGVkRm9ybWF0cykge1xyXG4gICAgICB0aGlzLl9zb3J0ZWRGb3JtYXRzID0gT2JqZWN0LmtleXMoXHJcbiAgICAgICAgKHRoaXMuY29uZmlnIGFzIE1lZGlhQ29uZmlnKS5tZWRpYUZvcm1hdHNcclxuICAgICAgKVxyXG4gICAgICAgIC5tYXAoKGtleSkgPT4gKHtcclxuICAgICAgICAgIGNvZGU6IGtleSxcclxuICAgICAgICAgIHNpemU6ICh0aGlzLmNvbmZpZyBhcyBNZWRpYUNvbmZpZykubWVkaWFGb3JtYXRzW2tleV0sXHJcbiAgICAgICAgfSkpXHJcbiAgICAgICAgLnNvcnQoKGEsIGIpID0+IChhLnNpemUud2lkdGggPiBiLnNpemUud2lkdGggPyAxIDogLTEpKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLl9zb3J0ZWRGb3JtYXRzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JlYXRlcyB0aGUgbWVkaWEgZm9ybWF0cyBpbiBhIHJldmVyc2VkIHNvcnRlZCBvcmRlci5cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0IHJldmVyc2VkRm9ybWF0cygpOiB7IGNvZGU6IHN0cmluZzsgc2l6ZTogTWVkaWFGb3JtYXRTaXplIH1bXSB7XHJcbiAgICBpZiAoIXRoaXMuX3JldmVyc2VkRm9ybWF0cykge1xyXG4gICAgICB0aGlzLl9yZXZlcnNlZEZvcm1hdHMgPSB0aGlzLnNvcnRlZEZvcm1hdHMuc2xpY2UoKS5yZXZlcnNlKCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5fcmV2ZXJzZWRGb3JtYXRzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzb2x2ZXMgdGhlIHJpZ2h0IG1lZGlhIGZvciB0aGUgZ2l2ZW4gZm9ybWF0LiBUaGUgZm9cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgcmVzb2x2ZU1lZGlhKG1lZGlhOiBNZWRpYUNvbnRhaW5lciwgZm9ybWF0Pzogc3RyaW5nKTogSW1hZ2Uge1xyXG4gICAgcmV0dXJuIG1lZGlhW3RoaXMucmVzb2x2ZUZvcm1hdChtZWRpYSwgZm9ybWF0KV07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBWYWxpZGF0ZXMgdGhlIGZvcm1hdCBhZ2FpbnN0IHRoZSBnaXZlbiBtZWRpYUNvbnRhaW5lci4gSWYgdGhlcmUgaXMgbm8gZm9ybWF0IGF2YWlsYWJsZSxcclxuICAgKiBvciBpZiB0aGUgbWVkaWFDb250YWluZXIgZG9lc24ndCBjb250YWluIGEgbWVkaWEgZm9yIHRoZSBnaXZlbiBtZWRpYSwgdGhlIG1vc3Qgb3B0aW1hbFxyXG4gICAqIGZvcm1hdCBpcyByZXNvbHZlZC4gSWYgZXZlbiB0aGF0IGlzIG5vdCBwb3NzaWJsZSwgdGhlIGZpcnN0IGZvcm1hdCBpcyByZXR1cm5lZC5cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgcmVzb2x2ZUZvcm1hdChcclxuICAgIG1lZGlhQ29udGFpbmVyOiBNZWRpYUNvbnRhaW5lcixcclxuICAgIGZvcm1hdD86IHN0cmluZ1xyXG4gICk6IHN0cmluZyB7XHJcbiAgICBpZiAoZm9ybWF0ICYmIG1lZGlhQ29udGFpbmVyW2Zvcm1hdF0pIHtcclxuICAgICAgcmV0dXJuIGZvcm1hdDtcclxuICAgIH1cclxuICAgIHJldHVybiAoXHJcbiAgICAgIHRoaXMucmVzb2x2ZUJlc3RGb3JtYXQobWVkaWFDb250YWluZXIpIHx8IE9iamVjdC5rZXlzKG1lZGlhQ29udGFpbmVyKVswXVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgdGhlIG1lZGlhIGZvcm1hdCBjb2RlIHdpdGggdGhlIGJlc3Qgc2l6ZS5cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgcmVzb2x2ZUJlc3RGb3JtYXQobWVkaWE6IE1lZGlhQ29udGFpbmVyIHwgSW1hZ2UpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHRoaXMucmV2ZXJzZWRGb3JtYXRzLmZpbmQoKGZvcm1hdCkgPT5cclxuICAgICAgbWVkaWEuaGFzT3duUHJvcGVydHkoZm9ybWF0LmNvZGUpXHJcbiAgICApPy5jb2RlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJucyBhIHNldCBvZiBtZWRpYSBmb3IgdGhlIGF2YWlsYWJsZSBtZWRpYSBmb3JtYXRzLiBBZGRpdGlvbmFsbHksIHRoZSBjb25naXVyZWQgbWVkaWFcclxuICAgKiBmb3JtYXQgd2lkdGggaXMgYWRkZWQgdG8gdGhlIHNyY3NldCwgc28gdGhhdCBicm93c2VycyBjYW4gc2VsZWN0IHRoZSBhcHByb3ByaWF0ZSBtZWRpYS5cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgcmVzb2x2ZVNyY1NldChtZWRpYTogTWVkaWFDb250YWluZXIgfCBJbWFnZSk6IHN0cmluZyB7XHJcbiAgICBpZiAoIW1lZGlhKSB7XHJcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc3Jjc2V0ID0gdGhpcy5zb3J0ZWRGb3JtYXRzLnJlZHVjZSgoc2V0LCBmb3JtYXQpID0+IHtcclxuICAgICAgaWYgKCEhbWVkaWFbZm9ybWF0LmNvZGVdKSB7XHJcbiAgICAgICAgaWYgKHNldCkge1xyXG4gICAgICAgICAgc2V0ICs9ICcsICc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHNldCArPSBgJHt0aGlzLnJlc29sdmVBYnNvbHV0ZVVybChtZWRpYVtmb3JtYXQuY29kZV0udXJsKX0gJHtcclxuICAgICAgICAgIGZvcm1hdC5zaXplLndpZHRoXHJcbiAgICAgICAgfXdgO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBzZXQ7XHJcbiAgICB9LCAnJyk7XHJcblxyXG4gICAgcmV0dXJuIHNyY3NldCA9PT0gJycgPyB1bmRlZmluZWQgOiBzcmNzZXQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXNvbHZlcyB0aGUgYWJzb2x1dGUgVVJMIGZvciB0aGUgZ2l2ZW4gdXJsLiBJbiBtb3N0IGNhc2VzLCB0aGlzIFVSTCByZXByZXNlbnRzXHJcbiAgICogdGhlIHJlbGF0aXZlIFVSTCBvbiB0aGUgYmFja2VuZC4gSW4gdGhhdCBjYXNlLCB3ZSBwcmVmaXggdGhlIHVybCB3aXRoIHRoZSBiYXNlVXJsLlxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCByZXNvbHZlQWJzb2x1dGVVcmwodXJsOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgaWYgKCF1cmwpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdXJsLnN0YXJ0c1dpdGgoJ2h0dHAnKSA/IHVybCA6IHRoaXMuZ2V0QmFzZVVybCgpICsgdXJsO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVGhlIGJhc2UgVVJMIGlzIGVpdGhlciBkcml2ZW4gYnkgYSBzcGVjaWZpYyBgYmFja2VuZC5tZWRpYS5iYXNlVXJsYCwgb3IgYnkgdGhlXHJcbiAgICogYGJhY2tlbmQub2NjLmJhc2VVcmxgLlxyXG4gICAqXHJcbiAgICogVGhlIGBiYWNrZW5kLm1lZGlhLmJhc2VVcmxgIGNhbiBiZSB1c2VkIHRvIGxvYWQgbWVkaWEgZnJvbSBhIGRpZmZlcmVudCBsb2NhdGlvbi5cclxuICAgKlxyXG4gICAqIEluIENvbW1lcmNlIENsb3VkLCBhIGRpZmZlcm50IGxvY2F0aW9uIGNvdWxkIG1lYW4gYSBkaWZmZXJlbnQgXCJhc3BlY3RcIi5cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0QmFzZVVybCgpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIChcclxuICAgICAgKHRoaXMuY29uZmlnIGFzIE9jY0NvbmZpZykuYmFja2VuZC5tZWRpYS5iYXNlVXJsIHx8XHJcbiAgICAgICh0aGlzLmNvbmZpZyBhcyBPY2NDb25maWcpLmJhY2tlbmQub2NjLmJhc2VVcmwgfHxcclxuICAgICAgJydcclxuICAgICk7XHJcbiAgfVxyXG59XHJcbiJdfQ==